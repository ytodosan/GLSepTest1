(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[4425],{43272:(Pe,F,i)=>{i.d(F,{A:()=>V});var l=i(18587),n=i(49973),f=i(58504),M=i(74709),H=i(43785),p=i(62278),S=i.n(p),_=i(36486),N=i.n(_);class V{constructor(d,c,u){this.queryExecutor=d,this._translateService=c,this.entityConverter=u,this.absentDataErrorKey="BaseSection.AbsentDataErrorMessage",this.primaryColumnName="Id"}_convertToErrorInfo(d){return{errorCode:null,message:d.message,stackTrace:d.stack}}_addColumnsToEsq(d){this.entityConverter.getEntityColumns({}).forEach(u=>{d.addSchemaColumn(u.path)})}_createDeleteQuery(){return new l.x(this.entitySchemaName)}getBaseErrorResponse(d){return(0,p.of)({success:!1,errorInfo:this._convertToErrorInfo(d),result:null})}handleResponse(d){return d.pipe((0,_.map)(()=>({success:!0,errorInfo:null,result:[]})),(0,_.catchError)(c=>(0,p.of)({success:!1,errorInfo:this._convertToErrorInfo(c),result:[]})))}getItemByIdEsq(d){const c=new n.s(this.entitySchemaName);return this._addColumnsToEsq(c),c.filters.addSchemaColumnFilterWithParameter(f.H.Equal,this.primaryColumnName,d),c}createGetAllItemsEsq(){const d=new n.s(this.entitySchemaName);return this._addColumnsToEsq(d),d}getUpdateQuery(d){const c=new M.N(this.entitySchemaName);return this.entityConverter.getEntityColumns(d).forEach(y=>{this.primaryColumnName===y.path?c.filters.addSchemaColumnFilterWithParameter(f.H.Equal,this.primaryColumnName,y.value):c.addColumn(y.path,y.value,y.type)}),c}getInsertQuery(d){const c=new H.L(this.entitySchemaName);return this.entityConverter.getEntityColumns(d).forEach(y=>{this.primaryColumnName===y.path&&!y.value||c.addColumn(y.path,y.value,y.type)}),c}getDeleteQuery(d){return this.getDeleteQueryWithPrimaryColumnFilter(d.id)}getDeleteQueryWithPrimaryColumnFilter(d){const c=this._createDeleteQuery();return c.filters.addSchemaColumnFilterWithParameter(f.H.Equal,this.primaryColumnName,d),c}loadAdditionalInfo(d){return(0,p.of)(d)}getItems(){const d=this.createGetAllItemsEsq();return this.queryExecutor.executeSelectQuery(d).pipe((0,_.mergeMap)(c=>this.loadAdditionalInfo(c)),(0,_.map)(c=>({success:!0,errorInfo:null,result:c.map(u=>this.entityConverter.getEntity(u))})),(0,_.catchError)(c=>this.getBaseErrorResponse(c)))}getItem(d){const c=this.getItemByIdEsq(d);return this.queryExecutor.executeSelectQuery(c).pipe((0,_.tap)(u=>{if(!(u&&u[0])){const y=this._translateService.instant(this.absentDataErrorKey);throw new Error(y)}}),(0,_.mergeMap)(u=>this.loadAdditionalInfo(u)),(0,_.map)(u=>({success:!0,errorInfo:null,result:[this.entityConverter.getEntity(u[0])]})),(0,_.catchError)(u=>this.getBaseErrorResponse(u)))}insertItem(d){const c=this.getInsertQuery(d),u=this.queryExecutor.executeInsertQuery(c);return this.handleResponse(u)}updateItem(d){const c=this.getUpdateQuery(d),u=this.queryExecutor.executeUpdateQuery(c);return this.handleResponse(u)}deleteItem(d){const c=this.getDeleteQuery(d),u=this.queryExecutor.executeDeleteQuery(c);return this.handleResponse(u)}deleteById(d){const c=this.getDeleteQueryWithPrimaryColumnFilter(d),u=this.queryExecutor.executeDeleteQuery(c);return this.handleResponse(u)}}},84425:(Pe,F,i)=>{i.r(F),i.d(F,{AdditionalParamsChangeHandler:()=>w,AdfsAdditionalParamsChangeHandler:()=>ae,AdfsSaveValidationHandler:()=>X,AdfsTenantValidator:()=>ie,AdfsUrlChangeHandler:()=>d,IdpListChangeHandler:()=>re,IdpNameChangeHandler:()=>W,IdpSaveValidationHandler:()=>z,IsJsonValidator:()=>oe,LoadSamlMetadataHandler:()=>b,LoadSamlMetadataRequest:()=>V,LoadSpDataHandler:()=>J,OpenSamlDataGridRowHandler:()=>K,OpenSsoSettingsPageHandler:()=>se,SamlDataGridRowDoubleClickHandler:()=>$,SamlIdpCertificateService:()=>E,SamlProviderSaveValidationHandler:()=>Z,SaveSamlIdpCertificatesHandler:()=>ee,SaveSpDataHandler:()=>B,SaveSpDataRequest:()=>ue,SpDataChangeHandler:()=>j,SsoProviderSaveValidationHandler:()=>Y,SsoProviderService:()=>I,SsoServiceProvider:()=>be,SsoServiceProviderEntityConverter:()=>D,SsoServiceProviderService:()=>U,SsoSettingsModule:()=>le,SsoSettingsV2DataChangeHandler:()=>G,StringUrlValidator:()=>ne,TestSsoHandler:()=>Q,TestSsoRequest:()=>me,UploadSamlIdpCertificateHandler:()=>q,UploadSamlIdpCertificateRequest:()=>pe,UploadSamlIdpMetadataHandler:()=>te,UploadSamlIdpMetadataRequest:()=>Se});var l=i(73308),n=i(5960),f=i(63721),M=i(81517),H=i(2828),p=i(41287),S=i(844),_=i(37341),N=i(36486);let V=class extends M.S{};V=(0,n.__decorate)([(0,H.$)({type:"crt.LoadSamlMetadataRequest"})],V);let b=class extends p.l{constructor(e){super(),this.httpClient=e,this._samlMetadataUrl="/rest/SsoActionsService/GetSamlMetadata"}handle(e){var t=this;return(0,l.A)(function*(){return t.httpClient.get(t._samlMetadataUrl,{responseType:"text"}).pipe((0,N.map)(a=>{const r="creatio_saml_metadata.xml",s=new Blob([a],{type:"application/xml"});_.saveAs(s,r,{autoBom:!1})})).subscribe(),t.next?.handle(e)})()}};b=(0,n.__decorate)([(0,S.l)({type:"crt.LoadSamlMetadataHandler",requestType:"crt.LoadSamlMetadataRequest",scopes:["CustomIdpSettingsForm","SsoSamlBase_FormPage"]}),(0,n.__metadata)("design:paramtypes",[f.HttpClient])],b);let d=class extends p.l{_tryUpdateSamlEndpoints(e){var t=this;return(0,l.A)(function*(){if(e.attributeName!=="AdfsUrl")return;const a=yield e.$context.AdfsUrl;e.oldValue!==a&&t._setSamlEndpoints(e,a)})()}_tryUpdateAdfsUrl(e){return(0,l.A)(function*(){if(e.attributeName!=="PartnerIdentityName")return;const t=yield e.$context.AdfsUrl,a=yield e.$context.PartnerIdentityName;!t&&a&&(e.$context.AdfsUrl=new URL(a).host)})()}_setSamlEndpoints(e,t){e.$context.PartnerIdentityName=`http://${t}/adfs/services/trust`;const a=`https://${t}/adfs/ls`;e.$context.SingleLogoutServiceUrl=a,e.$context.SingleSignOnServiceUrl=a}handle(e){var t=this;return(0,l.A)(function*(){return yield t._tryUpdateSamlEndpoints(e),yield t._tryUpdateAdfsUrl(e),t.next?.handle(e)})()}};d=(0,n.__decorate)([(0,S.l)({type:"crt.AdfsUrlChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["AdfsSettingsForm","SsoSamlAdfs_FormPage"]})],d);var c=i(40968),u=i(22592),y=i(99298),T=i(79772),xe=i(43272),g=i(59131),de=i(65751),P=i(86464),x=i(55363),C=i(28399);class D{getEntity(e){const t=e;return{id:t.Id,ssoIdentityProvider:(0,C.isEmpty)(t.SsoIdentityProvider)?null:t.SsoIdentityProvider,useJit:t.UseJit,sspUseJit:t.SspUseJit,useSlo:t.UseSlo,name:t.Name,assertionConsumerServiceUrl:t.AssertionConsumerServiceUrl,singleLogoutServiceUrl:t.SingleLogoutServiceUrl}}getEntityColumns(e){return[new x.a("Id",e.id,P.r.Guid),new x.a("SsoIdentityProvider",e.ssoIdentityProvider,P.r.Lookup),new x.a("UseJit",e.useJit,P.r.Boolean),new x.a("SspUseJit",e.sspUseJit,P.r.Boolean),new x.a("UseSlo",e.useSlo,P.r.Boolean),new x.a("Name",e.name,P.r.Text),new x.a("AssertionConsumerServiceUrl",e.assertionConsumerServiceUrl,P.r.Text),new x.a("SingleLogoutServiceUrl",e.singleLogoutServiceUrl,P.r.Text)]}static{this.\u0275fac=function(t){return new(t||D)}}static{this.\u0275prov=g.\u0275\u0275defineInjectable({token:D,factory:D.\u0275fac,providedIn:"any"})}}class U extends xe.A{constructor(e,t,a){super(e,t,a),this.entitySchemaName="SsoServiceProvider"}static{this.\u0275fac=function(t){return new(t||U)(g.\u0275\u0275inject(de.w),g.\u0275\u0275inject(T.TranslateService),g.\u0275\u0275inject(D))}}static{this.\u0275prov=g.\u0275\u0275defineInjectable({token:U,factory:U.\u0275fac,providedIn:"any"})}}let J=class extends p.l{constructor(e,t){super(),this.ssoServiceProviderService=e,this._maskService=t}_setServiceProviderColumns(e,t){e.setValue({SpIdAttribute:t.id},{silent:!0}),e.setValue({SpIdentityProviderAttribute:t.ssoIdentityProvider},{silent:!0}),e.setValue({SpUseJitAttribute:t.useJit},{silent:!0}),e.setValue({SpSspUseJitAttribute:t.sspUseJit},{silent:!0}),e.setValue({SpUseSloAttribute:t.useSlo},{silent:!0}),e.setValue({JitMapingVisible:t.useJit||t.sspUseJit},{silent:!0})}handle(e){var t=this;return(0,l.A)(function*(){const a=e.$context,r="SP_DATA_LOADING";return yield t._maskService.showMask(r,a),t.ssoServiceProviderService.getItems().subscribe(s=>{if(t._maskService.hideMask(r,a),s.success&&s.result.length){const[o]=s.result;t._setServiceProviderColumns(a,o)}return t.next?.handle(e)})})()}};J=(0,n.__decorate)([(0,S.l)({type:"crt.LoadSpDataHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["SsoSettings","SsoSettingsV2"]}),(0,n.__param)(1,(0,c.j)(y.V)),(0,n.__metadata)("design:paramtypes",[U,u.s])],J);var ce=i(6530),O=i(7471),ge=i(90983),A=i(62278);let ue=class extends M.S{};ue=(0,n.__decorate)([(0,H.$)({type:"crt.SaveSpDataRequest"})],ue);let B=class extends p.l{constructor(e,t,a){super(),this.ssoServiceProviderService=e,this._dialogService=t,this._maskService=a,this._ssoLoginEndpoint="/ServiceModel/AuthService.svc/SsoLogin",this._ssoLogoutEndpoint="/ServiceModel/AuthService.svc/SsoLogout"}_getSiteOriginUrl(){return(0,ge.cI)().replace("/0/","").replace(new RegExp("/$"),"")}_onSavedSpData(e,t){var a=this;return(0,l.A)(function*(){return yield a._maskService.hideMask("SAVE_SP_DATA",t.$context),e?.success?(t.$context.IsSpChanged=!1,t.$context.formApiModel.markAsPristine()):e?.success===!1&&e?.errorInfo&&a._dialogService.openInfoDialog(e?.errorInfo.message),a.next?.handle(t)})()}handle(e){var t=this;return(0,l.A)(function*(){const a=e.$context,r=t._getSiteOriginUrl(),s=yield a.SpIdentityProviderAttribute,o={id:yield a.SpIdAttribute,ssoIdentityProvider:s||null,useJit:yield a.SpUseJitAttribute,sspUseJit:yield a.SpSspUseJitAttribute,useSlo:yield a.SpUseSloAttribute,name:r,assertionConsumerServiceUrl:r+t._ssoLoginEndpoint,singleLogoutServiceUrl:r+t._ssoLogoutEndpoint};return yield t._maskService.showMask("SAVE_SP_DATA",e.$context),t.ssoServiceProviderService.getItems().pipe((0,A.switchMap)(h=>{if(h.success&&h.result.length){const[v]=h.result;return v.useJit=o.useJit,v.sspUseJit=o.sspUseJit,v.useSlo=o.useSlo,v.ssoIdentityProvider=o.ssoIdentityProvider,t.ssoServiceProviderService.updateItem(v)}else return o.id=(0,ce.qv)(),a.SpIdAttribute=o.id,t.ssoServiceProviderService.insertItem(o)})).subscribe(h=>t._onSavedSpData(h,e))})()}};B=(0,n.__decorate)([(0,S.l)({type:"crt.SaveSpDataHandler",requestType:"crt.SaveSpDataRequest",scopes:["SsoSettings","SsoSettingsV2"]}),(0,n.__param)(2,(0,c.j)(y.V)),(0,n.__metadata)("design:paramtypes",[U,O.o,u.s])],B);let j=class extends p.l{constructor(){super(...arguments),this._listeningColumns=["SpUseJitAttribute","SpIdentityProviderAttribute"]}handle(e){var t=this;return(0,l.A)(function*(){const a=e.$context;!e.silent&&t._listeningColumns.includes(e.attributeName)&&(a.IsSpChanged=!0);const r=yield a.IsSpChanged,s=yield a.SpIdentityProviderAttribute;return a.IsTestSsoVisible=!r&&!(0,C.isEmpty)(s),t.next?.handle(e)})()}};j=(0,n.__decorate)([(0,S.l)({type:"crt.SpDataChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["SsoSettings"]})],j);let G=class extends p.l{constructor(){super(...arguments),this._listeningColumns=["SpUseJitAttribute","SpSspUseJitAttribute","SpUseSloAttribute"]}_setJitMappingVisible(e){return(0,l.A)(function*(){const t=yield e.SpSspUseJitAttribute,a=yield e.SpUseJitAttribute,r=yield e.JitMapingVisible,s=!!t||!!a;r!==s&&(e.JitMapingVisible=s)})()}handle(e){var t=this;return(0,l.A)(function*(){const a=e.$context;return!e.silent&&t._listeningColumns.includes(e.attributeName)&&(a.IsSpChanged=!0,yield t.handlerChain.process({type:"crt.SaveSpDataRequest",$context:a,scopes:e.scopes}),yield t._setJitMappingVisible(e.$context)),t.next?.handle(e)})()}};G=(0,n.__decorate)([(0,S.l)({type:"crt.SsoSettingsV2DataChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["SsoSettingsV2"]})],G);let W=class extends p.l{_tryUpdateDisplayName(e){return(0,l.A)(function*(){if(yield e.$context.DisplayName)return;const a=yield e.$context.Type,r=yield e.$context.PartnerIdentityName;if(a&&r){const s=new URL(r).host;e.$context.DisplayName=`${s} (${a.displayValue})`}})()}handle(e){var t=this;return(0,l.A)(function*(){return yield t._tryUpdateDisplayName(e),yield t.next?.handle(e)})()}};W=(0,n.__decorate)([(0,S.l)({type:"crt.IdpNameChangeHandler",requestType:"crt.SaveRecordRequest",scopes:["CustomIdpSettingsForm","SsoSamlBase_FormPage","SsoOpenId_FormPage","SsoOpenIdCognito_FormPage"]})],W);var Ue=i(59969);let me=class extends M.S{};me=(0,n.__decorate)([(0,H.$)({type:"crt.TestSsoRequest"})],me);let Q=class extends p.l{constructor(e,t){super(),this._window=e,this._maskService=t,this._startSsoEndpoint="/ServiceModel/AuthService.svc/StartSsoLogin",this._returnUrlHashParameterName="ReturnUrlHash",this._partnerIdpParameterName="partnerIdp"}_openUrl(e){this._window.open(e.href,"self")}_getSsoLoginUrl(e){const a=this._window.location.hash.replace("#",""),r=(0,ge.cI)().replace("/0/","").replace(new RegExp("/$"),""),s=new URL(r+this._startSsoEndpoint);return s.searchParams.append(this._partnerIdpParameterName,e),a&&s.searchParams.append(this._returnUrlHashParameterName,a),s}_startSsoLogin(e){const t=this._getSsoLoginUrl(e);this._openUrl(t)}handle(e){var t=this;return(0,l.A)(function*(){const a=yield e.$context.SpIdentityProviderAttribute;let r=a&&a.value;if(r||(r=yield e.$context.Id),r){const s="TEST_SSO_HANDLER_TASK";t._maskService.showMask(s,e.$context),t._startSsoLogin(r),t._maskService.hideMask(s,e.$context)}return t.next?.handle(e)})()}};Q=(0,n.__decorate)([(0,S.l)({type:"crt.TestSsoHandler",requestType:"crt.TestSsoRequest",scopes:["SsoSettings","SsoSamlBase_FormPage"]}),(0,n.__param)(0,(0,c.j)(Ue.ZP)),(0,n.__param)(1,(0,c.j)(y.V)),(0,n.__metadata)("design:paramtypes",[Window,u.s])],Q);let $=class extends p.l{_getEntitySchemaName(e){const t=this._getDataSourceName(e);return e.$context.dataSchemas[t]?.dataSourceConfig?.config?.entitySchemaName}_getDataSourceName(e){return e.$context.getBoundDataSourceName(e.itemsAttributeName)||Object.keys(e.$context.dataSchemas||{})[0]}handle(e){var t=this;return(0,l.A)(function*(){const a=t._getEntitySchemaName(e);if(a==="SAMLFieldNameConverter"){const r={type:"crt.7XRequest",action:"OpenLookupSource",$context:e.$context,payload:{entitySchemaName:a}};return t.handlerChain.process(r)}else return t.next?.handle(e)})()}};$=(0,n.__decorate)([(0,S.l)({type:"crt.SamlDataGridRowDoubleClickHandler",requestType:"crt.DataGridRowDoubleClickRequest",scopes:["SsoSettings","SsoSettingsV2"]})],$);let K=class L extends ${handle(e){var t=()=>super.handle,a=this;return(0,l.A)(function*(){return e.itemsAttributeName==="DataGrid_SamlAttributes"?t().call(a,e):a.next?.handle(e)})()}static{this.\u0275fac=(()=>{let e;return function(a){return(e||(e=g.\u0275\u0275getInheritedFactory(L)))(a||L)}})()}static{this.\u0275prov=g.\u0275\u0275defineInjectable({token:L,factory:L.\u0275fac,providedIn:"any"})}};K=(0,n.__decorate)([(0,S.l)({type:"crt.OpenSamlDataGridRowHandler",requestType:"crt.UpdateRecordRequest",scopes:["SsoSettings","SsoSettingsV2"]})],K);var Ee=i(49973),Me=i(38772),k=i(58504);class I{constructor(e){this.queryExecutor=e}isUniqueIdpName(e,t,a,r){const s=new Ee.s(a);return s.addAggregationFunctionColumn("Id",Me.C.Count,"Count"),s.filters.addSchemaColumnFilterWithParameter(k.H.Equal,r,e),s.filters.addSchemaColumnFilterWithParameter(k.H.Not_equal,"Id",t),this.queryExecutor.executeSelectQuery(s).pipe((0,N.map)(o=>{if(o&&o.length){const[h]=o;return h.Count===0}return!0}))}static{this.\u0275fac=function(t){return new(t||I)(g.\u0275\u0275inject(de.w))}}static{this.\u0275prov=g.\u0275\u0275defineInjectable({token:I,factory:I.\u0275fac,providedIn:"any"})}}let z=class extends p.l{constructor(e,t,a){super(),this._dialogService=e,this._service=t,this._translateService=a,this._duplicateErrorMessageCode="SsoSettings.SsoIdentityProvider.DuplicationError"}_showErrorMsg(){const e=this._translateService.instant(this._duplicateErrorMessageCode);this._dialogService.openInfoDialog(e)}handle(e){var t=this;return(0,l.A)(function*(){const a=e.$context,r=yield a.PartnerIdentityName,s=yield a.Id;return(yield(0,A.lastValueFrom)(t._service.isUniqueIdpName(r,s,"SsoIdentityProvider","Name")))?yield t.next?.handle(e):(t._showErrorMsg(),!1)})()}};z=(0,n.__decorate)([(0,S.l)({type:"crt.IdpSaveValidationHandler",requestType:"crt.SaveRecordRequest",scopes:["CustomIdpSettingsForm"]}),(0,n.__metadata)("design:paramtypes",[O.o,I,T.TranslateService])],z);let X=class extends p.l{handle(e){var t=this;return(0,l.A)(function*(){const a=e.$context;yield a.validate();const r=yield a.getControl("AdfsUrl")?.formControl;if(!(r&&!r.valid))return t.next?.handle(e)})()}};X=(0,n.__decorate)([(0,S.l)({type:"crt.AdfsSaveValidationHandler",requestType:"crt.SaveRecordRequest",scopes:["AdfsSettingsForm","SsoSamlAdfs_FormPage"]})],X);let Z=class extends p.l{constructor(e,t,a){super(),this._dialogService=e,this._service=t,this._translateService=a,this._duplicateErrorMessageCode="SsoSettings.SsoIdentityProvider.DuplicationError",this._signingSettingsErrorMessageCode="SsoSettings.SsoIdentityProvider.SigningSettingsError"}_showErrorMsg(e){this._dialogService.openInfoDialog(this._translateService.instant(e))}handle(e){var t=this;return(0,l.A)(function*(){const a=e.$context,r=yield a.PartnerIdentityName,s=yield a.Id;if(!(yield(0,A.lastValueFrom)(t._service.isUniqueIdpName(r,s,"SsoSamlSettings","EntityID"))))return t._showErrorMsg(t._duplicateErrorMessageCode),!1;const h=yield a.WantAssertionSigned,v=yield a.PartnerCertificateThumbprint;return h&&(0,C.isEmpty)(v)?(t._showErrorMsg(t._signingSettingsErrorMessageCode),!1):yield t.next?.handle(e)})()}};Z=(0,n.__decorate)([(0,S.l)({type:"crt.SamlProviderSaveValidationHandler",requestType:"crt.SaveRecordRequest",scopes:["SsoSamlBase_FormPage"]}),(0,n.__metadata)("design:paramtypes",[O.o,I,T.TranslateService])],Z);let Y=class extends p.l{constructor(e,t,a){super(),this._dialogService=e,this._service=t,this._translateService=a,this._duplicateErrorMessageCode="SsoSettings.SsoIdentityProvider.DuplicationError"}_showErrorMsg(){const e=this._translateService.instant(this._duplicateErrorMessageCode);this._dialogService.openInfoDialog(e)}handle(e){var t=this;return(0,l.A)(function*(){const a=e.$context,r=yield a.Code,s=yield a.Id;return(yield(0,A.lastValueFrom)(t._service.isUniqueIdpName(r,s,"SsoProvider","Code")))?yield t.next?.handle(e):(t._showErrorMsg(),!1)})()}};Y=(0,n.__decorate)([(0,S.l)({type:"crt.SsoProviderSaveValidationHandler",requestType:"crt.SaveRecordRequest",scopes:["SsoSamlBase_FormPage","SsoOpenIdBase_FormPage"]}),(0,n.__metadata)("design:paramtypes",[O.o,I,T.TranslateService])],Y);let w=class extends p.l{constructor(){super(...arguments),this._wantAssertionSignedAttributeName="WantAssertionSigned",this._wantAssertionEncryptedAttributeName="WantAssertionEncrypted",this._isSecureAttributeName="IsSecure",this.additionalParamsAttributeName="AdditionalParams"}_tryUpdateIsSecureAttribute(e){var t=this;return(0,l.A)(function*(){const a=yield e.$context[t._wantAssertionSignedAttributeName],r=yield e.$context[t._wantAssertionEncryptedAttributeName],s=yield e.$context[t._isSecureAttributeName],o=!!a||!!r;s!==o&&(e.$context[t._isSecureAttributeName]=o)})()}_tryUpdateCheckbox(e,t,a){return(0,l.A)(function*(){const r=yield e.$context[a],s=t[a];r!==s&&(e.$context[a]=s)})()}_tryUpdateCheckboxes(e){var t=this;return(0,l.A)(function*(){if(e.attributeName!==t.additionalParamsAttributeName)return;const a=yield t.getAdditionalParamsJson(e);a&&(yield t._tryUpdateCheckbox(e,a,t._wantAssertionSignedAttributeName),yield t._tryUpdateCheckbox(e,a,t._wantAssertionEncryptedAttributeName),e.$context[t.additionalParamsAttributeName]=t.getSerializedAdditionalParams(a))})()}_tryUpdateAdditionalParams(e){var t=this;return(0,l.A)(function*(){if(e.attributeName!==t._wantAssertionSignedAttributeName&&e.attributeName!==t._wantAssertionEncryptedAttributeName)return;const a=yield e.$context[e.attributeName];if(e.oldValue!==a){const r=yield t.getAdditionalParamsJson(e);if(!r)return;const s=r[e.attributeName];(!s||s!==a)&&(r[e.attributeName]=a,e.$context[t.additionalParamsAttributeName]=t.getSerializedAdditionalParams(r))}})()}getAdditionalParamsJson(e){var t=this;return(0,l.A)(function*(){const a=yield e.$context[t.additionalParamsAttributeName];try{const r=JSON.parse(a||"{}");return t.parseParameter(r,t._wantAssertionSignedAttributeName),t.parseParameter(r,t._wantAssertionEncryptedAttributeName),r}catch{return null}})()}parseParameter(e,t){Object.prototype.hasOwnProperty.call(e,t)&&(e[t]=JSON.parse(e[t]))}getSerializedAdditionalParams(e){return this.serializeParameter(e,this._wantAssertionSignedAttributeName),this.serializeParameter(e,this._wantAssertionEncryptedAttributeName),JSON.stringify(e)}serializeParameter(e,t){Object.prototype.hasOwnProperty.call(e,t)&&(e[t]=e[t]?.toString())}handle(e){var t=this;return(0,l.A)(function*(){return yield t._tryUpdateCheckboxes(e),yield t._tryUpdateAdditionalParams(e),yield t._tryUpdateIsSecureAttribute(e),t.next?.handle(e)})()}};w=(0,n.__decorate)([(0,S.l)({type:"crt.AdditionalParamsChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["SsoSamlBase_FormPage"]})],w);var fe=i(83455),R=i(90653);class E{_getCertificateBase64(e){let t="";const a=e.length();for(let r=0;r<a;r++)t+=String.fromCharCode(e.at(r));return t}_parceCertificate(e){let t=this._getCertificateBase64(e),a;if(/\s*-----BEGIN/.test(t)){a=R.pki.certificateFromPem(t);const o=R.pki.pemToDer(t);t=this._getCertificateBase64(o)}else{const o=R.asn1.fromDer(e,{strict:!1,parseAllBytes:!1});a=R.pki.certificateFromAsn1(o)}const r=R.md.sha1.create();r.update(t);const s=r.digest().toHex().toUpperCase();return{certificate:a,thumbprint:s}}_fillCeritficateModel(e,t,a){return(0,l.A)(function*(){yield e.reload([]);const r=yield e.createItem();r.IdpCertificatesDataGridDS_Id=(0,ce.qv)(),r.IdpCertificatesDataGridDS_NotAfter=t.certificate.validity.notAfter,r.IdpCertificatesDataGridDS_NotBefore=t.certificate.validity.notBefore,r.IdpCertificatesDataGridDS_Name=t.certificate.subject.attributes.map(s=>`${s.shortName}=${s.value}`).join(","),r.IdpCertificatesDataGridDS_Thumbprint=t.thumbprint,r.fileDto=a})()}addCertificateToCollection(e,t){var a=this;return(0,l.A)(function*(){const r=new R.util.ByteStringBuffer(t.content),s=a._parceCertificate(r);return yield a._fillCeritficateModel(e,s,t),s.thumbprint})()}static{this.\u0275fac=function(t){return new(t||E)}}static{this.\u0275prov=g.\u0275\u0275defineInjectable({token:E,factory:E.\u0275fac,providedIn:"any"})}}let pe=class extends M.S{};pe=(0,n.__decorate)([(0,H.$)({type:"crt.UploadSamlIdpCertificateRequest"})],pe);let q=class extends p.l{constructor(e,t){super(),this._fileReaderService=e,this._samlIdpCertificateService=t}_selectCertificate(e){var t=this;return(0,l.A)(function*(){const a={type:"crt.SelectFileRequest",allowedFileTypes:".cer,.der",multiple:!1,displayErrors:!1,$context:e.$context},{files:r}=yield t.handlerChain.process(a);return r})()}handle(e){var t=this;return(0,l.A)(function*(){const a=yield t._selectCertificate(e);if(!a||a.length===0)return;const r=yield e.$context.IdpCertificatesDataGrid,s=yield(0,A.lastValueFrom)((0,A.from)(a).pipe((0,N.mergeMap)(o=>t._fileReaderService.read(o)),(0,N.mergeMap)(o=>(0,A.from)(t._samlIdpCertificateService.addCertificateToCollection(r,o)))));(0,C.isEmpty)(s)||(e.$context.PartnerCertificateThumbprint=s,e.$context.WantAssertionSigned=!0),yield t.next?.handle(e)})()}};q=(0,n.__decorate)([(0,S.l)({type:"crt.UploadSamlIdpCertificateHandler",requestType:"crt.UploadSamlIdpCertificateRequest",scopes:["SsoSamlBase_FormPage"]}),(0,n.__metadata)("design:paramtypes",[fe.d,E])],q);var He=i(18587),ve=i(26628);let ee=class extends p.l{constructor(e,t){super(),this._httpClient=e,this._queryExecutor=t,this._samlMetadataUrl="/rest/SamlIdpService/UploadIdpCertificate"}_uploadCertificate(e,t,a){var r=this;return(0,l.A)(function*(){const s=yield a.fileDto,o=new f.HttpParams({encoder:new ve.G}).set("totalFileLength",s.file.size).set("parentColumnValue",e).set("fileId",t).set("fileName",s.file.name);return(0,A.lastValueFrom)(r._httpClient.post(r._samlMetadataUrl,s.content,{headers:new f.HttpHeaders({"Content-Range":`bytes 0/${s.file.size}`,"Content-Type":s.file.type,"Content-Disposition":`attachment; filename=${encodeURIComponent(s.file.name)}`}),params:o}))})()}_getIdpId(e){return(0,l.A)(function*(){const t=yield e.$context.getPrimaryDataSchema();return e.$context[t.primaryAttributeName]})()}handle(e){var t=this;return(0,l.A)(function*(){if(e.collectionAttributeName!=="IdpCertificatesDataGrid")return yield t.next?.handle(e);const a=yield e.$context[e.collectionAttributeName],r=a.getChangedItems(),s=yield t._getIdpId(e),o=[],h=new He.x("SamlIdpCertificateView");h.filters.addSchemaColumnFilterWithParameter(k.H.Equal,"SsoSamlSettings",s);for(const v of r){const Ce=(0,ce.qv)(),Ie=yield t._uploadCertificate(s,Ce,v);(0,C.isEmpty)(Ie)||(a.removeChildModel(v),a.remove(v),h.filters.addSchemaColumnFilterWithParameter(k.H.Not_equal,"Id",Ce)),o.push({success:!(0,C.isEmpty)(Ie),rowsAffected:1})}return o.filter(v=>v.success).length>0&&(yield(0,A.lastValueFrom)(t._queryExecutor.executeDeleteQuery(h))),o})()}};ee=(0,n.__decorate)([(0,S.l)({type:"crt.SaveSamlIdpCertificatesHandler",requestType:"crt.SaveCollectionPrimaryDataRequest",scopes:["SsoSamlBase_FormPage"]}),(0,n.__metadata)("design:paramtypes",[f.HttpClient,de.w])],ee);let Se=class extends M.S{};Se=(0,n.__decorate)([(0,H.$)({type:"crt.UploadSamlIdpMetadataRequest"})],Se);let te=class extends p.l{constructor(e,t,a){super(),this._httpClient=e,this._fileReaderService=t,this._samlIdpCertificateService=a,this._uploadMetadataUrl="/rest/SamlIdpService/ParseIdpMetadata"}_selectMetadata(e){var t=this;return(0,l.A)(function*(){const a={type:"crt.SelectFileRequest",allowedFileTypes:".xml",multiple:!1,displayErrors:!1,$context:e.$context},{files:r}=yield t.handlerChain.process(a);return r})()}_parceMetadata(e){const t=new f.HttpParams({encoder:new ve.G}).set("totalFileLength",e.file.size).set("fileName",e.file.name);return this._httpClient.post(this._uploadMetadataUrl,e.content,{headers:new f.HttpHeaders({"Content-Range":`bytes 0/${e.file.size}`,"Content-Type":e.file.type,"Content-Disposition":`attachment; filename=${encodeURIComponent(e.file.name)}`}),params:t})}_parseMetadata(e){return(0,A.lastValueFrom)((0,A.from)(e).pipe((0,N.mergeMap)(t=>this._fileReaderService.read(t)),(0,N.mergeMap)(t=>this._parceMetadata(t))))}_getCertificateContent(e){let t=new Uint8Array(e);if(t.length>0)return t;const a=window.atob(e);t=new Uint8Array(a.length);for(let r=0;r<a.length;r++)t[r]=a.charCodeAt(r);return t}_addCertificates(e,t){var a=this;return(0,l.A)(function*(){if(!t.PartnerCertificates||t.PartnerCertificates.length===0)return;const r=yield e.$context.IdpCertificatesDataGrid,s=yield Promise.all(t.PartnerCertificates.map(h=>a._samlIdpCertificateService.addCertificateToCollection(r,{file:new File([h.RawData],"certificate.cer"),content:a._getCertificateContent(h.RawData).buffer}))),o=s?.length>0?s[0]:"";(0,C.isEmpty)(o)||(e.$context.PartnerCertificateThumbprint=o,e.$context.WantAssertionSigned=!0)})()}handle(e){var t=this;return(0,l.A)(function*(){const a=yield t._selectMetadata(e);if(!a||a.length===0)return;const r=yield t._parseMetadata(a);e.$context.PartnerIdentityName=r.EntityID,e.$context.SingleSignOnServiceUrl=r.SingleSignOnServiceUrl,e.$context.SingleLogoutServiceUrl=r.SingleLogoutServiceUrl,yield t._addCertificates(e,r),yield t.next?.handle(e)})()}};te=(0,n.__decorate)([(0,S.l)({type:"crt.UploadSamlIdpMetadataHandler",requestType:"crt.UploadSamlIdpMetadataRequest",scopes:["SsoSamlBase_FormPage"]}),(0,n.__metadata)("design:paramtypes",[f.HttpClient,fe.d,E])],te);var Ne=i(89285);let ae=class extends w{constructor(){super(...arguments),this._defaultAdfsAdditionalParams={SignLogoutRequest:!0,SignLogoutResponse:!0},this._primaryModelModeAttrName="PrimaryModelMode"}_setDefaultAdditionalParams(e){Object.assign(e,this._defaultAdfsAdditionalParams)}handle(e){var t=this;return(0,l.A)(function*(){if(e.attributeName===t._primaryModelModeAttrName){const r=e.$context;if(r.getPrimaryModelMode()===Ne.b.Create){const o=(yield t.getAdditionalParamsJson(e))??{};t._setDefaultAdditionalParams(o),r[t.additionalParamsAttributeName]=JSON.stringify(o)}}return t.next?.handle(e)})()}};ae=(0,n.__decorate)([(0,S.l)({type:"crt.AdfsAdditionalParamsChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["SsoSamlAdfs_FormPage"]})],ae);let re=class extends p.l{constructor(){super(...arguments),this._itemsAttributeName="Items",this._additionalParamsAttrName="AdditionalParams",this._hasInsecureSettingsAttrName="HasInsecureSettings",this._providerTypeAttrName="ProviderType",this._samlSsoProviderType="c517e24e-2bf9-4245-9831-2d51cf3f3aa0"}getAdditionalParamsJson(e){return(0,l.A)(function*(){try{return JSON.parse(e||"{}")}catch{return{}}})()}_getAggregateAttrValue(e,t){return(0,l.A)(function*(){const r=Object.keys(t.attributes).find(s=>s.includes(e))??"";return yield t[r]})()}_retrieveSamlAdditionalParams(e){var t=this;return(0,l.A)(function*(){const a=yield Promise.all(e.map(function(){var s=(0,l.A)(function*(o){const h=(yield t._getAggregateAttrValue(t._providerTypeAttrName,o))?.value;return{viewModel:o,isSamlSsoProvider:h===t._samlSsoProviderType}});return function(o){return s.apply(this,arguments)}}())),r=yield Promise.all(a.filter(({isSamlSsoProvider:s})=>s).map(({viewModel:s})=>t._getAggregateAttrValue(t._additionalParamsAttrName,s)));return Promise.all(r.map(function(){var s=(0,l.A)(function*(o){return t.getAdditionalParamsJson(o)});return function(o){return s.apply(this,arguments)}}()))})()}_isTrue(e){return String(e).toLowerCase()==="true"}handle(e){var t=this;return(0,l.A)(function*(){if(!e||e.attributeName!==t._itemsAttributeName)return;const r=(yield t._retrieveSamlAdditionalParams(yield e.value)).some(s=>!(t._isTrue(s?.WantAssertionSigned)||t._isTrue(s?.WantAssertionEncrypted)));return e.$context[t._hasInsecureSettingsAttrName]=r,t.next?.handle(e)})()}};re=(0,n.__decorate)([(0,S.l)({type:"crt.IdpListChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["SsoSettingsV2"]})],re);var De=i(90023);let se=class extends De._{constructor(e){super(e)}getOperation(){return"CanManageSso"}};se=(0,n.__decorate)([(0,S.l)({type:"crt.OpenSsoSettingsPageHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["SsoSettings","SsoSettingsV2"]}),(0,n.__metadata)("design:paramtypes",[g.Injector])],se);var he=i(4080),_e=i(38834);let ie=class extends _e.j{constructor(){super(...arguments),this.i18nMessageKey="SsoSettings.Validators.AdfsTenant.Message",this.async=!1}validate(e,t){const a=super.validate(e);return a||(e.value.trim().startsWith("http")?{required:this.defaultValidationError(t)}:null)}};ie=(0,n.__decorate)([(0,he.m)({type:"crt.AdfsTenantValidator"})],ie);let ne=class extends _e.j{constructor(){super(...arguments),this.i18nMessageKey="SsoSettings.Validators.StringUrl.Message",this.async=!1}validate(e,t){if(t&&t.SkipEmptyValues&&(0,C.isEmpty)(e.value))return null;const r=super.validate(e);if(r)return r;const s=e.value;try{new URL(s)}catch{return{required:this.defaultValidationError(t)}}return null}};ne=(0,n.__decorate)([(0,he.m)({type:"crt.StringUrlValidator"})],ne);var Re=i(82265);let oe=class extends Re._{constructor(e){super(e),this.injector=e,this.i18nMessageKey="SsoSettings.Validators.IsJsonValidator.Message",this.async=!1,this._translateService=e?.get(T.TranslateService)}validate(e,t){const a=e.value;if((0,C.isEmpty)(a)&&t?.skipEmptyValues)return null;try{JSON.parse(a===null?"":a)}catch{return{IsJson:{message:this._translateService?.instant(this.i18nMessageKey)||""}}}return null}};oe=(0,n.__decorate)([(0,he.m)({type:"crt.IsJsonValidator"}),(0,n.__metadata)("design:paramtypes",[g.Injector])],oe);var Ae=i(40297),Ve=i(55642);let le=class ye{static{this.\u0275fac=function(t){return new(t||ye)}}static{this.\u0275mod=g.\u0275\u0275defineNgModule({type:ye})}static{this.\u0275inj=g.\u0275\u0275defineInjector({providers:[E,U,D,I],imports:[Ae.CommonModule,f.HttpClientModule]})}};le=(0,n.__decorate)([(0,Ve.g)({requestHandlers:[b,d,J,B,j,G,Q,W,z,$,K,X,Y,Z,w,q,ee,te,ae,re,se],validators:[ie,ne,oe]})],le),function(){(typeof ngJitMode>"u"||ngJitMode)&&g.\u0275\u0275setNgModuleScope(le,{imports:[Ae.CommonModule,f.HttpClientModule]})}();class be{constructor(){this.ssoIdentityProvider={},this.useJit=!1,this.sspUseJit=!1,this.useSlo=!1,this.name="",this.assertionConsumerServiceUrl="",this.singleLogoutServiceUrl=""}}}}]);
