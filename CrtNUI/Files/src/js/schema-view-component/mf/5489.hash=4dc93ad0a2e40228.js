(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[5489],{25489:(ge,M,s)=>{s.r(M),s.d(M,{CleanupSelectionStateAfterMergingRecordsHandler:()=>h,CrtMergeRecordsConflictsResolveDialogComponent:()=>l,CrtMergingRecordsModule:()=>p,MergeRecordsHandler:()=>f,MergeRecordsRequest:()=>v,MergeRecordsService:()=>g});var R=s(40297),t=s(59131),j=s(32483),y=s(76923),P=s(71252),S=s(79772),_=s(79877),F=s(59969),H=s(7622),E=s(86561),x=s(77976),O=s(23730),D=s(31149),L=s(43981),U=s(47369),B=s(90983),G=s(84600),c=s(62278),V=s(62115),k=s(15112),$=s(98850),W=s(82491);const J=m=>[m];function z(m,e){m&1&&t.\u0275\u0275element(0,"ts-mask")}const X="/Nui/ViewModule.aspx?ClassicUI&vm=MergeRecordsResolveConflictsModuleLoader&disableLogo=1";class l extends H.c{constructor(e,r){super(r,e),this._destroyRef=(0,t.inject)(t.DestroyRef),this._domSanitizer=(0,t.inject)(P.DomSanitizer),this._changeDetectorRef=(0,t.inject)(t.ChangeDetectorRef),this._extResourceFrameWindowMessenger=(0,t.inject)(E.b),this.loading=!0}_initModuleUrl(){const e=R.Location.joinWithSlash((0,B.cI)(),X);this.url=this._domSanitizer.bypassSecurityTrustResourceUrl(e)}_subscribeModuleLoaded(){this._extResourceFrameWindowMessenger.designerLoaded$.pipe((0,c.tap)(()=>{this.loading=!1,this._changeDetectorRef.markForCheck()}),(0,j.takeUntilDestroyed)(this._destroyRef)).subscribe()}ngOnInit(){this._initModuleUrl(),this._subscribeModuleLoaded()}onDataChanged(e){this._resolvedConflicts=e?.resolvedConflicts}onMerge(){this.dialog.close(this._resolvedConflicts)}onCancel(){this.dialog.close()}static{this.\u0275fac=function(r){return new(r||l)(t.\u0275\u0275directiveInject(y.MAT_LEGACY_DIALOG_DATA),t.\u0275\u0275directiveInject(y.MatLegacyDialogRef))}}static{this.\u0275cmp=t.\u0275\u0275defineComponent({type:l,selectors:[["crt-merge-records-conflicts-resolve-dialog"]],standalone:!0,features:[t.\u0275\u0275ProvidersFeature([F.rK,E.b,(0,x.d)({...O.q,channel:"merge-records-conflicts-resolver-channel",requestConfig:"RequestMergeRecordsConflicts",responseConfig:"ResponseMergeRecordsConflicts",saveConfig:"SaveMergeRecordsConflicts"})]),t.\u0275\u0275InheritDefinitionFeature,t.\u0275\u0275StandaloneFeature],decls:11,vars:19,consts:[[3,"title","displayCloseButton"],["content",""],[4,"ngIf"],["title","merge-records-conflict-resolving-iframe",3,"dataChange","escPressed","url","data"],["actions",""],["data-item-marker","cancelBtn",3,"clicked","caption"],["color","primary","data-item-marker","mergeBtn",3,"clicked","caption","disabled"]],template:function(r,o){r&1&&(t.\u0275\u0275elementStart(0,"crt-dialog",0),t.\u0275\u0275pipe(1,"translate"),t.\u0275\u0275pipe(2,"stringFormat"),t.\u0275\u0275elementContainerStart(3,1),t.\u0275\u0275template(4,z,1,0,"ts-mask",2),t.\u0275\u0275elementStart(5,"crt-ext-resource-frame",3),t.\u0275\u0275listener("dataChange",function(a){return o.onDataChanged(a)})("escPressed",function(){return o.onCancel()}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd(),t.\u0275\u0275elementContainerStart(6,4),t.\u0275\u0275elementStart(7,"crt-button",5),t.\u0275\u0275pipe(8,"translate"),t.\u0275\u0275listener("clicked",function(){return o.onCancel()}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(9,"crt-button",6),t.\u0275\u0275pipe(10,"translate"),t.\u0275\u0275listener("clicked",function(){return o.onMerge()}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd(),t.\u0275\u0275elementEnd()),r&2&&(t.\u0275\u0275property("title",t.\u0275\u0275pipeBind2(2,10,t.\u0275\u0275pipeBind1(1,8,"MergingRecords.ConflictsResolveDialog.TitleTemplate"),t.\u0275\u0275pureFunction1(17,J,o.data==null||o.data.conflicts==null?null:o.data.conflicts.length)))("displayCloseButton",!0),t.\u0275\u0275advance(4),t.\u0275\u0275property("ngIf",o.loading),t.\u0275\u0275advance(),t.\u0275\u0275property("url",o.url)("data",o.data),t.\u0275\u0275advance(2),t.\u0275\u0275property("caption",t.\u0275\u0275pipeBind1(8,13,"Dialog.Cancel")),t.\u0275\u0275advance(2),t.\u0275\u0275property("caption",t.\u0275\u0275pipeBind1(10,15,"MergingRecords.ConflictsResolveDialog.Actions.Merge"))("disabled",o.loading))},dependencies:[R.CommonModule,R.NgIf,D.q,V.B,L.k,k.H,U.m,$.t,_.R,W.I,G.N,S.TranslateModule,S.TranslatePipe],encapsulation:2})}}var u=s(73308),i=s(5960),I=s(41287),A=s(844);let h=class extends I.l{_cleanupSelectionStates(e){const{scopes:r,$context:o,dataSourceName:n}=e;if(!n)return Promise.resolve();const a={type:"crt.CleanupSelectionStateRequest",scopes:r,$context:o,target:{modelName:n}};return this.handlerChain.process(a)}handle(e){var r=this;return(0,u.A)(function*(){const o=yield r.next?.handle(e);return o===!0&&(yield r._cleanupSelectionStates(e)),o})()}};h=(0,i.__decorate)([(0,A.l)({type:"crt.CleanupSelectionStateAfterMergingRecordsHandler",requestType:"crt.MergeRecordsRequest"})],h);var Y=s(40968),K=s(22592),Q=s(6503),Z=s(50485),w=s(23691),b=s(31774),q=s(50342),ee=s(99298);const te="CanMergeDuplicates",T=2;var re=s(81517),se=s(2828),oe=s(60776);let v=class extends re.S{constructor(){super(...arguments),this.type="crt.MergeRecordsRequest"}};v=(0,i.__decorate)([(0,se.$)({type:"crt.MergeRecordsRequest",title:"InterfaceDesigner.PropertiesPages.MergeRecordsRequest.Caption",propertiesPanelComponentTypeName:"crt.MergeRecordsRequestPropertiesPanel",position:702,compatibleAPIs:{[oe.I.Selection]:!0}})],v);var ne=s(63721),ae=s(28399),N=s(36486);const ie=1,le="/rest/DeduplicationService/MergeEntityDuplicatesAsync";class g{constructor(e){this._httpClient=e}_validateConfig(e){return e?.schemaName&&e?.recordIds?.length>=T}_getRequestPayload(e){return{groupId:e.groupId??ie,schemaName:e.schemaName,deduplicateRecordIds:e.recordIds,mergeConfig:e.resolvedConflicts?JSON.stringify(e.resolvedConflicts):void 0}}_getErrorResult(e){return{success:!1,message:e?.message}}_getSuccessResult(e){const r=e?.MergeEntityDuplicatesAsyncResult;if(!r)throw new Error("Invalid response from server");return(0,ae.cloneDeep)(r)}merge(e){if(!this._validateConfig(e))return(0,c.of)({success:!1,message:"Invalid configuration for merging records"});const r=this._getRequestPayload(e);return this._httpClient.post(le,r).pipe((0,N.map)(o=>this._getSuccessResult(o)),(0,N.catchError)(o=>(0,c.of)(this._getErrorResult(o))))}static{this.\u0275fac=function(r){return new(r||g)(t.\u0275\u0275inject(ne.HttpClient))}}static{this.\u0275prov=t.\u0275\u0275defineInjectable({token:g,factory:g.\u0275fac,providedIn:"root"})}}const ce=10;let f=class extends I.l{constructor(e,r,o,n,a,d){super(),this._maskService=e,this._rightService=r,this._notifyService=o,this._mergeRecordsService=n,this._messageDialogProvider=a,this._dialogProvider=d}_getMaskTaskName(e){return"MERGE_RECORDS_"+e.dataSourceName}_showMask(e){return this._maskService.showMask(this._getMaskTaskName(e),e.$context)}_hideMask(e){return this._maskService.hideMask(this._getMaskTaskName(e),e.$context)}_showError(e){var r=this;return(0,u.A)(function*(){let o;e instanceof Error?o=e:o=new Error(typeof e=="string"?e:JSON.stringify(e)),o.cause==="info"?yield r._notifyService.show({message:o.message}):yield(0,c.lastValueFrom)(r._messageDialogProvider.error(o.message))})()}_checkRights(){var e=this;return(0,u.A)(function*(){if(!(yield(0,c.firstValueFrom)(e._rightService.getCanExecuteOperation(te))))throw new Error("MergingRecords.Handler.Errors.NoRights")})()}_mergeRecords(e){var r=this;return(0,u.A)(function*(){const o=r._createMergeRecordsConfig(e);let n=0;for(;n<ce;){yield r._showMask(e);const a=yield(0,c.firstValueFrom)(r._mergeRecordsService.merge({...o}));if(yield r._hideMask(e),a?.success)return!0;if(!a?.conflicts)throw new Error(a.message);if(o.resolvedConflicts=yield r._resolveMergeRecordsConflicts({...o},a),!o.resolvedConflicts)return!1;n++}throw new Error("MergingRecords.Handler.Errors.General")})()}_createMergeRecordsConfig(e){const{$context:r,dataSourceName:o,recordIds:n,selectionState:a}=e;if(!o||n&&a)throw new Error("InfoDialog.SettingsErrorMessage");if(a?.type==="all")throw new Error("MergingRecords.Handler.Errors.SelectionAllModeUsingViolation",{cause:"info"});let d=a?.type==="specific"?a.selected:n;if(d=d?.filter(Boolean),!d?.length||d?.length<T)throw new Error("MergingRecords.Handler.Errors.MinSelectedRecordsViolation",{cause:"info"});return{schemaName:r.dataSchemas[o].name,recordIds:d}}_resolveMergeRecordsConflicts(e,r){return(0,c.lastValueFrom)(this._dialogProvider.open(l,{data:{conflicts:r.conflicts,schemaName:e.schemaName},disableClose:!0,minWidth:"50vw",minHeight:"50vh"}))}handle(e){var r=this;return(0,u.A)(function*(){let o=!1;try{yield r._showMask(e),yield r._checkRights(),yield r._hideMask(e),o=yield r._mergeRecords(e)}catch(n){r._showError(n)}finally{yield r._hideMask(e)}return yield r?.next?.handle(e),o})()}};(0,i.__decorate)([(0,w.y)({channel:"snackbar",defaultMessage:"MergingRecords.Handler.SuccessfulCompletionStatus"}),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[v]),(0,i.__metadata)("design:returntype",Promise)],f.prototype,"handle",null),f=(0,i.__decorate)([(0,A.l)({type:"crt.MergeRecordsHandler",requestType:"crt.MergeRecordsRequest"}),(0,i.__param)(0,(0,Y.j)(ee.V)),(0,i.__metadata)("design:paramtypes",[K.s,Z.f,Q.F,g,b.r,q.C])],f);var de=s(55642);let p=class C{static{this.\u0275fac=function(r){return new(r||C)}}static{this.\u0275mod=t.\u0275\u0275defineNgModule({type:C})}static{this.\u0275inj=t.\u0275\u0275defineInjector({imports:[l]})}};p=(0,i.__decorate)([(0,de.g)({includes:[D.q],requestHandlers:[h,f]})],p),function(){(typeof ngJitMode>"u"||ngJitMode)&&t.\u0275\u0275setNgModuleScope(p,{imports:[l],exports:[l]})}()}}]);
