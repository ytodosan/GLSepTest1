(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[223],{50223:(D,p,s)=>{s.r(p),s.d(p,{AD_PLATFORM_REFRESH_SUBSCRIPTION_ATTRIBUTE_NAME:()=>Y,AdPlatformLoginRequest:()=>j,DigitalAdsAdAccountsService:()=>y,DigitalAdsModule:()=>x,DigitalAdsNotificationService:()=>M});var a=s(5960),f=s(40297),r=s(59131),v=s(10067),_=s(55642),u=s(79772),S=s(59969),E=s(23092),l=s(62278),P=s(844),L=s(40968),A=s(6503),b=s(78037),W=s(76499),o=s(34845),i=s(13443);let h=class extends W.N{constructor(t,e,n,d,g,I){super(e,n,d,g,I),this.translateService=t,this.httpClient=e,this.notifyService=n,this.restErrorHandler=d,this.sessionIdentifierService=g,this.window=I}getInvalidPlatformMessage(){return this.translateService.instant("DigitalAdsContent.PlatformUndefinedMessage")}getInvalidApplicationMessage(){return this.translateService.instant("DigitalAdsContent.ApplicationUndefinedMessage")}};h=(0,a.__decorate)([(0,P.l)({type:"crt.AdPlatformLoginHandler",requestType:"crt.AdPlatformLogin"}),(0,a.__param)(5,(0,L.j)(S.ZP)),(0,a.__metadata)("design:paramtypes",[u.TranslateService,b.v,A.F,i.x,o.b,Window])],h);var c=s(73308),C=s(41287),w=s(49973),R=s(91775);class V{constructor(t){this.platform=t}}class ${constructor(t,e,n){this.virtualAdAccountsIdentifiers=t,this.platform=e,this.websocketSessionId=n}}var U=s(5240),K=s(65751);class y{constructor(t,e,n,d,g){this._messageChannelService=t,this._restErrorHandler=e,this.httpClient=n,this._queryExecutor=d,this._sessionIdentifierService=g}_isCurrentSessionMessage(t){const e=this._sessionIdentifierService.identifier;return!t||!e||t===e}_handleWebSocketMessage(t){if(t&&this._isCurrentSessionMessage(t.websocketSessionId)){switch(t.command){case"select.adaccounts":this._openAdAccountSelection(t.platform);break}return}}_getLookupPageFeatures(){return{select:{multiple:!0,selectAll:!0},disableLinks:!1}}_getPreSelectedAdAccounts(t){const e=new V(t);return this._restErrorHandler.handleRequest(this.httpClient.post("/rest/AdAccountsService/GetAdAccountsIdentifiers",e,{responseType:"json"})).pipe((0,l.map)(n=>n))}_loadAdAccountsByFilter(t,e){var n=this;return(0,c.A)(function*(){const d=new w.s(t);return n._addFiltersToEsq(d,e),yield n._queryExecutor.executeSelectQuery(d).pipe((0,l.map)(I=>I.map(N=>({id:N.Id}))))})()}_addFiltersToEsq(t,e){Object.entries(e.items).forEach(([n,d])=>{t.filters.add(d,n)})}_getOpenLookupPageRequestConfig(t){var e=this;const n=this._context,d=this._context._scopes;return this._getPreSelectedAdAccounts(t).pipe((0,l.switchMap)(g=>{const I=g.body;return(0,l.of)({type:"crt.OpenSelectionWindowRequest",$context:n,scopes:d,entitySchemaName:"VirtualAdAccount",schemaName:"SelectAdAccountsLookupPage",features:this._getLookupPageFeatures(),selectionState:{type:"specific",selected:I},returnEmptyValue:!0,afterClosed:function(){var N=(0,c.A)(function*(G){const O=G.filter;if(O?.isEmpty){e._saveSelectedAdAccounts(t,[]).subscribe();return}(yield e._loadAdAccountsByFilter("VirtualAdAccount",O)).pipe((0,l.switchMap)(q=>{const ee=q.map(te=>te.id);return e._saveSelectedAdAccounts(t,ee)})).subscribe()});return function(O){return N.apply(this,arguments)}}()})}))}_saveSelectedAdAccounts(t,e){const n=this._sessionIdentifierService.identifier,d=new $(e,t,n);return this._restErrorHandler.handleRequest(this.httpClient.post("/rest/AdAccountsService/SaveAdAccounts",d,{responseType:"json"})).pipe((0,l.map)(g=>g))}_openAdAccountSelection(t){this._getOpenLookupPageRequestConfig(t).subscribe(e=>{R.t.instance.process(e)})}subscribeMessageChannelEvents(t){this._context=t,this._subscription=this._messageChannelService.messageEvent$.pipe((0,l.filter)(e=>e.header.sender==="CrtDigitalAdsApp.SelectAdAccounts"),(0,l.map)(e=>{const n=e.body;return{messageId:e.id.toString(),isSuccess:n.isSuccess,command:n.command,description:n.description,errorCode:n.errorCode,platform:n.platform,websocketSessionId:n.websocketSessionId}})).subscribe(e=>{this._handleWebSocketMessage(e)})}unSubscribeMessageChannelEvents(){this._subscription?.unsubscribe()}static{this.\u0275fac=function(e){return new(e||y)(r.\u0275\u0275inject(U.A),r.\u0275\u0275inject(i.x),r.\u0275\u0275inject(b.v),r.\u0275\u0275inject(K.w),r.\u0275\u0275inject(o.b))}}static{this.\u0275prov=r.\u0275\u0275defineInjectable({token:y,factory:y.\u0275fac,providedIn:"root"})}}var k=s(82517),Z=s(7471);class M{constructor(t,e,n,d,g){this._translateService=t,this.notifyService=e,this._dialogService=n,this._messageChannelService=d,this._sessionIdentifierService=g,this._snackbarDuration=3e3,this._allowedSenders=["CrtDigitalAdsApp","CloudIntegration"]}_showMessage(t){var e=this;return(0,c.A)(function*(){yield e.notifyService.show({message:t,duration:e._snackbarDuration})})()}subscribeMessageChannelEvents(t){this._context=t,this._subscription=this._messageChannelService.messageEvent$.pipe((0,l.filter)(e=>this._allowedSenders.indexOf(e.header.sender)>-1),(0,l.map)(e=>{const n=e.body;return{messageId:e.id.toString(),isSuccess:n.isSuccess,command:n.command,description:n.description,errorCode:n.errorCode,websocketSessionId:n.websocketSessionId}})).subscribe(e=>{this._handleWebSocketMessage(e)})}_updateConnectedAccountsList(t){var e=this;return(0,c.A)(function*(){const n={type:"crt.LoadDataRequest",config:{loadType:k.I.Reload,useLastLoadParameters:!0},$context:e._context,dataSourceName:t};return yield R.t.instance.process(n),Promise.resolve()})()}_isCurrentSessionMessage(t){const e=this._sessionIdentifierService.identifier;return!t||!e||t===e}_handleWebSocketMessage(t){var e=this;return(0,c.A)(function*(){if(t&&e._isCurrentSessionMessage(t.websocketSessionId)){switch(t.command){case"refresh.adAccount.facebook":yield e._updateConnectedAccountsList("DataGrid_AdAccountsTabContainerFacebookGridDS");break;case"refresh.adAccount.google":yield e._updateConnectedAccountsList("DataGrid_AdAccountsTabContainerGoogleGridDS");break;case"import.started":e._showMessage(e._translateService.instant("DigitalAdsContent.ImportFromAdPlatformStartedMessage"));break;case"adaccounts.notfound":e._dialogService.openInfoDialog(e._translateService.instant("DigitalAdsContent.NoActiveAdAccountsFoundMessage"));break;case"no.connected.adaccounts":e._showMessage(e._translateService.instant("DigitalAdsContent.NoConnectedAdAccountsFoundMessage"));break;case"show.ErrorScreen":e._dialogService.openInfoDialog(t.description);break}return}})()}unSubscribeMessageChannelEvents(){this._subscription?.unsubscribe()}static{this.\u0275fac=function(e){return new(e||M)(r.\u0275\u0275inject(u.TranslateService),r.\u0275\u0275inject(A.F),r.\u0275\u0275inject(Z.o),r.\u0275\u0275inject(U.A),r.\u0275\u0275inject(o.b))}}static{this.\u0275prov=r.\u0275\u0275defineInjectable({token:M,factory:M.\u0275fac,providedIn:"root"})}}let F=class extends C.l{constructor(t,e){super(),this.digitalAdsNotificationService=t,this.digitalAdsAdAccountsService=e}handle(t){var e=this;return(0,c.A)(function*(){e.digitalAdsAdAccountsService.unSubscribeMessageChannelEvents(),e.digitalAdsNotificationService.unSubscribeMessageChannelEvents(),yield e.next?.handle(t)})()}};F=(0,a.__decorate)([(0,P.l)({type:"crt.AdPlatformViewModelPauseHandler",requestType:"crt.HandleViewModelPauseRequest",scopes:["AdCampaign_ListPage"]}),(0,a.__metadata)("design:paramtypes",[M,y])],F);let H=class extends C.l{constructor(t,e){super(),this.digitalAdsNotificationService=t,this.digitalAdsAdAccountsService=e}handle(t){var e=this;return(0,c.A)(function*(){e.digitalAdsAdAccountsService.subscribeMessageChannelEvents(t.$context),e.digitalAdsNotificationService.subscribeMessageChannelEvents(t.$context),yield e.next?.handle(t)})()}};H=(0,a.__decorate)([(0,P.l)({type:"crt.AdPlatformViewModelResumeHandler",requestType:"crt.HandleViewModelResumeRequest",scopes:["AdCampaign_ListPage","WebAnalytics_SectionPage"]}),(0,a.__metadata)("design:paramtypes",[M,y])],H);var z=s(2828),J=s(93993);let j=class extends J.i{constructor(){super(...arguments),this.type="crt.AdPlatformLogin"}};j=(0,a.__decorate)([(0,z.$)({type:"crt.AdPlatformLogin",scopes:["AdCampaign_ListPage"],propertiesPanelComponentTypeName:"crt.AdPlatformLoginPropertiesPanel",position:950,title:"DigitalAdsContent.AdPlatformLoginRequestTitle"})],j);function Q(){const m=[j]}Q();function X(m,t){return()=>(0,l.lastValueFrom)(m.loadCurrentUserInfo().pipe((0,l.tap)(e=>{t.use(e?.userInfo?.cultureInfo?.sysCultureName)})),{defaultValue:null})}let x=class B{static{this.\u0275fac=function(e){return new(e||B)}}static{this.\u0275mod=r.\u0275\u0275defineNgModule({type:B})}static{this.\u0275inj=r.\u0275\u0275defineInjector({providers:[S.rK,{provide:r.APP_INITIALIZER,useFactory:X,deps:[E.fv,u.TranslateService],multi:!0}],imports:[f.CommonModule,v.MatSnackBarModule,u.TranslateModule]})}};x=(0,a.__decorate)([(0,_.g)({requestHandlers:[h,F,H]})],x),function(){(typeof ngJitMode>"u"||ngJitMode)&&r.\u0275\u0275setNgModuleScope(x,{imports:[f.CommonModule,v.MatSnackBarModule,u.TranslateModule]})}();const Y="AdPlatformRefreshSubscriptionAttribute"},76499:(D,p,s)=>{s.d(p,{N:()=>b});var a=s(73308),f=s(5960),r=s(41287),v=s(40968),_=s(6503),u=s(59969),S=s(78037),E=s(13443),l=s(62278);class P{constructor(o,i,h){this.application=o,this.platform=i,this.websocketSessionId=h}}var L=s(34845),A=s(59131);let b=class T extends r.l{constructor(o,i,h,c,C){super(),this.httpClient=o,this.notifyService=i,this.restErrorHandler=h,this.sessionIdentifierService=c,this.window=C,this._snackbarDuration=3e3}_validateRequest(o){return o.platform===void 0?(this._showMessage(this.getInvalidPlatformMessage()),!1):o.app===void 0?(this._showMessage(this.getInvalidApplicationMessage()),!1):!0}_getFlowUrl(o){const i=this.sessionIdentifierService.identifier,h=new P(o.app,o.platform,i);return this.restErrorHandler.handleRequest(this.httpClient.post("/rest/SocialOAuthProxyService/AuthenticateToPlatform",h,{responseType:"json"})).pipe((0,l.map)(c=>{if(c.body!=="")return new URL(c.body)}))}_showMessage(o){var i=this;return(0,a.A)(function*(){yield i.notifyService.show({message:o,duration:i._snackbarDuration})})()}_showLoginWindow(o){const i="Login",C=window.screenLeft+(window.innerWidth-650)/2,w=window.screenTop+(window.innerHeight-650)/2,R=`width=650,height=650,left=${C},top=${w},
		  scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no`;this.window.open(o.toString(),i,R)}handle(o){var i=this;return(0,a.A)(function*(){i._context=o.$context;const h=i._context.attributes.Connect_account_button_enabled;if(h&&h===!0){i._context.attributes.Connect_account_button_enabled=!1;try{if(!i._validateRequest(o))return;i._getFlowUrl(o).subscribe(c=>{c&&i._showLoginWindow(c)})}finally{i._context.attributes.Connect_account_button_enabled=!0,yield i.next?.handle(o)}}})()}static{this.\u0275fac=function(i){return new(i||T)(A.\u0275\u0275inject(S.v),A.\u0275\u0275inject(_.F),A.\u0275\u0275inject(E.x),A.\u0275\u0275inject(L.b),A.\u0275\u0275inject(Window))}}static{this.\u0275prov=A.\u0275\u0275defineInjectable({token:T,factory:T.\u0275fac})}};b=(0,f.__decorate)([(0,f.__param)(4,(0,v.j)(u.ZP)),(0,f.__metadata)("design:paramtypes",[S.v,_.F,E.x,L.b,Window])],b)},93993:(D,p,s)=>{s.d(p,{i:()=>f});var a=s(81517);class f extends a.S{}},34845:(D,p,s)=>{s.d(p,{b:()=>v});var a=s(35293),f=s(59131),r=s.n(f);class v{constructor(){this._storageKey="uniqueIdentifier",sessionStorage.removeItem(this._storageKey)}get identifier(){let u=sessionStorage.getItem(this._storageKey);return u||(u=(0,a.A)(),sessionStorage.setItem(this._storageKey,u)),u}static{this.\u0275fac=function(S){return new(S||v)}}static{this.\u0275prov=f.\u0275\u0275defineInjectable({token:v,factory:v.\u0275fac,providedIn:"root"})}}}}]);
