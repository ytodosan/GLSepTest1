(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[716],{80716:($,E,c)=>{c.r(E),c.d(E,{CopilotChatMessageService:()=>ae,CopilotChatService:()=>F,CopilotFileValidatorService:()=>q,CopilotGtmService:()=>G,CopilotMentionService:()=>ge,CopilotModule:()=>je,CopilotService:()=>Z});var o=c(5960),M=c(3602),R=c(55642),f=c(79772),v=c(68651),T=c(40297),d=c(59131),D=c(63721),b=c(66486),N=c(13443),A=c(28399),a=c(62278),m=c(36486);const x=new d.InjectionToken("OptionsSkipUnsuccessfulResponseHandling"),I=new d.InjectionToken("SchemaDesignerApiUrl"),P=new d.InjectionToken("SchemaDesignerConverter");var S=c(6530),O=c(26594);function H(){return`BusinessRule_${(0,S.qv)().substring(0,7)}`}var W;(function(r){r.BusinessRule="BusinessRule",r.RelatedPage="RelatedPage",r.TimelineEntity="TimelineEntity",r.AppearanceSettings="AppearanceSettings",r.Sidebar="Sidebar",r.UCTestAddon="UCTestAddon",r.MobileRelatedPage="MobileRelatedPage"})(W||(W={}));var ke=c(26544);class Be extends ke.D{constructor(e){super(e),this.typeName="Terrasoft.Core.Addons.AddonSchema",this.metaData=e.metaData,this.addonName=e.addonName,this.targetSchemaUId=e.targetSchemaUId,this.targetSchemaManagerName=e.targetSchemaManagerName,this.typeName=e.typeName,this.id=e.id,this.parentSchemaUId=e.parentSchemaUId,this.package=e.package,this.resources=e.resources,this.useFullHierarchy=e.useFullHierarchy}clone(){return new Be(this)}set addonConfig(e){this.metaData=JSON.stringify(e,null,"	")}get addonConfig(){try{return JSON.parse(this.metaData)}catch{throw new Error("Invalid addon JSON metadata received from server")}}equal(e){return this.metaData===e.metaData&&this.addonName===e.addonName&&this.targetSchemaManagerName===e.targetSchemaManagerName&&this.targetSchemaUId===e.targetSchemaUId&&this.typeName===e.typeName&&this.extendParent===e.extendParent&&this.uId===e.uId&&this.name===e.name&&this.packageUId===e.packageUId&&this.caption===e.caption&&this.id===e.id&&this.parentSchemaUId===e.parentSchemaUId}}class be{constructor(...e){if(this._isLoaded=!1,this._isChanged=!1,this.id=(0,S.qv)(),e[0]instanceof be){const t=e[0];this.addonName=t.addonName,this._targetSchemaUId=t.targetSchemaUId,this.targetSchemaManagerName=t.targetSchemaManagerName,this.targetParentSchemaUId=t.targetParentSchemaUId,this.targetPackageUId=t.targetPackageUId,this.id=t.id,this._apiService=t._apiService,this._isLoaded=t._isLoaded,this._isChanged=t._isChanged,t._schema&&(this._schema=t._schema.clone()),this.useFullHierarchy=t.useFullHierarchy}else this.addonName=e[0],this._targetSchemaUId=e[1],this.targetParentSchemaUId=e[2],this.targetPackageUId=e[3],this.targetSchemaManagerName=e[4],this._apiService=e[5],this.useFullHierarchy=e[6]}get schema$(){return this._isLoaded?(0,a.of)(this._schema):this._loadSchema()}get isChanged(){return this._isChanged}get resources(){return this._resources}get targetSchemaUId(){return this._targetSchemaUId}set targetSchemaUId(e){this._targetSchemaUId=e,this._schema&&(this._schema.targetSchemaUId=e)}get addonConfig(){return this.schema$.pipe((0,m.map)(e=>{const t=e.addonConfig;return this._setMetadataDefValues(t),t}))}set addonConfig(e){(0,a.forkJoin)([this.schema$,e]).subscribe(([t,n])=>{t.addonConfig=n,this._isChanged=!0})}_setMetadataDefValues(e){this.addonName===W.BusinessRule&&e.rules?.forEach(n=>{n.name=n.name||H(),n.enabled=n.enabled||n.enabled===void 0})}_setAddonResources(e){this._resources=e.map(t=>{const n=t.key.split(".");return{key:[n[2],n[3]].join("."),value:t.value}}),this._schema.resources=[...this._resources]}_loadSchema(){return this._schema$?this._schema$:(this._schema$=this._apiService.getAddon({targetSchemaUId:this.targetSchemaUId,addonName:this.addonName,targetParentSchemaUId:this.targetParentSchemaUId,targetPackageUId:this.targetPackageUId,targetSchemaManagerName:this.targetSchemaManagerName,useFullHierarchy:this.useFullHierarchy}).pipe((0,m.tap)(e=>{e.success&&(this._schema=new Be(e.schema),this._schema.typeName="Terrasoft.Core.Addons.AddonSchema",this._isLoaded=!0,this._setAddonResources(e.schema.resources??[]))}),(0,m.map)(()=>this._schema),(0,m.share)()),this._schema$)}save(){return this._isLoaded?this._apiService.saveAddon(this._schema).pipe((0,m.map)(e=>e.success),(0,m.tap)(()=>{this._isChanged=!1})):(0,a.of)(!0)}clone(){return new be(this)}equal(e){let t=this._isLoaded===e._isLoaded&&e.targetSchemaUId===this.targetSchemaUId&&e.addonName===this.addonName&&this.targetSchemaManagerName===e.targetSchemaManagerName;return t&&this._isLoaded&&(t=this._schema.equal(e._schema)),t}createOrUpdateResource(e){const t=this.resources.findIndex(n=>n.key===e.key);t===-1?this.resources.push(e):this.resources.splice(t,1,e),this._schema.resources=[...this._resources]}removeResource(e){const t=this.resources.findIndex(n=>n.key===e);this.resources.splice(t,1),this._schema.resources=[...this._resources]}}class me{constructor(e){this._httpClient=e,this._workplaceServiceUrl="/rest/WorkplaceService/"}resetWorkplaceScriptCache(){const e=this._workplaceServiceUrl+"ResetScriptCache";return this._httpClient.post(e,null)}static{this.\u0275fac=function(t){return new(t||me)(d.\u0275\u0275inject(D.HttpClient))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:me,factory:me.\u0275fac,providedIn:"root"})}}class re{constructor(e){this.getAddonMethodName="GetSchema",this.getAddonMetadataMethodName="GetSchemaMetadata",this.saveAddonMethodName="SaveSchema",this.serviceEndpoint="/ServiceModel/AddonSchemaDesignerService.svc/",this._httpClient=e.get(D.HttpClient),this._workplaceService=e.get(me)}getAddon(e){const t=`${this.serviceEndpoint}${this.getAddonMethodName}`;return this._httpClient.post(t,e)}getAddonMetadata(e){const t=`${this.serviceEndpoint}${this.getAddonMetadataMethodName}`;return this._httpClient.post(t,e)}saveAddon(e){const t=`${this.serviceEndpoint}${this.saveAddonMethodName}`;return this._httpClient.post(t,e).pipe((0,a.switchMap)(n=>this._workplaceService.resetWorkplaceScriptCache().pipe((0,m.map)(()=>n))))}static{this.\u0275fac=function(t){return new(t||re)(d.\u0275\u0275inject(d.Injector))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:re,factory:re.\u0275fac})}}class ce{constructor(e){this._apiService=e.get(re),this._features=e.get(O.G,{optional:!0})}_getParentSchemaUId(e){const t=e.parentSchema??e.parent;return t?.name===e.name?t.uId:S.To}create(e,t){return!e.addonTypes||e.addonTypes.length===0?[]:e.addonTypes.map(n=>{const s=this._getParentSchemaUId(e);return this.createAddonInfo(e,n,s,t)})}createAddonInfo(e,t,n,s){return new be(t,e.uId,n,e.package.uId,s,this._apiService,e.useFullHierarchy)}static{this.\u0275fac=function(t){return new(t||ce)(d.\u0275\u0275inject(d.Injector))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:ce,factory:ce.\u0275fac})}}const Qn=r=>`/ServiceModel/${r}/`,Xn=(r,e)=>({multi:!1,provide:e,useValue:Qn(r)}),Zn=r=>Xn(r,I);class _e extends b.t{get converter(){return this._converter}constructor(e){super(),this._restErrorHandleOptions={},this.createNewSchemaMethodName="CreateNewSchema",this.getSchemaMethodName="GetSchema",this.saveSchemaMethodName="SaveSchema",this.serviceEndpoint=e.get(I),this._converter=e.get(P,null,{optional:!0}),this._addonInfoFactory=e.get(ce),this._errorHandler=e.get(N.x),this._restErrorHandleOptions.skipUnsuccessfulResponse=e.get(x,!1,{optional:!0})}getSchemaManagerName(){return null}getSchemaFromService(e,t,n=!1){const s=n?{headers:new D.HttpHeaders({"Content-Type":"application/json"})}:{};return this.httpClient.post(e,t,s).pipe((0,m.map)(i=>{if(i.schema){const l=this.getSchemaManagerName();return i.schema=this.convertToObject(i.schema),i.schema.addons=this._addonInfoFactory.create(i.schema,l),i}return i}),(0,m.share)())}getSchemasFromService(e,t,n=!1){const s=n?{headers:new D.HttpHeaders({"Content-Type":"application/json"})}:{};return this.httpClient.post(e,t,s).pipe((0,m.map)(i=>{if(i.schemas){const l=this.getSchemaManagerName();return i.schemas.forEach((p,h)=>{i.schemas[h]=this.convertToObject(p),i.schemas[h].addons=this._addonInfoFactory.create(p,l)}),i}return i}),(0,m.share)())}createObject(e,t){return Object.assign(new e,t)}convertToObject(e){return this._converter.convertToSchema(e)}convertSchemaToDTO(e){return e}_addonSaveHandler(e){const t=e.save();return this._errorHandler.handleRequest(t,this._restErrorHandleOptions).pipe((0,m.catchError)(()=>(0,a.of)(!1)),(0,m.map)(n=>({message:`Addon ${e.addonName} was ${n?"successfully":"not"} saved!`,result:n})))}_saveAddons(e){return(0,a.forkJoin)(e.map(t=>this._addonSaveHandler(t))).pipe((0,m.map)(t=>{const n=t.filter(s=>!s.result).map(s=>s.message);return n.length>0?n:null}))}createSchema(e){const t=`${this.serviceEndpoint}${this.createNewSchemaMethodName}`;return this.getSchemaFromService(t,e)}getSchema(e){const t=`${this.serviceEndpoint}${this.getSchemaMethodName}`;return this.getSchemaFromService(t,e)}saveSchema(e,t=!1){t&&(e.useFullHierarchy=!0);const n=`${this.serviceEndpoint}${this.saveSchemaMethodName}`,s=e.addons?[...e.addons]:null,i=(0,A.omit)(e,["addons"]),l=this.httpClient.post(n,i);return this._errorHandler.handleRequest(l,this._restErrorHandleOptions).pipe((0,m.concatMap)(h=>{const g=s?.filter(_=>_.isChanged);return h.success&&g?.length>0?this._saveAddons(g).pipe((0,m.map)(_=>({...h,addonsErrors:_}))):(0,a.of)(h)}),(0,m.share)())}checkUniqueSchemaName(e,t,n){const s=this.serviceEndpoint+"CheckUniqueSchemaName",i={schemaName:e,excludeUId:t,managerName:n};return this.httpClient.post(s,i,{headers:new D.HttpHeaders({"Content-Type":"application/json"})}).pipe((0,m.share)())}static{this.\u0275fac=function(t){return new(t||_e)(d.\u0275\u0275inject(d.Injector))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:_e,factory:_e.\u0275fac,providedIn:"root"})}}class on{copy(e){return{...e}}isEmpty(e){return!1}}var Te=c(78868);class Ce{constructor(e){this.typeName="Terrasoft.Core.BusinessRules.Models.Conditions.BaseBusinessRuleDesignCondition",e?this.uId=e?.uId:this.uId=(0,S.qv)()}toMetadata(){return{typeName:this.typeName,uId:this.uId}}copy(){return new Ce({...this.toMetadata(),uId:(0,S.qv)()})}isValid(){return!!this.uId}onDataSourceAttributeNameChanged(e,t,n){}isAttributeUsed(e,t){return!1}getWarningMessages(){return[]}}class De extends Ce{}var Yn=c(7748),ze=c(6553),Ge;(function(r){r[r.None=0]="None",r[r.And=1]="And",r[r.Or=2]="Or"})(Ge||(Ge={}));var w=c(86464),K;(function(r){r[r.IsNull=0]="IsNull",r[r.IsNotNull=1]="IsNotNull",r[r.Equal=2]="Equal",r[r.NotEqual=3]="NotEqual",r[r.Less=5]="Less",r[r.LessOrEqual=6]="LessOrEqual",r[r.Greater=7]="Greater",r[r.GreaterOrEqual=8]="GreaterOrEqual",r[r.Contain=11]="Contain",r[r.NotContain=12]="NotContain"})(K||(K={}));var le=c(47149),qn=c(16091),rn=c(67706);class Re extends Ce{constructor(e){super(e),this._businessRuleDesignExpressionFactory=new qn.T,this.typeName="Terrasoft.Core.BusinessRules.Models.Conditions.BusinessRuleCondition",this.comparisonType=K.IsNull,e&&(e.leftExpression&&(this.leftExpression=this._businessRuleDesignExpressionFactory.get(e.leftExpression)),e.rightExpression&&(this.rightExpression=this._businessRuleDesignExpressionFactory.get(e.rightExpression)),e.comparisonType!=null&&(this.comparisonType=e.comparisonType))}toMetadata(){return{...super.toMetadata(),leftExpression:this.leftExpression?.toMetadata(),rightExpression:this.rightExpression?.toMetadata(),comparisonType:this.comparisonType}}copy(){const e=new Re({...this.toMetadata(),uId:(0,S.qv)()});return e.leftExpression=this.leftExpression?.copy(),e.rightExpression=this.rightExpression?.copy(),e}isValid(){if(!super.isValid()||this.comparisonType==null)return!1;const e=!!this.leftExpression?.isValid();switch(this.comparisonType){case K.IsNull:case K.IsNotNull:return e;case K.Equal:case K.NotEqual:return e&&!!this.rightExpression?.isValid();default:return!0}}onDataSourceAttributeNameChanged(e,t,n){this.leftExpression.onDataSourceAttributeNameChanged(e,t,n),this.rightExpression?.onDataSourceAttributeNameChanged(e,t,n)}_getAttributeExpressionWarningMessage(e){if(!e.dataValueTypeName)return null;const t=Object.values(le.Q).find(n=>n.name===e.dataValueTypeName)?.type;return t===w.r.MAXSIZE_TEXT?{message:"BusinessRules.Errors.MaxSizeInConditionLimitedWarningMessage",type:"warn"}:t===w.r.RICH_TEXT||t===w.r.Image?{message:"BusinessRules.Errors.NotSupportedInConditionTypesWarningMessage",type:"error"}:null}getWarningMessages(){const e=[];if(this.comparisonType===K.Equal||this.comparisonType===K.NotEqual){if(this.leftExpression instanceof rn.b){const t=this._getAttributeExpressionWarningMessage(this.leftExpression);t&&e.push(t)}if(this.rightExpression instanceof rn.b){const t=this._getAttributeExpressionWarningMessage(this.rightExpression);t&&e.push(t)}}return e}isAttributeUsed(e,t){return this.leftExpression?.isAttributeUsed(e,t)||this.rightExpression?.isAttributeUsed(e,t)}}class Ne extends Ce{constructor(e){super(e),this.typeName=ze.W,this.logicalOperation=Ge.And,this.conditions=[],e&&(this.logicalOperation=e.logicalOperation,this.conditions=e.conditions?.map(t=>t.typeName===ze.W?new Ne(t):new Re(t))??[])}_copyConditions(){return this.conditions.map(e=>e.copy())}toMetadata(){return{...super.toMetadata(),logicalOperation:this.logicalOperation,conditions:this.conditions.map(e=>e.toMetadata())}}copy(){const e=new Ne({...this.toMetadata(),uId:(0,S.qv)()});return e.conditions=this._copyConditions(),e}isValid(){return super.isValid()&&this.conditions?this.conditions.length===0?!0:this.conditions.every(t=>t.isValid()):!1}onDataSourceAttributeNameChanged(e,t,n){this.conditions.forEach(s=>s.onDataSourceAttributeNameChanged(e,t,n))}isAttributeUsed(e,t){return this.conditions.some(n=>n.isAttributeUsed(e,t))}getWarningMessages(){return this.conditions.map(e=>e.getWarningMessages()).flat()}}class es{get(e){return e.typeName===ze.W?new Ne(e):new Re(e)}}class we{get actions(){return Object.freeze(this._actions)}constructor(e){this._businessRuleDesignActionFactory=new Yn.J,this._businessRuleDesignConditionFactory=new es,this._typeName="Terrasoft.Core.BusinessRules.Models.BusinessRuleCase",this._actions=[],this.uId=e?.uId||(0,S.qv)(),e?.condition?this.condition=this._businessRuleDesignConditionFactory.get(e.condition):this.condition=new De,e?.actions?.forEach(t=>{this._actions.push(this._businessRuleDesignActionFactory.get(t))})}_getActionIndex(e){return this.actions.findIndex(t=>t.uId===e.uId)}_actionsUpdateMetadata(e){const t=[];e.actions.forEach(s=>{t.push(s.uId);const i=this._businessRuleDesignActionFactory.get(s);this._getActionIndex(i)!==-1?this.updateAction(i):this.addAction(i)}),this.actions.filter(s=>!t.includes(s.uId)).forEach(s=>this.deleteAction(s))}_getActionsMetadata(){return this.actions.map(e=>e.toMetadata())}_getConditionMetadata(){const e=this.condition;return e&&!(e instanceof De)?e.toMetadata():null}_copyActions(){return this.actions.map(e=>e.copy())}_setActions(e){this._actions=[...e]}_copyCondition(){const e=this.condition;return e&&!(e instanceof De)?e.copy():new De}toMetadata(){const e=this._getConditionMetadata(),t=this._getActionsMetadata();return{typeName:this._typeName,uId:this.uId,condition:e,actions:t}}updateFromMetadata(e){e.condition&&this.updateCondition(this._businessRuleDesignConditionFactory.get(e.condition)),this._actionsUpdateMetadata(e)}addAction(e){if(this._getActionIndex(e)!==-1){console.warn(`Action ${e.uId} already exists`);return}this._actions=[...this._actions,e.clone()]}updateAction(e){const t=this._getActionIndex(e);if(t===-1){console.warn(`Action ${e.uId} not found`);return}this._actions=[...this._actions],this._actions.splice(t,1,e.clone())}deleteAction(e){const t=this._getActionIndex(e);t<0||(this._actions=[...this._actions],this._actions.splice(t,1))}updateCondition(e){this.condition=e}copy(){const e=new we({...this.toMetadata(),uId:(0,S.qv)()});return e._setActions(this._copyActions()),e.condition=this._copyCondition(),e}onDataSourceAttributeNameChanged(e,t,n){this.condition.onDataSourceAttributeNameChanged(e,t,n),this._actions.forEach(s=>s.onDataSourceAttributeNameChanged(e,t,n))}isAttributeUsed(e,t){return this.condition.isAttributeUsed(e,t)||this._actions.some(n=>n.isAttributeUsed(e,t))}}var ts=c(92499);function ns(r,e){return Object.values(r).indexOf(e)}class Le{constructor(e){this._typeName="Terrasoft.Core.BusinessRules.Models.Trigger",this.name="",this.type=Te.T.ChangeAttributeValue,this.scopeId="",this.uId=e?.uId||(0,S.qv)(),e&&(this.name=e.name,this.type=Object.values(Te.T)[e.type||0],this.scopeId=e.scopeId)}toMetadata(){const e=ns(Te.T,this.type);return{typeName:this._typeName,uId:this.uId,name:this.name,type:e,scopeId:this.scopeId}}copy(){return new Le({...this.toMetadata(),uId:(0,S.qv)()})}isAttributeUsed(e,t){return this.name===t&&(0,ts.t4)(this.scopeId,e)}}class Ve{get hasWarnings(){return this.getWarningMessages().length>0}constructor(e,t,n,s,i){this.caption=t,this.schemaName=n,this.schemaCaption=s,this.applicabilityType=i,this._typeName="Terrasoft.Core.BusinessRules.BusinessRule",this.name="",this.enabled=!0,this.triggers=[],this.cases=[],this.needToSave=!1,this.parentUId="",this.parentActionUId="",this.uId=e.uId,this.updateFromMetadata(e)}_updateCase(e){const t=this.cases.find(n=>n.uId===e.uId);if(t){t.updateFromMetadata(e);return}this.addCase(new we(e))}_casesUpdateMetadata(e){const t=[];e.cases?.forEach(n=>{t.push(n.uId),this._updateCase(n)}),this.cases=this.cases.filter(n=>t.includes(n.uId))}_copyCases(){return this.cases?.map(e=>e.copy())}_copyTriggers(){return this.triggers?.map(e=>e.copy())}_isValidCaption(){return this.caption.some(e=>e.value)}addTrigger(e,t,n=""){const s=Object.values(Te.T).indexOf(t),i=new Le({name:e,type:s,scopeId:n});return this.triggers.push(i),i.uId}addCase(e){this.cases.push(e)}getFirstCase(){let e=this.cases[0];return e||(e=new we,this.addCase(e),this.getFirstCase())}updateFromMetadata(e){this.parentUId=e.parentUId??"",this.parentActionUId=e.parentActionUId??"",this.name=e.name,this.enabled=e.enabled,this._casesUpdateMetadata(e),this.triggers=e.triggers?.map(t=>new Le(t))??[]}toMetadata(){const e={typeName:this._typeName,uId:this.uId,cases:this.cases.map(t=>t.toMetadata()),triggers:this.triggers.map(t=>t.toMetadata()),name:this.name,enabled:this.enabled};return this.parentUId&&(e.parentUId=this.parentUId),this.parentActionUId&&(e.parentActionUId=this.parentActionUId),e}clone(){const e=new Ve(this.toMetadata(),this.caption.clone(),this.schemaName,this.schemaCaption,this.applicabilityType);return e.needToSave=this.needToSave,e}copy(){const e=this.caption.clone();e.forEach(n=>{n.value&&(n.value=`Copy ${n.value}`)});const t=new Ve({...this.toMetadata(),uId:(0,S.qv)()},e,this.schemaName,this.schemaCaption,this.applicabilityType);return t.name=H(),t.cases=this._copyCases(),t.triggers=this._copyTriggers(),t}isValid(){if(!this._isValidCaption())return!1;const t=this.getFirstCase(),n=t?.condition,s=t?.actions;return n?.isValid()&&s?.length>0&&s.every(i=>i.isValid())}showInvalid(){return this.needToSave?!this.isValid():!1}onDataSourceAttributeNameChanged(e,t,n){this.cases.forEach(s=>s.onDataSourceAttributeNameChanged(e,t,n))}getWarningMessages(){const e=[],n=this.getFirstCase()?.condition;return n&&e.push(...n.getWarningMessages()),e}isAttributeUsed(e,t){return this.cases.some(n=>n.isAttributeUsed(e,t))||this.triggers.some(n=>n.isAttributeUsed(e,t))}}var L=c(50588);class ss extends on{copy(e){const t=e.metadata,n=[],s=[];return t.rules.forEach(i=>{const l=new Ve(i,new L.h,null,null,null),{uId:p,name:h}=l,g=l.copy();g.name=h;const _=g.uId,V=(e.resources||[]).find(oe=>oe.key?.includes(p));if(V){const oe=V.key.replace(p,_);s.push({...V,key:oe})}n.push(g.toMetadata())}),{metadata:{...e.metadata,rules:n},name:e.name,resources:s}}isEmpty(e){return!e.metadata?.rules||e.metadata.rules?.length===0}}class fe{create(e){return e===W.BusinessRule?new ss:new on}static{this.\u0275fac=function(t){return new(t||fe)}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:fe,factory:fe.\u0275fac})}}class de{static{this.\u0275fac=function(t){return new(t||de)}}static{this.\u0275mod=d.\u0275\u0275defineNgModule({type:de})}static{this.\u0275inj=d.\u0275\u0275defineInjector({providers:[re,ce,fe],imports:[T.CommonModule]})}}(function(){(typeof ngJitMode>"u"||ngJitMode)&&d.\u0275\u0275setNgModuleScope(de,{imports:[T.CommonModule]})})();var ee=c(23092),is=c(82898),as=c(49973),os=c(34251),rs=c(36592),cs=c(65751);class ve{constructor(e){this._httpClient=e,this._appPackagesServiceUrl="ServiceModel/ApplicationPackagesService.svc/",this._getDesignPackageUId="GetDesignPackageUId"}getDesignPackageUId(e,t){const n=`${this._appPackagesServiceUrl}${this._getDesignPackageUId}`;return this._httpClient.post(n,{schemaUId:e,userLevelSchema:t})}static{this.\u0275fac=function(t){return new(t||ve)(d.\u0275\u0275inject(D.HttpClient))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:ve,factory:ve.\u0275fac,providedIn:"root"})}}class $e{constructor(e,t){this.name=e,this.uId=t}equal(e){return e==null?!1:this.uId===e.uId&&this.name===e.name&&this.type===e.type&&this.isChanged===e.isChanged&&this.isLocked===e.isLocked}clone(){const e=new $e(this.name,this.uId);return e.type=this.type,e.isChanged=this.isChanged,e.isLocked=this.isLocked,e}}class Se extends Array{constructor(e){super(),e&&Array.isArray(e)&&(this.push(...e.map(t=>t.clone())),this.uId=e.uId),this.uId=this.uId||(0,S.qv)()}deleteItemByUId(e){const t=this.findItemIndex(e);return t<0?!1:(this.splice(t,1),!0)}findItemIndex(e){return this.findIndex(t=>t.uId===e)}findItem(e){return this.find(t=>t.uId===e)}addItem(e){this.unshift(e)}reloadAll(e){this.splice(0,this.length,...e||[])}equal(e){return e==null||this.length!==e?.length?!1:this.every(t=>{const n=e?.findItem(t.uId);return t.equal(n)})}clone(){return new Se(this)}getLocalizableValues(e,t){this.forEach(n=>{const s={};n.getLocalizableValues(s),Object.entries(s).forEach(([i,l])=>{e[`${t}.${n.name}.${i}`]=l})})}loadLocalizableValues(e,t,n=!1){const s={};Object.entries(e).map(([i,l])=>{const p=i.split("."),h=p.shift(),g=p.shift(),_=p.join(".");return{itemGroupName:h,itemName:g,itemResourceName:_,values:l}}).filter(({itemGroupName:i})=>i===t).forEach(({itemName:i,itemResourceName:l,values:p})=>{const h=s[i]??{};h[l]=p,s[i]=h}),Object.entries(s).forEach(([i,l])=>{this.find(h=>h.name===i).loadLocalizableValues(l,n)})}}var ls=c(37827);class ds{constructor(e){this.factory=e}createSchema(e){const t=new this.factory;return Object.assign(t,e),e.package&&(t.package=new $e(e.package.name,e.package.uId),t.package.type=e.package.type,t.package.isChanged=e.package.isChanged,t.package.isLocked=e.package.isLocked),t}createLocalizableStrings(e){if(!e)return new Se;const t=e.map(n=>new ls.e(n));return new Se(t)}}var cn=c(44462),ln=c(63740);class us extends ln.p{constructor(e){if(super(e),this.isReadOnly=!1,this.useFullHierarchy=!1,this.userLevelSchema=!1,this.addonTypes=[],this.addons=[],e){if(this.id=e.id,e.package){const t=e.package;t.clone?this.package=t.clone():(this.package=new $e(t.name,t.uId),this.package.type=t.type,this.package.isChanged=t.isChanged,this.package.isLocked=t.isLocked)}if(this.body=e.body,this.isReadOnly=e.isReadOnly,this.useFullHierarchy=e.useFullHierarchy,this.parentSchema=e.parentSchema,this.extendParent=e.extendParent,e.dependencies){const t=e.dependencies;let n=t.requiredSchemas;n&&(n=[...n]);let s=t.requiredEntityColumns;s&&(s=s.map(i=>({entitySchemaName:i.entitySchemaName,columnPaths:[...i.columnPaths]}))),this.dependencies={requiredSchemas:n,requiredEntityColumns:s}}}}updateDescription(e){super.update(e),this.id=e.id,this.package=e.package}equal(e){if(e==null)return!1;let t=super.equal(e)&&this.id===e.id&&this.body===e.body&&this.isReadOnly===e.isReadOnly&&this.useFullHierarchy===e.useFullHierarchy;return(this.package||e.package)&&(t=t&&this.package?.equal(e.package)),t}getLocalizableValues(e){super.getLocalizableValues(e)}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t)}}class We extends us{constructor(e){super(e),this.caption=new L.h,this.localizableStrings=new Se,this.description=new L.h,e&&(this.caption=e.caption?e.caption.clone():e.caption,this.description=e.description?e.description.clone():e.description,this.localizableStrings=e.localizableStrings?e.localizableStrings.clone():e.localizableStrings)}get DefaultName(){return"BaseSchema"}findChildrenItem(e){return this.localizableStrings.findItem(e)}findGroup(e){return this.localizableStrings.uId===e?this.localizableStrings:null}updateDescription(e){super.updateDescription(e),this.caption=new L.h(e.caption),this.description=new L.h(e.description)}equal(e){return e==null?!1:super.equal(e)&&(0,cn.$n)(this.caption,e.caption,!0)&&(0,cn.$n)(this.description,e.description,!0)}clone(){return new We(this)}getLocalizableValues(e){super.getLocalizableValues(e),e.caption=this.caption.clone(),e.description=this.description.clone(),this.localizableStrings.getLocalizableValues(e,"localizableStrings")}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.caption.setValues(e.caption,t),this.description.setValues(e.description,t),this.localizableStrings.loadLocalizableValues(e,"localizableStrings",t)}getIsOwnMetaItem(e){return this.uId===e.parentSchemaUId}}class dn extends We{}class hs{constructor(){this.caption=new L.h,this.description=new L.h}}class ps extends ln.p{constructor(){super(...arguments),this.caption=new L.h}}var gs=c(57852);class te extends ds{constructor(e,t){super(dn),this._userInfo=e,this._resourceFinderService=t,this._sysCultureName=this._userInfo.cultureInfo.sysCultureName}_convertSchemaActionToDto(e,t){return t.actions?.map(n=>({Id:n.uid,Code:n.name,Intent:{value:e},ActionType:n.actionSchemaTypeUId,Name:this._resourceFinderService.findLocalizableValue(n.caption),Description:this._resourceFinderService.findLocalizableValue(n.description),Params:n.params,PackageUId:t.package.uId}))}_convertSchemaParametersToDto(e,t,n){return t.map(s=>({UId:s.uId,Intent:{value:e},Name:this._resourceFinderService.findLocalizableValue(s.caption),Code:s.name,Description:s.description,SourceCollection:n,DataValueTypeUId:s.dataValueTypeUId}))}_convertDtoActionToSchema(e,t){const n=e.actions||[],i=t.filter(h=>n.every(g=>g.uid!==h.Id)).map(h=>{const g=new hs;return g.uid=h.Id,g.name=h.Code,g.params=h.Params,g.actionSchemaTypeUId=h.ActionType,g.caption.setValueLocalizableString(this._sysCultureName,h.Name),g.description.setValueLocalizableString(this._sysCultureName,h.Description),g}),p=n.filter(h=>t.some(g=>g.Id===h.uid)).map(h=>{const g=t.find(_=>_.Id===h.uid);return h.name=g.Code,h.caption.setValueLocalizableString(this._sysCultureName,g.Name),h.description.setValueLocalizableString(this._sysCultureName,g.Description),h.params=g.Params,h.actionSchemaTypeUId=g.ActionType,h});e.actions=[...i,...p]}_convertDtoParametersToSchema(e,t,n){const s=e[t]||[],l=n.filter(g=>s.every(_=>_.uId!==g.UId)).map(g=>{const _=new ps;return _.uId=g.UId,_.name=g.Code,_.caption.setValueLocalizableString(this._sysCultureName,g.Name),_.description=g.Description,_.dataValueTypeUId=g.DataValueTypeUId,_}),h=s.filter(g=>n.some(_=>_.UId===g.uId)).map(g=>{const _=n.find(V=>V.UId===g.uId);return g.name=_.Code,g.caption.setValueLocalizableString(this._sysCultureName,_.Name),g.description=_.Description,g.dataValueTypeUId=_.DataValueTypeUId,g});e[t]=[...l,...h]}_mapActions(e){return e?.map(t=>(t.description=new L.h(t.description),t.caption=new L.h(t.caption),t))}_mapParameters(e){return e?.map(t=>(t.caption=new L.h(t.caption),t))}_convertDtoSubIntentsToSchema(e,t){const n=e.subIntents||[],i=t.filter(h=>n.every(g=>g.uId!==h.UId)).map(h=>{const g=new dn;return g.uId=h.UId,g.name=h.Code,g.description.setValueLocalizableString(this._sysCultureName,h.Description),g.caption.setValueLocalizableString(this._sysCultureName,h.Title),g}),p=n.filter(h=>t.some(g=>g.UId===h.uId)).map(h=>{const g=t.find(_=>_.UId===h.uId);return h.name=g.Code,h.description.setValueLocalizableString(this._sysCultureName,g.Description),h.caption.setValueLocalizableString(this._sysCultureName,g.Title),h});e.subIntents=[...i,...p]}_mapSubIntents(e){return e?.map(t=>(t.caption=new L.h(t.caption),t.description=new L.h(t.description),t))}_convertSchemaSubIntentsToDto(e){return e.subIntents?.map(t=>this.schemaToModel(t.uId,t))??[]}createSchema(e){const t=super.createSchema(e);return t.caption=new L.h(e.caption),t.description=new L.h(e.description),t.actions=this._mapActions(e.actions),t.inputParameters=this._mapParameters(e.inputParameters),t.outputParameters=this._mapParameters(e.outputParameters),t.subIntents=this._mapSubIntents(e.subIntents),t}convertToSchema(e){return this.createSchema(e)}mapModelToSchema(e,t){return e.prompt=t.Prompt,e.intentDescription=t.Description,e.caption.setValueLocalizableString(this._sysCultureName,t.Title),e.name=t.Code,e.status=t.Status,e.mode=t.Mode,e.type=t.Type,e.llmModel=t.LlmModel,e.restrictions=t.Restrictions,e.roleDescription=t.RoleDescription,this._convertDtoParametersToSchema(e,"inputParameters",t.InputParameters??[]),this._convertDtoParametersToSchema(e,"outputParameters",t.OutputParameters??[]),this._convertDtoActionToSchema(e,t.Actions),this._convertDtoSubIntentsToSchema(e,t.SubIntents??[]),e}schemaToModel(e,t){return{UId:e,Title:this._resourceFinderService.findLocalizableValue(t.caption),Code:t.name,Description:t.intentDescription||this._resourceFinderService.findLocalizableValue(t.description),Prompt:t.prompt,Status:t.status,Type:t.type,Actions:this._convertSchemaActionToDto(e,t),ExtendParent:t.extendParent,PackageUId:t.package?.uId,Mode:t.mode,LlmModel:t.llmModel,InputParameters:this._convertSchemaParametersToDto(e,t.inputParameters??[],"InputParameters"),OutputParameters:this._convertSchemaParametersToDto(e,t.outputParameters??[],"OutputParameters"),RoleDescription:t.roleDescription,Restrictions:t.restrictions,SubIntents:this._convertSchemaSubIntentsToDto(t)}}static{this.\u0275fac=function(t){return new(t||te)(d.\u0275\u0275inject(ee.oq),d.\u0275\u0275inject(gs.Q))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:te,factory:te.\u0275fac})}}function un(r,e,t){return r.post(e,t,{headers:new D.HttpHeaders({"Content-Type":"application/json"})})}class ne extends _e{constructor(e){super(e)}createSubIntent(e,t){const n=this.serviceEndpoint+"CreateSubIntent",s={parentIntentUId:e,subIntentUId:t};return un(this.httpClient,n,s)}deleteSubIntent(e,t){const n=this.serviceEndpoint+"DeleteSubIntent",s={parentIntentUId:e,subIntentUId:t};return un(this.httpClient,n,s)}static{this.\u0275fac=function(t){return new(t||ne)(d.\u0275\u0275inject(d.Injector))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:ne,factory:ne.\u0275fac})}}class ye extends os.${constructor(){super(),this._apiService=(0,d.inject)(ne),this._convertor=(0,d.inject)(te),this._currentPackageService=(0,d.inject)(ve),this._serverClientOperationNotificationReceiver=(0,d.inject)(rs.k),this._queryExecutor=(0,d.inject)(cs.w),this._copilotIntentChangedSubscribe()}_copilotIntentChangedSubscribe(){this._serverClientOperationNotificationReceiver.getNotifications("CopilotIntentChanged").subscribe(e=>this.setToCache(e.intentUId,this._getIntentSchema(e.intentUId)))}_normalizeUId(e){return e.toLocaleLowerCase()}_getIntentSchema(e){return this._apiService.getSchema({schemaUId:e,useFullHierarchy:!0}).pipe((0,a.map)(t=>{if(!t.success)throw new Error(t.errorInfo?.message||`Failed to get schema with UId: ${e}`);return t.schema}),(0,a.shareReplay)({bufferSize:1,refCount:!1}),(0,a.catchError)(t=>(0,a.throwError)(()=>t)))}setToCache(e,t){super.setToCache(this._normalizeUId(e),t)}getFromCache(e){return super.getFromCache(this._normalizeUId(e))}deleteFromCache(e){return super.deleteFromCache(this._normalizeUId(e))}get(e){let t=this.getFromCache(e);return t||(t=this._getIntentSchema(e),this.setToCache(e,t)),t.pipe((0,a.map)(n=>this._convertor.schemaToModel(e,n)))}getAllCodes(e){const t=new as.s(e);return t.addSchemaColumn("Code"),this._queryExecutor.executeSelectQuery(t).pipe((0,a.map)(n=>n.map(s=>String(s.Code))))}update(e){return this.getFromCache(e.UId).pipe((0,a.map)(t=>this._convertor.mapModelToSchema(t,e)),(0,a.switchMap)(t=>this._apiService.saveSchema(t)),(0,a.tap)(t=>{t.success||this.deleteFromCache(e.UId)}))}create(e){return this._currentPackageService.getDesignPackageUId(null).pipe((0,a.switchMap)(t=>this._apiService.createSchema({packageUId:t.uId,extendParent:!1,schemaUId:e})),(0,a.map)(t=>t.schema),(0,a.tap)(t=>this.setToCache(e,(0,a.of)(t))),(0,a.map)(t=>this._convertor.schemaToModel(e,t)))}createSubIntent(e,t){return this._apiService.createSubIntent(e,t).pipe((0,a.map)(n=>{if(!n.success)throw new Error(n.errorInfo?.message||`Failed to create SubIntent for IntentUId: ${e}`);return n}),(0,a.catchError)(n=>(0,a.throwError)(()=>n)))}deleteSubIntent(e,t){return this._apiService.deleteSubIntent(e,t).pipe((0,a.map)(n=>{if(!n.success)throw new Error(n.errorInfo?.message||`Failed to delete SubIntent for IntentUId: ${e}`);return n}),(0,a.catchError)(n=>(0,a.throwError)(()=>n)))}static{this.\u0275fac=function(t){return new(t||ye)}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:ye,factory:ye.\u0275fac})}}let Ie=class sn{static{this.\u0275fac=function(t){return new(t||sn)}}static{this.\u0275mod=d.\u0275\u0275defineNgModule({type:sn})}static{this.\u0275inj=d.\u0275\u0275defineInjector({providers:[{provide:is.p,useClass:ye},{provide:ne,useFactory:e=>{const t=d.Injector.create({name:"CopilotIntentSchemaDesignerApiInjector",parent:e,providers:[Zn("CopilotIntentSchemaDesignerService.svc"),{provide:P,useClass:te,deps:[ee.oq]},{provide:x,useValue:!0}]});return new ne(t)},deps:[d.Injector]},te],imports:[T.CommonModule,de]})}};Ie=(0,o.__decorate)([(0,R.g)({})],Ie),function(){(typeof ngJitMode>"u"||ngJitMode)&&d.\u0275\u0275setNgModuleScope(Ie,{imports:[T.CommonModule,de]})}();var hn=c(41833),ms=c(86897),_s=c(15505),J=c(10661);class ue{static{this.\u0275fac=function(t){return new(t||ue)}}static{this.\u0275mod=d.\u0275\u0275defineNgModule({type:ue})}static{this.\u0275inj=d.\u0275\u0275defineInjector({providers:[ms.W,_s.D,J.R],imports:[T.CommonModule,f.TranslateModule]})}}(function(){(typeof ngJitMode>"u"||ngJitMode)&&d.\u0275\u0275setNgModuleScope(ue,{imports:[T.CommonModule,f.TranslateModule]})})();var u=c(73308),pn=c(98093),gn=c(18872),j=c(59969),mn=c(71001),Cs=c(71830),fs=c(40203),vs=c(17679),Ss=c(32709),ys=c(59888),Ke;(function(r){r[r.None=0]="None",r[r.Module=1]="Module",r[r.EditViewModelSchema=2]="EditViewModelSchema",r[r.ModuleViewModelSchema=3]="ModuleViewModelSchema",r[r.DetailViewModelSchema=4]="DetailViewModelSchema",r[r.GridDetailViewModelSchema=5]="GridDetailViewModelSchema",r[r.EditControlsDetailViewModelSchema=6]="EditControlsDetailViewModelSchema",r[r.UnitTestModule=7]="UnitTestModule",r[r.GridEditDetailViewModelSchema=8]="GridEditDetailViewModelSchema",r[r.AngularSchema=9]="AngularSchema",r[r.MobileSchema=10]="MobileSchema"})(Ke||(Ke={}));class Me{constructor(){this._appInfoService=(0,d.inject)(ys.my),this._window=(0,d.inject)(j.ZP),this._lastSchemaVersion=null}_getLastSchemaVersion(){var e=this;return(0,u.A)(function*(){if(e._lastSchemaVersion!==null)return e._lastSchemaVersion;const t=yield(0,a.firstValueFrom)(e._appInfoService.loadSysValues());return e._lastSchemaVersion=t.freedomUiSchemaVersion,e._lastSchemaVersion})()}register(e,t){var n=this;return(0,u.A)(function*(){const s={schemaName:e,schemaUId:null,schemaCaption:null,parentSchemaName:null,packageName:null,extendParent:!1,parentSchemaUId:null,schemaVersion:yield n._getLastSchemaVersion(),dataSchemaDeps:[],type:Ke.AngularSchema},i={localizableImages:{},localizableStrings:{},parametersLocalizableStrings:{}};n._window.define(e,[],()=>t),n._window.define(e+"Structure",[],()=>s),n._window.define(e+"Resources",[],()=>i)})()}static{this.\u0275fac=function(t){return new(t||Me)}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:Me,factory:Me.\u0275fac,providedIn:"root"})}}var _n=c(51521),Is=c(76556);const Ms=["schemaContainer"];function As(r,e){if(r&1&&(d.\u0275\u0275elementStart(0,"div",8)(1,"mat-error"),d.\u0275\u0275text(2),d.\u0275\u0275elementEnd()()),r&2){const t=d.\u0275\u0275nextContext();d.\u0275\u0275advance(2),d.\u0275\u0275textInterpolate1(" ",t.schemaError," ")}}class Ae extends mn.P{constructor(){super(...arguments),this._schemaRegisterService=(0,d.inject)(Me),this._schemaComponentType=(0,d.inject)(vs.O),this._injectionContextService=(0,d.inject)(Ss.K),this._injector=(0,d.inject)(d.Injector)}_getConverter(e){var t=this;return(0,u.A)(function*(){const n=e+"ToFullConfig";if(!gn.c.has(n))return null;const s=gn.c.get(n);s.lazy&&(yield s.lazyModuleRef.loadAndBootstrap());const i=n,l=t._injectionContextService.createContext(i,t._injector);return s.instantiate(l)})()}_convertElementConfigToSchema(e){var t=this;return(0,u.A)(function*(){const n=yield t._getConverter(e.type),s=n?yield n.convert(e,null):e;return{viewConfigDiff:[{operation:"insert",name:j.$A.generateUnique("DynamicElement"),values:s}],viewModelConfigDiff:[{operation:"merge",path:[],values:{supportBusinessRules:!1}}]}})()}_renderSchema(e){const t=this.schemaContainerRef.createComponent(this._schemaComponentType);this._schemaComponent=t.instance,this._schemaComponent.schemaExceptionThrown?.pipe((0,m.take)(1)).subscribe(n=>{this.schemaError=n?.message,t.changeDetectorRef.markForCheck()}),this.schemaContainerRef.insert(t.hostView),this._schemaComponent.features={profile:!1,mask:{canShow:!1}},this._schemaComponent.schemaName=e}_onMessageChanged(){var e=this;return(0,u.A)(function*(){const t="ViewElementChatMessageSchema_"+e.message.id.replaceAll("-","_"),n=yield e._convertElementConfigToSchema(e.message.view.element);yield e._schemaRegisterService.register(t,n),e._renderSchema(t)})()}ngOnChanges(e){super.ngOnChanges(e),e.message?.currentValue&&this._onMessageChanged()}static{this.\u0275fac=(()=>{let e;return function(n){return(e||(e=d.\u0275\u0275getInheritedFactory(Ae)))(n||Ae)}})()}static{this.\u0275cmp=d.\u0275\u0275defineComponent({type:Ae,selectors:[["crt-view-element-chat-message"]],viewQuery:function(t,n){if(t&1&&d.\u0275\u0275viewQuery(Ms,7,d.ViewContainerRef),t&2){let s;d.\u0275\u0275queryRefresh(s=d.\u0275\u0275loadQuery())&&(n.schemaContainerRef=s.first)}},inputs:{message:"message"},standalone:!0,features:[d.\u0275\u0275InheritDefinitionFeature,d.\u0275\u0275NgOnChangesFeature,d.\u0275\u0275StandaloneFeature],decls:12,vars:8,consts:[["schemaContainer",""],[3,"message"],["crtLinkNavigation","","crtFullSizeImage",""],[1,"text-content"],[1,"schema-wrapper"],["class","schema-error","role","alert",4,"ngIf"],["toggleType","material",1,"setup-details-expansion-panel",3,"title","expanded"],[1,"setup-details-text"],["role","alert",1,"schema-error"]],template:function(t,n){t&1&&(d.\u0275\u0275elementStart(0,"crt-chat-base-message",1)(1,"div",2)(2,"markdown",3),d.\u0275\u0275text(3),d.\u0275\u0275elementEnd(),d.\u0275\u0275elementStart(4,"div",4),d.\u0275\u0275elementContainer(5,null,0),d.\u0275\u0275elementEnd(),d.\u0275\u0275template(7,As,3,1,"div",5),d.\u0275\u0275elementStart(8,"crt-expansion-panel",6),d.\u0275\u0275pipe(9,"translate"),d.\u0275\u0275elementStart(10,"markdown",7),d.\u0275\u0275text(11),d.\u0275\u0275elementEnd()()()()),t&2&&(d.\u0275\u0275property("message",n.message),d.\u0275\u0275advance(3),d.\u0275\u0275textInterpolate(n.message==null?null:n.message.view.description),d.\u0275\u0275advance(4),d.\u0275\u0275property("ngIf",n.schemaError),d.\u0275\u0275advance(),d.\u0275\u0275property("title",d.\u0275\u0275pipeBind1(9,6,"Copilot.ViewElementMessage.SetupDetailsCaption"))("expanded",!1),d.\u0275\u0275advance(3),d.\u0275\u0275textInterpolate(n.message==null?null:n.message.view.details))},dependencies:[T.CommonModule,T.NgIf,_n.MarkdownModule,_n.MarkdownComponent,Cs.A,mn.P,fs.D,Is.o,f.TranslateModule,f.TranslatePipe,pn.MatFormFieldModule,pn.MatError],styles:[".schema-wrapper[_ngcontent-%COMP%]{margin:12px 16px 0}.schema-error[_ngcontent-%COMP%], .setup-details-expansion-panel[_ngcontent-%COMP%]{margin:0 16px}.setup-details-text[_ngcontent-%COMP%]{margin:-16px 0}"],changeDetection:0})}}const Cn="CopilotChatInitMessagesSubscriptions",fn="NavigationStateIsLoading",Je="CurrentPageSchemaName",vn="CopilotIntents",Sn="CopilotIntentPageQuickLinks",Es="CopilotQuickActions",yn="viewElement";var Qe=c(22701),he=c(48594),B;(function(r){r.Assistant="assistant",r.User="user",r.System="system",r.Tool="tool"})(B||(B={}));var Fe;(function(r){r.Text="text",r.ViewElement="view-element"})(Fe||(Fe={}));class pe{static get photo(){return"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTAsMTdhNSw1LDAsMCwwLDQuMS0yLjE0VjE2YS45LjksMCwwLDAsMS44LDBWOGEuOS45LDAsMCwwLTEuOCwwVjkuMTRBNSw1LDAsMSwwLDEwLDE3Wm0wLTEuOEEzLjIsMy4yLDAsMSwwLDYuOCwxMiwzLjIsMy4yLDAsMCwwLDEwLDE1LjJaIiBmaWxsPSIjMGQyZTRlIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiLz48cGF0aCBkPSJNMTguOSw4YS45LjksMCwwLDAtMS44LDB2OGEuOS45LDAsMCwwLDEuOCwwWiIgZmlsbD0iIzBkMmU0ZSIvPjwvc3ZnPg"}static get title(){return"Creatio.ai"}static get contact(){return{photo:this.photo,name:this.title}}}class Q{constructor(){this._fileMessageRegex=/#FileId\s+(\S+);.*?#FileName\s+([^;]+);/}_getAuthorByRole(e){return e.role!==B.Assistant&&e.role!==B.Tool?null:e.rootIntentCaption?{id:e.rootIntentId,name:e.rootIntentCaption}:pe.contact}_getIsBotMessage(e){return e===B.Assistant}_getMessageDirection(e){return e===B.User?he.Tt.Outcoming:he.Tt.Incoming}_getIsFileMessage(e){return e.role===B.System&&this._fileMessageRegex.test(e.content)}_getMessage(e,t){const s=e.createdOnTicks-621355968e9,i=Number(s/1e4);return{text:e.content,type:Qe.X.Text,date:new Date(i),id:e.id,author:this._getAuthorByRole(e),isBotMessage:this._getIsBotMessage(e.role),direction:this._getMessageDirection(e.role)}}_getFileMessage(e,t){const[,n,s]=e.content.match(this._fileMessageRegex);return{...this._getMessage(e,t),type:Qe.X.File,direction:he.Tt.Outcoming,text:"",attachments:[{fileId:n,fileName:s,fileType:he.Go.File,fileEntitySchemaName:"CreatioAISessionFile"}]}}_getIsSupportedMessage(e){return!(0,A.isEmpty)(e.content)&&(e.role===B.Assistant||e.role===B.User||e.forwardToClient||e.isFileMessage)}_isViewElementMessage(e){return e.contentType===Fe.ViewElement?!0:e.content?.includes("##viewElement##")}_getViewElementMessage(e,t){let n;return e.contentType===Fe.ViewElement&&(n=JSON.parse(e.content)),{...this._getMessage(e,t),author:this._getAuthorByRole(e),isBotMessage:!0,type:yn,view:n}}_extendCopilotMessage(e){return{...e,isFileMessage:this._getIsFileMessage(e),isViewElementMessage:this._isViewElementMessage(e)}}convertMessages(e,t){return e.map(n=>this._extendCopilotMessage(n)).filter(this._getIsSupportedMessage).map(n=>n.isViewElementMessage?this._getViewElementMessage(n,t):n.isFileMessage?this._getFileMessage(n,t):this._getMessage(n,t))}static{this.\u0275fac=function(t){return new(t||Q)}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:Q,factory:Q.\u0275fac})}}var Ue=c(4164);let Xe=class{constructor(e){this._intentSchemaManager=e}convert(e,t,n){var s=this;return(0,u.A)(function*(){const i=e.map(function(){var p=(0,u.A)(function*(h){return yield h[n]});return function(h){return p.apply(this,arguments)}}()),l=yield Promise.all(i);return(0,a.lastValueFrom)(s._intentSchemaManager.generateActionCode(l))})()}};Xe=(0,o.__decorate)([(0,Ue.a)({type:"crt.GenerateCopilotActionCode"}),(0,o.__metadata)("design:paramtypes",[J.R])],Xe);let Ze=class{constructor(e){this._intentSchemaManager=e}convert(e,t,n){var s=this;return(0,u.A)(function*(){const i=e.map(function(){var p=(0,u.A)(function*(h){return yield h[n]});return function(h){return p.apply(this,arguments)}}()),l=yield Promise.all(i);return(0,a.lastValueFrom)(s._intentSchemaManager.generateSkillCode(l))})()}};Ze=(0,o.__decorate)([(0,Ue.a)({type:"crt.GenerateCopilotSkillCode"}),(0,o.__metadata)("design:paramtypes",[J.R])],Ze);let Ye=class{convert(e,t,n){const[s,i]=e;return s||(n?!i:i)}};Ye=(0,o.__decorate)([(0,Ue.a)({type:"crt.CopilotChatMode"})],Ye);let qe=class{convert(e){return e?.map(n=>n).sort((n,s)=>{const i=typeof n.date=="string"?new Date(n.date):n.date,l=typeof s.date=="string"?new Date(s.date):s.date;return!i||!l?0:l.getTime()-i.getTime()})}};qe=(0,o.__decorate)([(0,Ue.a)({type:"crt.CopilotChatListConverter"})],qe);var X=c(81517),z=c(2828),y=c(41287),C=c(844);let In=class extends X.S{};In=(0,o.__decorate)([(0,z.$)({type:"crt.CodeChangeParameterListRequest",scopes:["AISkills_FormPage"]})],In);let et=class extends y.l{constructor(){super(...arguments),this._windowCodeList="_copilotCodeList"}_extractKeys(e,t){return(0,u.A)(function*(){if(!e||e.length===0)return[];const n=e.map(function(){var s=(0,u.A)(function*(i){return yield i?.[t]});return function(i){return s.apply(this,arguments)}}());return Promise.all(n)})()}handle(e){var t=this;return(0,u.A)(function*(){const n=e.$context,s=yield n?.InputParametersDetail,i=yield n?.OutputParametersDetail,l=[...yield t._extractKeys(s,"InputParametersDS_Code"),...yield t._extractKeys(i,"OutputParametersDS_Code")];if(l.length===0){yield t.next?.handle(e);return}window[t._windowCodeList]=l,yield t.next?.handle(e)})()}};et=(0,o.__decorate)([(0,C.l)({type:"crt.CodeChangeParameterListHandler",requestType:"crt.CodeChangeParameterListRequest",scopes:["AISkills_FormPage"]})],et);var xs=c(60575);class G{constructor(e){this._googleTagManager=e}_isCreatioPageContextPart(e){return e&&typeof e=="object"&&"pageSchemaName"in e&&typeof e.pageSchemaName=="string"}_getPageContextGTM(){var e=this;return(0,u.A)(function*(){try{return(yield M.d.instance.getContext()).filter(e._isCreatioPageContextPart).map(s=>s.pageSchemaName).join(", ")||null}catch(t){return console.error("Error processing copilot context:",t),null}})()}sendGTMData(e){var t=this;return(0,u.A)(function*(){const n=yield t._getPageContextGTM(),s=Object.assign(e,{moduleName:"Creatio.AI",schemaName:"CopilotPanel",eventName:"CreatioAI_Engagement",source:n||""});t._googleTagManager.track(s)})()}static{this.\u0275fac=function(t){return new(t||G)(d.\u0275\u0275inject(xs.A))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:G,factory:G.\u0275fac,providedIn:"root"})}}var Mn=c(18357),An=c(97398),En=c(13161);class Ee{constructor(e){this._window=e}postMessage(e){this._window.parent.postMessage(e,"*")}message$(){return(0,a.fromEvent)(this._window,"message").pipe((0,a.filter)(e=>e.data&&typeof e.data.type=="string"&&"payload"in e.data))}static{this.\u0275fac=function(t){return new(t||Ee)(d.\u0275\u0275inject(j.ZP))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:Ee,factory:Ee.\u0275fac,providedIn:"root"})}}var xe=c(20555);const Ps="embedded";function bs(){return window.parent===window?!1:new URLSearchParams(window.location.search).has(Ps)}class xn{static{this._errorCodeGroups={AuthorizationError:["MissingApiKey","InvalidApiKey","Unauthorized","UnauthorizedClient","InvalidScope","InvalidGrantType"],FormatError:["InvalidRequest","InvalidJson","NoEntities"],LimitError:["RateLimitReached","InsufficientQuota","QuotaExceeded","InternalQuotaExceeded","LimitExceeded"],ServiceAvailabilityError:["ServiceUnavailable","ServerNotAvailable","EngineOverloaded","ServerError","RequestTimeout","NetworkError"],ExecutionError:["ActionExecutionFailed","InvalidResponse"],ConfigurationError:["InvalidUri","ModelNotFound","ModelError","IncorrectConfiguration"],UnknownError:["Unknown","UnknownError"]}}static{this.singleErrors=["CharacterLimitExceededError","ToolCallsInvokesLimitExceeded","InsufficientPermissions"]}static{this.errorCodeToGroup=this._populateErrorCodeToGroupMap()}static _populateErrorCodeToGroupMap(){const e={};return Object.keys(this._errorCodeGroups).forEach(t=>{for(const n of this._errorCodeGroups[t])e[n]=t}),e}static getErrorMessageKey(e){return this.singleErrors.includes(e)?`MessageEditor.ErrorCode.${e}`:`MessageEditor.ErrorCode.${this.errorCodeToGroup[e]||"UnknownError"}`}}var k;(function(r){r.WaitingForUserMessage="WaitingForUserMessage",r.UserMessageQueued="UserMessageQueued",r.ExecutingAction="ExecutingAction",r.WaitingForAssistantMessage="WaitingForAssistantMessage",r.TitleUpdated="TitleUpdated"})(k||(k={}));var Ts=c(5240),Ds=c(72572),Rs=c(92385);const Pn="CopilotMsgChannelSender",Ns="CopilotChatPart",ws="CopilotSessionProgress";class F{constructor(e,t,n,s,i,l,p,h,g){this._userInfo=e,this._httpClient=t,this._translateService=n,this._messageChannelService=s,this.liveEditingService=i,this._featureValues=l,this._liveAnnouncementService=p,this._copilotContentUtils=h,this._copilotGtmService=g,this._apiUrl="/rest/CopilotService",this._copilotSession=null,this._copilotSessionProgress$=new a.Subject,this._defaultPageSize=15;const _=this._featureValues??{};this._isNeedToAddConsoleLog=!!_.ShowSystemMessagesFromCopilot}_copilotSessionProgressEvent$(){return this._messageChannelService.messageEvent$.pipe((0,a.filter)(e=>e.header.sender===Pn&&e.header.bodyTypeName===ws),(0,a.map)(e=>e.body))}_logCopilot(e){this._isNeedToAddConsoleLog&&(console.group("Copilot"),console.log(e),console.groupEnd())}_loadInitialMessages(){return this._getActiveCopilotSessions().pipe((0,a.mergeMap)(e=>this._handleActiveCopilotSessions(e).pipe((0,a.catchError)(t=>(console.log(t),(0,a.of)([]))))))}_handleActiveCopilotSessions(e){return e.length>0?(this._copilotSession=e[0],this.getCopilotSessionMessages(this._copilotSession.id)):(0,a.throwError)(()=>new Error("No active copilot sessions found"))}_getActiveCopilotSessions(){return this._httpClient.post(`${this._apiUrl}/GetActiveCopilotSessions`,{}).pipe((0,a.map)(e=>e.copilotSessions))}_notifyCopilotSessionProgress(e){this._copilotSessionProgress$.next({copilotSessionId:this._copilotSession?.id,state:e})}_sendUserMessage(e,t=void 0,n={rootIntentIds:[]}){const s=performance.now();return(0,a.of)(k.UserMessageQueued).pipe((0,a.tap)(i=>this._notifyCopilotSessionProgress(i)),(0,a.switchMap)(()=>M.d.instance.getContext()),(0,a.switchMap)(i=>this._httpClient.post(`${this._apiUrl}/SendMessage`,{content:e,copilotContext:JSON.stringify(i||[]),copilotSessionId:t,options:n})),(0,a.map)(i=>i?.copilotChatPart),(0,a.tap)(()=>{const i=performance.now(),l={action:"response_received",responseTime:Math.floor(i-s),primaryColumnValue:t};this._copilotGtmService.sendGTMData(l)}),(0,a.catchError)(i=>(0,a.of)({errorCode:"unknown",errorMessage:`${i}`,copilotSession:this._copilotSession,messages:[]})),(0,a.tap)(i=>{(0,A.isEmpty)(i?.errorMessage)||this._notifyCopilotSessionProgress(k.WaitingForUserMessage)}))}_getMentionAgents(e){const t=document.createElement("div");return t.innerHTML=e,Array.from(t.querySelectorAll(".mention")).map(n=>n.getAttribute("data-mention")).filter(n=>!!n)}_closeCopilotSession(){return this._httpClient.post(`${this._apiUrl}/CloseSession`,{copilotSessionId:this._copilotSession?.id}).pipe((0,a.catchError)(e=>(0,a.throwError)(()=>new Error(`Server return status: ${e.status}`))))}_getCachedRowCount(e){try{const t=window.sessionStorage.getItem(`${e}_rows`);return t?parseInt(t,10):void 0}catch{return}}_setCachedRowCount(e,t){try{window.sessionStorage.setItem(`${e}_rows`,t.toString())}catch{}}mapSessions(e){return(!e.author?.id||e.author.id===S.To)&&(e.author=pe.contact),e.caption=e.caption||this._translateService.instant("Copilot.NewChatCaption"),e}getInitialMessages$(){return this._loadInitialMessages()}copilotSessionEvent$(e){return(0,a.merge)(this.copilotMessageEvent$().pipe((0,a.map)(t=>({lastMessage:e.convertMessages(t.messages,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId})?.slice().sort((i,l)=>l.date.getTime()-i.date.getTime())?.[0],sessionId:t.copilotSession?.id})),(0,a.filter)(t=>!!t.lastMessage),(0,a.map)(t=>({id:t.sessionId,date:t.lastMessage.date,preview:this._copilotContentUtils.getPreview(t.sessionId,t.lastMessage.text,t.lastMessage.isBotMessage),previewFromServer:this._copilotContentUtils.toPlainText(t.lastMessage.text),author:t.lastMessage.author}))),this.copilotSessionProgressEvent$().pipe((0,a.filter)(t=>t.state===k.TitleUpdated),(0,a.map)(t=>({id:t.copilotSessionId,caption:t.copilotSessionTitle}))))}copilotMessageEvent$(){return this._messageChannelService.messageEvent$.pipe((0,a.filter)(e=>e.header.sender===Pn&&e.header.bodyTypeName===Ns),(0,a.map)(e=>e.body),(0,a.tap)(e=>this._logCopilot(e)))}copilotSessionProgressEvent$(){return(0,a.merge)(this._copilotSessionProgressEvent$(),this._copilotSessionProgress$.asObservable()).pipe((0,a.tap)(e=>this._logCopilot(e)))}sessionUpdateEvent$(){return this.liveEditingService.liveEditingEvent$.pipe((0,a.filter)(e=>e.entitySchemaName==="CopilotSessionEnt"))}sayWithResponse(e){return this.sayToSessionWithResponse(e,this._copilotSession?.id)}sayToSessionWithResponse(e,t){var n=this;return(0,u.A)(function*(){const i={rootIntentIds:n._getMentionAgents(e)},l=n._copilotContentUtils.sanitizeContent(e),p=yield(0,a.firstValueFrom)(n._sendUserMessage(l,t,i));return p&&(0,A.isEmpty)(p.errorCode)&&(0,A.isEmpty)(p.errorMessage)&&(n._copilotSession=p.copilotSession,n._liveAnnouncementService.announce("Copilot.MessageSent")),p})()}closeSession(){var e=this;return(0,u.A)(function*(){if(!e._copilotSession?.id)return Promise.reject(new Error("No active session"));try{yield(0,a.firstValueFrom)(e._closeCopilotSession()),e._copilotSession=null}catch(t){return Promise.reject(new Error(`Server return status: ${t.status}`))}})()}renameSession(e,t){return this._httpClient.post(`${this._apiUrl}/RenameSession`,{copilotSessionId:e,sessionName:t}).pipe((0,a.map)(n=>n.RenameSessionResult))}getActiveSessionPreviewById(e){return this._httpClient.get(`${this._apiUrl}/GetActiveSessionPreviewById/${e}`).pipe((0,a.filter)(t=>!!t),(0,a.map)(t=>({...t,author:{id:t.author.id,name:t.author?.caption||t.author?.name},preview:this._copilotContentUtils.getPreview(t.id,t.preview,t.author?.id!==this._userInfo.contactId),previewFromServer:this._copilotContentUtils.toPlainText(t.preview)})))}getActiveSessionsWithPreview(e=0,t=15,n=""){return this._httpClient.post(`${this._apiUrl}/SearchSessionsPageWithPreview`,{count:t,offset:e,search:n}).pipe((0,a.map)(s=>s.map(i=>({...i,author:{id:i.author?.id,name:i.author?.caption||i.author?.name},preview:this._copilotContentUtils.getPreview(i.id,i.preview,this._userInfo.contactId!==i.author?.id),previewFromServer:this._copilotContentUtils.toPlainText(i.preview)}))))}getCopilotSessionMessages(e){return this._httpClient.post(`${this._apiUrl}/GetCopilotSessionMessage`,{copilotSessionId:e}).pipe((0,a.map)(t=>t.copilotMessages))}getCopilotSessionMessagesPagination(e,t=0,n=15,s=!1){n=n||this._defaultPageSize,t=t||0;const i=this._getCachedRowCount(e);return s?i!==void 0&&(n=Math.max(i,this._defaultPageSize)):this._setCachedRowCount(e,n),this._httpClient.get(`${this._apiUrl}/getCopilotSessionMessages/?sessionId=${e}&offset=${t}&rowCount=${n}`).pipe((0,a.map)(l=>(this._setCachedRowCount(e,t+l?.copilotMessages?.length),l.copilotMessages)))}getCopilotSearchMessagesBatch(e,t){return this._httpClient.post(`${this._apiUrl}/GetCopilotSearchMessagesBatch`,{copilotSessionId:e,searchMessageId:t}).pipe((0,a.map)(n=>(this._setCachedRowCount(e,n?.copilotMessages?.length),n.copilotMessages)))}static{this.\u0275fac=function(t){return new(t||F)(d.\u0275\u0275inject(ee.oq),d.\u0275\u0275inject(D.HttpClient),d.\u0275\u0275inject(f.TranslateService),d.\u0275\u0275inject(Ts.A),d.\u0275\u0275inject(Ds.m),d.\u0275\u0275inject(O.G,8),d.\u0275\u0275inject(j.DW),d.\u0275\u0275inject(Rs.$),d.\u0275\u0275inject(G))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:F,factory:F.\u0275fac,providedIn:"root"})}}var tt=c(6503);class se{constructor(e,t,n,s){this._copilotChatService=e,this._notifyService=t,this._translateService=n,this._copilotGtmService=s}_getCurrentUserTime(){return new Date().getTime()*1e4+621355968e9}_sendErrorMessageToChat(e,t){var n=this;return(0,u.A)(function*(){if(!e)return;const s=xn.getErrorMessageKey(t??""),i={id:(0,S.qv)(),createdOnTicks:n._getCurrentUserTime(),content:n._translateService.instant(s),role:B.Assistant,isSaved:!0};e?.messages?.push(i)})()}_notifyUser(e){var t=this;return(0,u.A)(function*(){const n=xn.getErrorMessageKey(e??"");yield t._notifyService.error({message:n})})()}getInitialMessages$(){return this._copilotChatService.getInitialMessages$()}copilotMessageEvent$(){return this._copilotChatService.copilotMessageEvent$()}copilotSessionProgressEvent$(){return this._copilotChatService.copilotSessionProgressEvent$()}closeSession(){return this._copilotChatService.closeSession()}sayWithResponse(e){var t=this;return(0,u.A)(function*(){let n;try{n=yield t._copilotChatService.sayWithResponse(e);const s=n?.errorCode;return s&&(yield t._sendErrorMessageToChat(n,s),yield t._notifyUser(s)),n}catch(s){yield t._notifyUser(),console.error(s)}})()}sayToSessionWithResponse(e,t){var n=this;return(0,u.A)(function*(){let s;try{s=yield n._copilotChatService.sayToSessionWithResponse(e,t);const i=s?.errorCode;return i&&(yield n._sendErrorMessageToChat(s,i),yield n._notifyUser(i),yield n._copilotGtmService.sendGTMData({action:"error_received",description:i})),s}catch(i){yield n._notifyUser(),console.error(i)}})()}static{this.\u0275fac=function(t){return new(t||se)(d.\u0275\u0275inject(F),d.\u0275\u0275inject(tt.F),d.\u0275\u0275inject(f.TranslateService),d.\u0275\u0275inject(G))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:se,factory:se.\u0275fac,providedIn:"root"})}}class Ls extends y.l{constructor(e){super(),this._sidebarStateService=e.get(An.p),this._copilotChatService=e.get(se),this._profileService=e.get(Mn.c),this._customEventService=e.get(j.Dj),this._iframeMessengerService=e.get(Ee)}_getChatPanelProfileData(){var e=this;return(0,u.A)(function*(){return yield(0,a.firstValueFrom)(e._profileService.getProfile(En.j))})()}_getChatSessionId(){var e=this;return(0,u.A)(function*(){const t=yield e._getChatPanelProfileData(),n=yield(0,a.firstValueFrom)(e._sidebarStateService.opened.rootSidebar$);return t&&!t.isChatsListVisible&&n===xe.b?t.lastChatId:null})()}handle(e){var t=this;return(0,u.A)(function*(){const n=e;let s;n.useCurrentSession?(e.$context.CurrentCopilotSessionId=(yield e.$context.CurrentCopilotSessionId)??(0,S.qv)(),s=yield e.$context.CurrentCopilotSessionId):s=yield t._getChatSessionId(),yield t._sidebarStateService.openRootSidebar(xe.b);const i=yield t._copilotChatService.sayToSessionWithResponse(n.prompt,s);return!s&&i?.copilotSession&&t._customEventService.createOutboundChannel(xe.k).next(i.copilotSession.id),bs()&&!i?.errorCode&&t._iframeMessengerService.postMessage({type:"copilot-prompt-sent",payload:{promptCode:n.promptCode}}),i})()}}let nt=class extends Ls{constructor(e){super(e),this._copilotGtmService=e.get(G)}_sendGTMData(e){var t=this;return(0,u.A)(function*(){const n={action:"skill_button_clicked",description:e.promptCode};yield t._copilotGtmService.sendGTMData(n)})()}handle(e){var t=()=>super.handle,n=this;return(0,u.A)(function*(){yield t().call(n,e),yield n._sendGTMData(e),yield n.next?.handle(e)})()}};nt=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotActionRequestHandler",requestType:"crt.CopilotActionRequest"}),(0,o.__metadata)("design:paramtypes",[d.Injector])],nt);class Z{constructor(e){this._httpClient=e,this._executeIntentUrl="/rest/CopilotService/ExecuteIntent",this._getAvailableIntentsUrl="/rest/CopilotService/GetAvailableIntents",this._getAvailableAgentsUrl="/rest/CopilotService/GetAvailableAgents",this._agents$=null}_initializeAgents(){this._agents$=this._httpClient.get(this._getAvailableAgentsUrl).pipe((0,a.shareReplay)({bufferSize:1,refCount:!0}),(0,m.catchError)(e=>(0,a.throwError)(()=>new Error(`Server return status: ${e.status}`))))}_transformInputParameters(e){return e?Object.entries(e).map(([t,n])=>({Key:t,Value:n||""})):[]}_transformOutputParameters(e){return e?e.reduce((t,n)=>(t[n.Key]=n.Value,t),{}):null}_executeIntent(e,t,n){const s=this._transformInputParameters(n),i={intentName:e,additionalPromptText:t,parameters:s};return this._httpClient.post(this._executeIntentUrl,i).pipe((0,a.map)(l=>(l.isSuccess&&(l.resultParameters=this._transformOutputParameters(l.resultParameters)),l)),(0,m.catchError)(l=>(0,a.throwError)(()=>new Error(`Server return status: ${l.status}`))))}_getAvailableIntents(e,t){const n={names:e},s=this._getAvailableIntentsUrl+`/?mode=${t}`;return this._httpClient.post(s,n).pipe((0,m.catchError)(i=>(0,a.throwError)(()=>new Error(`Server return status: ${i.status}`))))}executeIntent(e,t,n){var s=this;return(0,u.A)(function*(){try{return yield(0,a.firstValueFrom)(s._executeIntent(e,t,n))}catch(i){const l=i.status?`Server return status: ${i.status}`:`${i}`;return Promise.reject(l)}})()}getAvailableIntents(e,t){var n=this;return(0,u.A)(function*(){t||(t="API");try{return yield(0,a.firstValueFrom)(n._getAvailableIntents(e,t))}catch(s){const i=s.status?`Server return status: ${s.status}`:`${s}`;return Promise.reject(i)}})()}getAvailableAgents(){var e=this;return(0,u.A)(function*(){if(e._agents$||e._initializeAgents(),!e._agents$)throw new Error("Agents could not be initialized");try{return yield(0,a.firstValueFrom)(e._agents$)}catch(t){const n=t.status?`Server return status: ${t.status}`:`${t}`;return Promise.reject(n)}})()}static{this.\u0275fac=function(t){return new(t||Z)(d.\u0275\u0275inject(D.HttpClient))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:Z,factory:Z.\u0275fac,providedIn:"root"})}}let st=class extends y.l{constructor(e){super(),this._watchAttributes=[Je,vn,Sn],this._runMode="Chat",this._copilotService=e.get(Z)}_actualizeCopilotQuickActions(e){var t=this;return(0,u.A)(function*(){const n=yield e[Es],s=(yield e[vn])??[],i=yield e[Sn];if(!Array.isArray(s)||s.length===0||!Array.isArray(i)||i.length===0)return;yield n.clear();const l=yield e[Je];let h=(yield Promise.all(i.map(function(){var _=(0,u.A)(function*(V){return{pageName:yield V.PageName,intentCode:yield V.IntentCode}});return function(V){return _.apply(this,arguments)}}()))).filter(_=>t._isPatternMatch(_.pageName,l)).map(_=>_.intentCode);h.length>0&&(h=(yield t._copilotService.getAvailableIntents(h,t._runMode))?.availableIntentNames??[]);const g=[];for(const _ of s){const V=yield _.Code;t._hasMatchingPattern(h,V)&&g.push(_)}yield n.reload(g)})()}_hasMatchingPattern(e,t){return e.some(n=>this._isPatternMatch(n,t))}_isPatternMatch(e,t){t=`${t}`.trim().toLowerCase(),e=`${e}`.trim().toLowerCase();const[n]=e.split("*").filter(Boolean);return e==="*"?!0:e.startsWith("*")?t.endsWith(n):e.endsWith("*")?t.startsWith(n):e===t}handle(e){var t=this;return(0,u.A)(function*(){const n=e.$context;if(t._watchAttributes.includes(e.attributeName))return yield t._actualizeCopilotQuickActions(n),t.next?.handle(e)})()}};st=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotActualizeIntentQuickLinksHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["CopilotPanel"]}),(0,o.__metadata)("design:paramtypes",[d.Injector])],st);var U=c(91775),bn=c(40968);class Pe{constructor(){this._pageChange$=new a.BehaviorSubject(void 0)}pageChangeEvent$(){return this._pageChange$.asObservable()}setPage(e){this._pageChange$.next(e)}static{this.\u0275fac=function(t){return new(t||Pe)}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:Pe,factory:Pe.\u0275fac,providedIn:"root"})}}var Vs=c(97842),$s=c(38641),ie=c(29957);let it=class extends y.l{constructor(e,t,n,s,i,l,p,h){super(),this._copilotChatService=e,this._aiChatPageContextService=t,this._crtRouter=n,this._userInfo=s,this._injector=i,this._featureValues=l,this._liveAnnouncementService=p,this._translationService=h,this.userConsentService=i.get(v.F),this._copilotToChatConvertor=i.get(Q)}_openNewConversation(e,t){return(0,u.A)(function*(){const n={type:"crt.CopilotNewChatRequest",scopes:t.scopes,$context:e};yield U.t.instance.process(n)})()}_openConversation(e,t){return(0,u.A)(function*(){const n={type:"crt.ChatSessionOpenRequest",session:{id:(yield e.CurrentCopilotSessionId)??S.To},scopes:t.scopes,$context:e};yield U.t.instance.process(n)})()}_getConvertedMessages(e){return this._copilotToChatConvertor.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId})}_initUserConsentData(e){this.userConsentService.getConsent("CopilotLegalNotice").subscribe(t=>{t&&(e.CopilotDisclaimer=t.consentText,this.userConsentService.getUserConsent(t.id).subscribe(n=>{e.IsCopilotChatVisible=n!==null,e.IsCopilotDisclaimerVisible=n===null}))})}_initWatchNavigation(e){var t=this;return(0,u.A)(function*(){const n=t._crtRouter.navigateStart$.pipe((0,a.tap)(()=>e[fn]=!0)).subscribe(),s=t._crtRouter.navigateEnd$.pipe((0,a.tap)((0,u.A)(function*(){e[fn]=!1;const i=yield(0,a.firstValueFrom)(t._crtRouter.crtRoute$);(i?.state?.moduleName||i?.state?.schemaName)&&t._aiChatPageContextService.setPage(i?.state?.schemaName)}))).subscribe();t._aiChatPageContextService.pageChangeEvent$().subscribe(i=>{e[Je]=i}),yield t._addToSubscriptions(e,[n,s])})()}_onSessionProgressEvent(e,t){var n=this;return(0,u.A)(function*(){const s=e?.copilotSessionId;s&&(yield n._updateSessionTypingStatus(s,e,t))})()}_onMessageEvent(e,t){var n=this;(0,u.A)(function*(){try{if(e.copilotSession?.id===(yield t.$context.CurrentCopilotSessionId)){const s=Array.isArray(yield t.$context.ChatMessages)?yield t.$context.ChatMessages:[],i=new Set(s.map(h=>h.id)),l=n._getConvertedMessages(e.messages),p=l.filter(h=>!i.has(h.id));t.$context.ChatMessages=[...s,...p],yield n._announceMessagesInCurrentChat(l)}else yield n._announceMessagesInAnotherChat(e,t)}catch(s){console.error("Error processing messages:",s)}})()}_announceMessagesInAnotherChat(e,t){var n=this;return(0,u.A)(function*(){const s=n._translationService.instant("Copilot.LiveAnnouncement.MessageReceivedInAnotherChat"),i=((yield t.$context.ActiveChats)||[]).find(l=>l.id===e.copilotSession.id);if(i){yield new Promise(p=>setTimeout(p,0));const l=ie.String.format(s,e.messages[0].rootIntentCaption||pe.title,i.caption);yield n._liveAnnouncementService.announce(l)}})()}_announceMessagesInCurrentChat(e){var t=this;return(0,u.A)(function*(){const n=t._translationService.instant("Copilot.LiveAnnouncement.MessageReceivedInCurrentChat");yield new Promise(s=>setTimeout(s,0));for(const s of e.filter(i=>i.direction===he.Tt.Incoming)){const i=ie.String.format(n,s.author?.name,s.text);yield t._liveAnnouncementService.announce(i)}})()}_onActiveSessionEvent(e,t){var n=this;this._copilotChatService.getActiveSessionPreviewById(e.primaryColumnValue).subscribe(s=>{(0,u.A)(function*(){s=n._copilotChatService.mapSessions(s),n._updateCurrentSessionTitle(s,t);const i=yield t.$context.ActiveChats;t.$context.ActiveChats=[s,...i];const l=n._translationService.instant("Copilot.LiveAnnouncement.SessionCreated"),p=ie.String.format(l,s.caption);yield n._liveAnnouncementService.announce(p)})()})}_onActiveSessionLiveEvent(e,t){var n=this;(0,u.A)(function*(){try{if(e.id=!e.id||e.id===S.To?yield t.$context.CurrentCopilotSessionId:e.id,!e.id)return;e.caption&&n._updateCurrentSessionTitle(e,t),yield n._partiallyChatUpdate(e.id,t,s=>(s.caption=e.caption??s.caption,s.author=e.author??s.author,s.date=e.date??s.date,s.preview=e.preview??s.preview,n._copilotChatService.mapSessions(s)))}catch(s){console.error("Error updating chat session:",s)}})()}_partiallyChatUpdate(e,t,n){return(0,u.A)(function*(){const s=(yield t.$context.ActiveChats)?.findIndex(i=>i.id===e);if(s>=0){const i=n((yield t.$context.ActiveChats)[s]),l=yield t.$context.ActiveChats;l[s]=i,t.$context.ActiveChats=[...l]}})()}_updateCurrentSessionTitle(e,t){return(0,u.A)(function*(){e.id===(yield t.$context.CurrentCopilotSessionId)&&e.caption&&e.caption!==(yield t.$context.CurrentCopilotSessionTitle)&&(t.$context.CurrentCopilotSessionTitle=e.caption)})()}_addToSubscriptions(e,t){return(0,u.A)(function*(){const n=(yield e[Cn])??[];e[Cn]=n,n.push(...t)})()}_setFeatureAttributes(e){e.EnableChatFileHandling=this._featureValues["GenAIFeatures.UseChatFileHandling"]}_initChatsList(e,t){const n={type:"crt.CopilotChatListLoadRequest",rowsToLoadCount:15,searchFilter:null,isFirstLoad:!0,scopes:t,$context:e};return U.t.instance.process(n)}_loadProfile(e,t){const n={type:"crt.LoadChatProfileRequest",scopes:t,$context:e};return U.t.instance.process(n)}_initAttributes(e,t){t&&(t.savedInSessionId===this._userInfo.sessionId?(e.CurrentCopilotSessionId=t.lastChatId,typeof t.isChatsListVisible=="boolean"&&(e.ChatsListVisible=t.isChatsListVisible)):(e.CurrentCopilotSessionId=null,e.ChatsListVisible=!1),typeof t.isCombinedMode=="boolean"&&(e.IsCombinedMode=t.isCombinedMode),typeof t.combinedModeEnabled=="boolean"&&(e.CombinedModeEnabled=t.combinedModeEnabled))}_updateSessionTypingStatus(e,t,n){var s=this;return(0,u.A)(function*(){const i=t?.state,l=yield n.ActiveChats;if(i!==k.WaitingForUserMessage&&i!==k.WaitingForAssistantMessage)return;(yield n.CurrentCopilotSessionId)===e&&(i===k.WaitingForAssistantMessage?(n.IsTyping=!0,yield s._announceTyping(t)):i===k.WaitingForUserMessage&&(n.IsTyping=!1));const h=l?.find(g=>g.id===e);h&&(i===k.WaitingForAssistantMessage?h.isTyping=!0:i===k.WaitingForUserMessage&&(h.isTyping=!1))})()}_announceTyping(e){var t=this;return(0,u.A)(function*(){const n=t._translationService.instant("Copilot.LiveAnnouncement.Typing"),s=ie.String.format(n,e.rootIntentCaption||pe.title);yield t._liveAnnouncementService.announce(s,"polite")})()}handle(e){var t=this;return(0,u.A)(function*(){yield t.next?.handle(e);const n=e.$context;t._setFeatureAttributes(n);const s=yield t._loadProfile(n,e.scopes);t._initAttributes(n,s);const i=t._copilotChatService.copilotSessionProgressEvent$().subscribe(p=>t._onSessionProgressEvent(p,e.$context)),l=t._copilotChatService.copilotMessageEvent$().subscribe(p=>{t._onMessageEvent(p,e)});t._copilotChatService.sessionUpdateEvent$().pipe((0,a.filter)(p=>p.eventType==="create")).subscribe(p=>{t._onActiveSessionEvent(p,e)}),t._copilotChatService.copilotSessionEvent$(t._copilotToChatConvertor).subscribe(p=>{t._onActiveSessionLiveEvent(p,e)}),yield t._initChatsList(n,e.scopes),yield t._addToSubscriptions(n,[i,l]),e.$context.CopilotContact=pe.contact,t._initUserConsentData(e.$context),((yield e.$context.IsConversationVisible)===!0||(0,A.isEmpty)(s))&&((yield n.CurrentCopilotSessionId)?yield t._openConversation(e.$context,e):yield t._openNewConversation(e.$context,e)),yield t._initWatchNavigation(n)})()}};it=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotChatInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["CopilotPanel"]}),(0,o.__param)(5,(0,d.Inject)(O.G)),(0,o.__param)(5,(0,bn.j)(O.G)),(0,o.__metadata)("design:paramtypes",[F,Pe,$s.f,ee.oq,d.Injector,Vs.x,j.DW,f.TranslateService])],it);let Tn=class extends X.S{};Tn=(0,o.__decorate)([(0,z.$)({type:"crt.CopilotChatModeRequest"})],Tn);let at=class extends y.l{_handleConversationOpen(e,t){return(0,u.A)(function*(){if((yield e.ChatsListVisible)&&(yield e.IsCombinedMode)){const n={type:"crt.CopilotNewChatRequest",scopes:t.scopes,$context:e};yield U.t.instance.process(n)}})()}_saveProfile(e,t){return(0,u.A)(function*(){const n={type:"crt.SaveChatProfileRequest",scopes:t,$context:e};yield U.t.instance.process(n)})()}handle(e){var t=this;return(0,u.A)(function*(){yield t.next?.handle(e);const n=e.$context;n.IsCombinedMode=e.isCombined,yield t._handleConversationOpen(n,e),t._saveProfile(n,e.scopes)})()}};at=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotChatModeHandler",requestType:"crt.CopilotChatModeRequest",scopes:["CopilotPanel"]})],at);var Oe=c(48534),He=c(85040);let ot=class extends y.l{constructor(e){super(),this._copilotPanelCode="Copilot",this._copilotToEditorCommunicationService=e.get(Oe.i)}handle(e){var t=this;return(0,u.A)(function*(){e.sidebarCode===t._copilotPanelCode&&t._copilotToEditorCommunicationService.notify({editorAction:He.u.RemoveHighlighting,selection:ie.String.empty}),yield t.next?.handle(e)})()}};ot=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotClosePanelHandler",requestType:"crt.HandleSidebarCloseRequest"}),(0,o.__metadata)("design:paramtypes",[d.Injector])],ot);var rt=c(82517),ct=c(7471),Fs=c(67354);let lt=class extends y.l{constructor(e){super(),this.injector=e,this._intentManager=this.injector.get(J.R),this._dialogService=this.injector.get(ct.o),this._translateService=this.injector.get(f.TranslateService)}_refreshGrid(e){var t=this;return(0,u.A)(function*(){const n=e.$context,i={type:"crt.LoadDataRequest",scopes:e.scopes,config:{loadType:rt.I.Reload,useLastLoadParameters:!0},$context:n,dataSourceName:"ActionsDetailDS"};yield t.handlerChain.process(i)})()}handle(e){var t=this;return(0,u.A)(function*(){const n=t._translateService.instant("Copilot.DeleteRecordConfirmation");if((yield(0,a.firstValueFrom)(t._dialogService.openConfirmationDialog(n)))===Fs.ch.result){const i=yield(0,a.firstValueFrom)(t._intentManager.deleteAction(e.intentId,e.recordId));if(!i.success)throw new Error(i.errorInfo?.message);yield t._refreshGrid(e)}})()}};lt=(0,o.__decorate)([(0,C.l)({requestType:"crt.DeleteActionFromIntentRequest",type:"crt.CopilotDeleteIntentActionHandler",scopes:["AISkills_FormPage","AIAgents_FormPage"]}),(0,o.__metadata)("design:paramtypes",[d.Injector])],lt);var dt=c(99298);let ut=class extends X.S{};ut=(0,o.__decorate)([(0,z.$)({type:"crt.DeleteRecordRequest"})],ut);var Dn=c(49159),ht=c(85604),Us=c(31774);let Rn=class extends ut{};Rn=(0,o.__decorate)([(0,z.$)({type:"crt.DeleteSubIntentRequest"})],Rn);let pt=class extends y.l{constructor(e){super(),this.injector=e,this._intentManager=this.injector.get(J.R),this._messageDialogProvider=this.injector.get(Us.r),this._translateService=this.injector.get(f.TranslateService),this._maskService=this.injector.get(dt.V)}_reloadDatasource(e){var t=this;return(0,u.A)(function*(){const{$context:n,scopes:s,reloadDataSourceName:i}=e;i&&(yield t.handlerChain.process({type:"crt.LoadDataRequest",dataSourceName:i,config:{loadType:rt.I.Reload},$context:n,scopes:s}))})()}handle(e){var t=this;return(0,u.A)(function*(){const n=t._translateService.instant("Copilot.DeleteRecordConfirmation");if(!(yield(0,a.firstValueFrom)(t._messageDialogProvider.confirmation(n))))return t.next?.handle(e);const i="REMOVE_INTENT_RELATION",{$context:l}=e;yield t._maskService.showMask(i,l);try{yield(0,a.firstValueFrom)(t._intentManager.deleteSubIntent(e.parentIntentId,e.recordId)),Dn.q.instance.notify({modelId:(0,S.qv)(),dataSchemaName:"CopilotAgentSubSkill",type:ht.M.Delete,payload:{primaryAttributesValues:[[{name:"Id",value:e.recordId}]]}}),yield t._reloadDatasource(e)}finally{yield t._maskService.hideMask(i,l)}return t.next?.handle(e)})()}};pt=(0,o.__decorate)([(0,C.l)({requestType:"crt.DeleteSubIntentRequest",type:"crt.CopilotDeleteSubIntentHandler",scopes:["AIAgents_FormPage","AISkills_FormPage"]}),(0,o.__metadata)("design:paramtypes",[d.Injector])],pt);let gt=class extends y.l{constructor(e){super(),this._userConsentService=e.get(v.F),this._copilotGtmService=e.get(G)}handle(e){var t=this;return(0,u.A)(function*(){t._userConsentService.giveUserConsent(e.consentCode).subscribe(()=>{e.$context.IsCopilotChatVisible=!0,e.$context.IsCopilotDisclaimerVisible=!1}),yield t._copilotGtmService.sendGTMData({action:"consent_accepted"}),yield t.next?.handle(e)})()}};gt=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotDisclaimerAcceptHandler",requestType:"crt.CopilotDisclaimerAcceptRequest",scopes:["CopilotPanel"]}),(0,o.__metadata)("design:paramtypes",[d.Injector])],gt);let mt=class extends y.l{constructor(e){super(),this._copilotService=e.get(Z)}handle(e){var t=this;return(0,u.A)(function*(){const n=yield t._copilotService.executeIntent(e.intentName,e.additionalPromptText,e.parameters);return yield t.next?.handle(e),n})()}};mt=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotExecuteIntentHandler",requestType:"crt.CopilotExecuteIntentRequest"}),(0,o.__metadata)("design:paramtypes",[d.Injector])],mt);let _t=class extends y.l{constructor(e){super(),this._copilotService=e.get(Z)}_isObjectResponse(e){return!!e&&e===Object(e)&&!Array.isArray(e)}handle(e){var t=this;return(0,u.A)(function*(){const n=yield t._copilotService.getAvailableIntents(e.intentNames,e.mode),s=yield t.next?.handle(e);return t._isObjectResponse(s)?{...n,...s}:n})()}};_t=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotGetAvailableIntentsHandler",requestType:"crt.CopilotGetAvailableIntentsRequest"}),(0,o.__metadata)("design:paramtypes",[d.Injector])],_t);var Os=c(92009);let Ct=class extends y.l{constructor(e){super(),this._schemaService=e,this._defValueHandlers=new Map([["CopilotIntentParameter",this._handleCopilotIntentParameterDefValues],["SysSchemaOperationRight",this._handleSysSchemaOperationRightDefValues]])}_handleCopilotIntentParameterDefValues(e,t){const n=e.dataGridName.replace("Detail","");return t.push({attributeName:"SourceCollection",value:n}),t.push({attributeName:"DataValueTypeUId",value:le.Q[w.r.MAXSIZE_TEXT].id}),Promise.resolve()}_handleSysSchemaOperationRightDefValues(e,t){return(0,u.A)(function*(){const n=yield e.$context.Id;t.push({attributeName:"SysSchemaUId",value:n}),t.push({attributeName:"Operation",value:7})})()}_getDataGridViewConfig(e){return this._schemaService.getViewConfigInfoByProperty("type","crt.DataGrid")?.map(t=>t?.viewConfig)?.find(t=>t?.name===e)??null}_getIsSupportedEntitySchemaName(e){return this._defValueHandlers.has(e)}handle(e){var t=this;return(0,u.A)(function*(){const{dataGridName:n,defaultValues:s}=e,i=e.$context,p=t._getDataGridViewConfig(n)?.items?.toString().slice(1);if(p){const g=i.getBoundDataSchemaByAttributePath(p).dataSourceConfig.config.entitySchemaName;if(!t._getIsSupportedEntitySchemaName(g))return t.next?.handle(e);yield t._defValueHandlers.get(g)(e,s)}return t.next?.handle(e)})()}};Ct=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotIntentDetailCreateItemHandler",requestType:"crt.DataGridCreateItemRequest",scopes:["AISkills_FormPage"]}),(0,o.__metadata)("design:paramtypes",[Os.R])],Ct);var Nn=c(73743);let ft=class extends y.l{constructor(){super(...arguments),this._apiMode=Nn.$E.get(Nn.aA.Api)}handle(e){var t=this;return(0,u.A)(function*(){if(e.attributeName==="PDS_Mode"){const n=e.value?e.value:yield e.$context.PDS_Mode;e.$context.IsApiMode=n?n.value===t._apiMode:!1}return t.next?.handle(e)})()}};ft=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotIntentModeChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["AISkills_FormPage"]})],ft);var Hs=c(50237),js=c(5704),ks=c(29025),Bs=c(53163),wn=c(38071);class Ln extends y.l{constructor(e){super(),this._featureService=e.get(wn.wf)}_initializeFeatureAttributes(e){var t=this;return(0,u.A)(function*(){const n=t.featureToAttributeMap;for(const s of n){const{featureCode:i,attributeName:l,invert:p}=s,h=yield(0,a.lastValueFrom)(t._featureService.getFeatureState(i));e[l]=p?!h:h}})()}_processPredefinedFilter(e,t){return(0,u.A)(function*(){const n=yield e[t.filterAttributeName],s=yield e[t.filterValueAttributeName];if(n){const i=Hs.b.fromJson(n);i.filters.forEach(l=>{l instanceof js.x&&l.leftExpression instanceof ks.g&&l.leftExpression.columnPath===t.filterEntityColumnPath&&l.rightExpression instanceof Bs.J&&(l.rightExpression.parameter.value=s,e[t.filterAttributeName]=i.toJson())})}})()}_initializePredefinedFilterValues(e){var t=this;return(0,u.A)(function*(){const n=t.predefinedFilterValueMap;for(const s of n)yield t._processPredefinedFilter(e,s)})()}handle(e){var t=this;return(0,u.A)(function*(){const n=e.$context;yield t._initializeFeatureAttributes(n),yield t.next?.handle(e),yield t._initializePredefinedFilterValues(n)})()}}let vt=class extends Ln{constructor(e){super(e),this._availableDataValueTypes=[w.r.Date,w.r.Time,w.r.DateTime,w.r.Guid,w.r.Boolean,w.r.LONG_TEXT,w.r.MAXSIZE_TEXT,w.r.Integer,w.r.FLOAT2,w.r.Money],this._translateService=e.get(f.TranslateService)}get featureToAttributeMap(){return[{featureCode:"GenAIFeatures.UseIntentSchemaOperationRights",attributeName:"EnableRightsManagementUI"},{featureCode:"GenAIFeatures.UseFileHandling",attributeName:"EnableAttachmentsUI"},{featureCode:"GenAIFeatures.DisableSkillParametersUi",attributeName:"EnableParametersUI",invert:!0},{featureCode:"GenAIFeatures.MultiLlmSupport",attributeName:"EnableMultiLlmSupport"}]}get predefinedFilterValueMap(){return[{filterAttributeName:"IntentFileList_PredefinedFilter",filterValueAttributeName:"Id",filterEntityColumnPath:"IntentUId"}]}_getDataValueTypeLookupValues(e=!1){const t=[...this._availableDataValueTypes];return e&&t.push(w.r.COMPOSITE_OBJECT_LIST),Object.keys(le.Q).filter(n=>{const s=le.Q[n];return t.includes(s.type)}).map(n=>{const s=le.Q[n];return{displayValue:this._translateService.instant(s.translateKey),value:s.id}}).sort((n,s)=>n.displayValue.localeCompare(s.displayValue))}handle(e){var t=()=>super.handle,n=this;return(0,u.A)(function*(){const s=e.$context;s.AvailableInputDataValueTypes=n._getDataValueTypeLookupValues(!0),s.AvailableOutputDataValueTypes=n._getDataValueTypeLookupValues(),yield t().call(n,e)})()}};vt=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotIntentPageInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["AISkills_FormPage"]}),(0,o.__metadata)("design:paramtypes",[d.Injector])],vt);let St=class extends Ln{constructor(e){super(e)}get featureToAttributeMap(){return[{featureCode:"GenAIFeatures.UseFileHandling",attributeName:"EnableAttachmentsUI"},{featureCode:"GenAIFeatures.UseIntentSchemaOperationRights",attributeName:"EnableRightsManagementUI"},{featureCode:"GenAIFeatures.MultiLlmSupport",attributeName:"EnableMultiLlmSupport"}]}get predefinedFilterValueMap(){return[{filterAttributeName:"AgentFileList_PredefinedFilter",filterValueAttributeName:"Id",filterEntityColumnPath:"IntentUId"}]}};St=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotAgentPageInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["AIAgents_FormPage"]}),(0,o.__metadata)("design:paramtypes",[d.Injector])],St);let yt=class extends y.l{handle(e){var t=this;return(0,u.A)(function*(){const i=yield(yield e.$context[e.collectionName])?.findByPrimaryAttribute(e.primaryColumnValue);i&&(i[e.attributeName]=e.attributeValue??le.Q[w.r.MAXSIZE_TEXT].id),yield t.next?.handle(e)})()}};yt=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotIntentParameterDataValueTypeChangeHandler",requestType:"crt.CopilotIntentParameterDataValueTypeChangeRequest",scopes:["AISkills_FormPage"]})],yt);var zs=c(65288);let It=class extends y.l{handle(e){var t=this;return(0,u.A)(function*(){const n=e.$context,s=yield t.next.handle(e);if(s){const l=(e.recordIds??[]).map(p=>(0,a.lastValueFrom)(n.delete(e.dataSourceName,[{type:zs.E.PrimaryColumnValue,value:p}])));yield Promise.all(l)}return s})()}};It=(0,o.__decorate)([(0,C.l)({requestType:"crt.DeleteRecordsRequest",type:"crt.CopilotIntentParameterDeleteItemHandler",scopes:["AISkills_FormPage"]})],It);let Mt=class extends y.l{_extractTemplateParameters(e){const t=/\[#\s*([a-zA-Z_][a-zA-Z0-9_.]*)\s*#]/g,n=new Set;let s;for(;(s=t.exec(e))!==null;)n.add(s[1]);return Array.from(n)}handle(e){var t=this;return(0,u.A)(function*(){if(e.attributeName==="PDS_Prompt"){const n=e.$context;n.Prompt_tooltip=null;const s=e.value?e.value:yield n.PDS_Prompt,i=t._extractTemplateParameters(s);if(i.length>0){const p=(yield n.InputParametersDetail).map(g=>g.attributes.InputParametersDS_Code),h=i.filter(g=>!p.includes(g));if(h.length>0){const g=yield n.Resources.Strings.MissingPromptParameterWarning;n.Prompt_tooltip=g.replace("{0}",h.join(", "))}}}return t.next?.handle(e)})()}};Mt=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotIntentPromptChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["AISkills_FormPage","AIAgents_FormPage"]})],Mt);var Vn=c(22592);const Gs="workspace-explorer-items-reload";var Ws=c(97502);const Ks=["InputParametersDetail","OutputParametersDetail"];let At=class extends y.l{constructor(e,t,n,s,i){super(),this._broadcastChannelFactory=e,this._baseViewModelProcessValidationResultService=t,this._notifyService=n,this._intentManager=s,this._maskService=i,this._init()}_init(){this._workspaceReloadBroadcastService=this._broadcastChannelFactory.createInstance(Gs)}_saveDataSafely(e){return e().catch(t=>[this._createFailedSaveResult(t?.message)])}_createFailedSaveResult(e){return{success:!1,rowsAffected:0,errorInfo:e}}_saveInnerViewModelCollection(e,t,n){var s=this;return(0,u.A)(function*(){const i={type:"crt.SaveCollectionPrimaryDataRequest",$context:e,collectionAttributeName:t,scopes:n};return yield s.handlerChain.process(i)})()}_validatePrimaryModel(e){var t=this;return(0,u.A)(function*(){const n=yield e.getPrimaryModelName();if(!(yield e.isValid(n))){const i=yield e.validate(n),l=yield t._baseViewModelProcessValidationResultService.getValidationErrorMessage(e,i);throw new Error(l)}})()}_showErrorDialog(e){var t=this;return(0,u.A)(function*(){const n=e?.message;n&&(yield t._notifyService.show({message:n}))})()}_aggregateDataSourceSaveResults(e){const t=e.map(n=>n?.errorInfo).filter(Boolean);return{success:e.length===0||e.every(n=>n?.success),errors:t.length===0?void 0:t.join(`
`)}}_handleApiModeSave(e,t){var n=this;return(0,u.A)(function*(){const s="RECORD_SAVING";yield n._maskService.showMask(s,e);try{yield n._validatePrimaryModel(e);const i=Ks.map(h=>n._saveDataSafely(()=>n._saveInnerViewModelCollection(e,h,t))),l=yield Promise.all(i),p=n._aggregateDataSourceSaveResults(l.flat());if(!p.success)throw new Error(p.errors)}catch(i){return yield n._showErrorDialog(i),!1}finally{yield n._maskService.hideMask(s,e)}return!0})()}handle(e){var t=this;return(0,u.A)(function*(){const n=e.$context;if((yield n.IsApiMode)&&!(yield t._handleApiModeSave(n,e.scopes)))return!1;const s=yield t.next?.handle(e);if(s){const i=yield n.PDS_Id,l=yield n.PDS_ParentIntentId;let p;l?(yield(0,a.lastValueFrom)(t._intentManager.createSubIntent(l,i)),p=ht.M.Create):p=ht.M.Update,Dn.q.instance.notify({modelId:(0,S.qv)(),dataSchemaName:"CopilotAgentSubSkill",type:p,payload:{primaryAttributesValues:[[{name:"Id",value:i}]]}})}return t._workspaceReloadBroadcastService.publish(),s})()}};At=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotIntentSaveHandler",requestType:"crt.SaveRecordRequest",scopes:["AISkills_FormPage","AIAgents_FormPage"]}),(0,o.__param)(4,(0,bn.j)(dt.V)),(0,o.__metadata)("design:paramtypes",[j.Vx,Ws.i,tt.F,J.R,Vn.s])],At);var Et=c(13555);let xt=class extends y.l{constructor(e){super(),this._copilotChatService=e.get(se),this._userInfo=e.get(ee.oq),this._copilotToChatConvertor=e.get(Q),this._chatDraftService=e.get(Et.X),this._copilotGtmService=e.get(G)}_getConvertedMessages(e){return this._copilotToChatConvertor.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId})}_addMessageToConversation(e,t,n){var s=this;return(0,u.A)(function*(){const i=yield e.$context[n],l=new Set(i.map(h=>h.id)),p=s._getConvertedMessages(t).filter(h=>!l.has(h.id));e.$context[n]=[...i,...p]})()}_saveProfile(e,t){return(0,u.A)(function*(){const n={type:"crt.SaveChatProfileRequest",scopes:t,$context:e};yield U.t.instance.process(n)})()}handle(e){var t=this;return(0,u.A)(function*(){const n=e.attributesMapping,s=n?.chatInput,i=n.chatId;let l=yield e.$context[i];if(!(0,A.isEmpty)(s)){const p=yield e.$context[s];e.$context[s]="",t._chatDraftService.clearDraft(l),(0,A.isEmpty)(l)?(l=(0,S.qv)(),e.$context[i]=l,e.$context.IsTyping=!0,yield t._saveProfile(e.$context,e.scopes)):e.$context[i]=l,yield t._copilotGtmService.sendGTMData({action:"query_submitted",primaryColumnValue:l});const h=yield t._copilotChatService.sayToSessionWithResponse(p,l);if(!h)e.$context[s]=p;else if(h?.messages.length){const g=n?.chatMessages;!(0,A.isEmpty)(g)&&(yield e.$context[i])===l&&(yield t._addMessageToConversation(e,h.messages,g))}}yield t.next?.handle(e)})()}};xt=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotMessageEditorSendHandler",requestType:"crt.MessageEditorSendRequest",scopes:["CopilotPanel"]}),(0,o.__metadata)("design:paramtypes",[d.Injector])],xt);var $n=c(96158),Fn=c(43778);let Pt=class extends y.l{constructor(e){super(),this._injector=e,this._translateService=this._injector.get(f.TranslateService),this._chatDraftService=this._injector.get(Et.X)}_setDefaultValuesIfNeeded(e){e.chatMessagesAttributeName??="ChatMessages",e.sessionIdAttributeName??="CurrentCopilotSessionId",e.sessionTitleAttributeName??="CurrentCopilotSessionTitle",e.conversationEventAttributeName??="ConversationEvent"}_saveProfile(e,t){return(0,u.A)(function*(){const n={type:"crt.SaveChatProfileRequest",scopes:t,$context:e};yield U.t.instance.process(n)})()}_resetMessageEditorInputFocus(e){e.$context.MessageEditorInputAction=$n.g.Focus,setTimeout(()=>{e.$context.MessageEditorInputAction=""},0)}handle(e){var t=this;return(0,u.A)(function*(){t._setDefaultValuesIfNeeded(e);const n=e.$context;!(0,A.isEmpty)(e.chatMessagesAttributeName)&&!(0,A.isEmpty)(e.conversationEventAttributeName)&&(n[e.chatMessagesAttributeName]=[],n[e.conversationEventAttributeName]=[{name:Fn.R}]),n[e.sessionIdAttributeName]=null,n[e.sessionTitleAttributeName]=t._translateService.instant("Copilot.NewChatCaption"),(yield e.$context.IsCombinedMode)||(e.$context.ChatsListVisible=!1,e.$context.IsTyping=!1),e.$context.ChatInput="",setTimeout(()=>{e.$context.ChatInput=t._chatDraftService.getDraft(null),t._resetMessageEditorInputFocus(e)},0),yield t._saveProfile(e.$context,e.scopes),yield t.next?.handle(e)})()}};Pt=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotNewChatHandler",requestType:"crt.CopilotNewChatRequest",scopes:["CopilotPanel"]}),(0,o.__metadata)("design:paramtypes",[d.Injector])],Pt);var Un=c(61541);let bt=class extends y.l{constructor(e){super(),this.injector=e,this._intentManager=this.injector.get(J.R)}_getModelInitConfig(e){return(0,u.A)(function*(){const t=e.modelInitConfigs,n=yield e.getPrimaryModelName();return t?.find(s=>s.name===n)})()}_getIntent(e,t){var n=this;return(0,u.A)(function*(){let s;const l=(yield e.getPrimaryDataSchema())?.name;return l==="CopilotIntent"||l==="CopilotAgent"?s=yield(0,a.firstValueFrom)(n._intentManager.getIntent(t)):l==="CopilotAction"&&(s=yield(0,a.firstValueFrom)(n._intentManager.getIntentByActionUId(t))),s})()}_disableCodeField(e){const t=e.getAttributeNameByViewItemName("Code");e.disableAttributeValidator(t,"CodePrefixValidator"),e.setAttributePropertyValue(t,"readonly",!0)}handle(e){var t=this;return(0,u.A)(function*(){yield t.next?.handle(e);const n=e.$context,s=yield t._getModelInitConfig(n);if(!(s?.action===Un.n.Edit))return;(yield t._getIntent(n,s?.recordId))?.ExtendParent&&t._disableCodeField(n)})()}};bt=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotPageDisableCodeFieldHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["AISkills_FormPage","AIProcessActions_FormPage","AIAgents_FormPage"]}),(0,o.__metadata)("design:paramtypes",[d.Injector])],bt);const Y={process:"ProcessSchemaUId",params:"PDS_Params"};let Tt=class extends y.l{constructor(e){super(),this._customEventService=e}_getIsAddAction(e){return(0,u.A)(function*(){const t=e.modelInitConfigs,n=yield e.getPrimaryModelName();return t?.find(i=>i.name===n)?.action===Un.n.Add})()}handle(e){var t=this;return(0,u.A)(function*(){const n=e.$context;n[Y.process]=null;const s=yield t.next?.handle(e);if(yield t._getIsAddAction(n))return s;const i=yield n.ProcessDesignerInstanceId;return yield new Promise(l=>{const p={designerInstanceId:i,callback:l};t._customEventService.createOutboundChannel("cancelProcessSchemaChanges").next(p)}),s})()}};Tt=(0,o.__decorate)([(0,C.l)({requestType:"crt.CancelRecordChangesRequest",type:"crt.CopilotProcessActionsCancelRecordHandler",scopes:["AIProcessActions_FormPage"]}),(0,o.__metadata)("design:paramtypes",[j.Dj])],Tt);var On=c(89285),Hn=c(32053);function jn(r){return Dt.apply(this,arguments)}function Dt(){return Dt=(0,u.A)(function*(r){const e="ProcessDesignerInstanceId";let t=yield r[e];t||(t=(0,S.qv)(),r[e]=t)}),Dt.apply(this,arguments)}let Rt=class extends y.l{constructor(){super(...arguments),this._statusFlags=["ProcessSchemaIsChanged","HasUnsavedData",Hn.j7,Y.process]}_handleProcessChange(e){if(e.attributeName===Y.process&&!e.silent){const t={processSchemaUId:e.value};e.$context[Y.params]=JSON.stringify(t)}}_handleCreateModel(e){return(0,u.A)(function*(){e.attributeName===Hn.yM&&e.value===On.b.Create&&(e.$context[Y.process]=S.To,yield jn(e.$context))})()}handle(e){var t=this;return(0,u.A)(function*(){if(t._handleProcessChange(e),yield t._handleCreateModel(e),e.attributeName==="ProcessSchemaIsLoaded"&&e.value){const n=yield e.$context.getPrimaryModelName();e.$context.getModelByName(n).setLoadedState()}else if(t._statusFlags.includes(e.attributeName)){const n=yield e.$context[Y.process],s=yield e.$context.ProcessSchemaIsLoaded,i=yield e.$context.ProcessSchemaIsChanged,l=yield e.$context.HasUnsavedData,p=yield e.$context.IsChanged;e.$context.ProcessActionHasUnsavedData=s&&n!==S.To&&(l||p||i)}return t.next?.handle(e)})()}};Rt=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotProcessActionsPageAttributeChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["AIProcessActions_FormPage"]})],Rt);let Nt=class extends y.l{_subscribeParamsLoaded(e){const t=new a.Subscription;t.add(e.events$.pipe((0,a.filter)(({type:n})=>n==="finish-load-model-attributes"),(0,a.filter)(({payload:n})=>n[Y.params]),(0,a.switchMap)(()=>e[Y.params]),(0,a.filter)(n=>!!n)).subscribe({next:function(){var n=(0,u.A)(function*(s){let i;try{i=JSON.parse(s).processSchemaUId}catch(h){console.error(`params = ${s}
${h?.message}`)}const l={silent:!0},p={[Y.process]:i};e.setValue(p,l),yield jn(e)});return function(i){return n.apply(this,arguments)}}(),complete:()=>{t.unsubscribe()}}))}handle(e){var t=this;return(0,u.A)(function*(){yield t.next?.handle(e),t._subscribeParamsLoaded(e.$context)})()}};Nt=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotProcessActionsPageInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["AIProcessActions_FormPage"]})],Nt);let wt=class extends y.l{constructor(e,t){super(),this._customEventService=e,this._translateService=t}_performDesignerSave(e,t){var n=this;return(0,u.A)(function*(){const s=yield e.ProcessDesignerInstanceId;return new Promise(i=>{const l={designerInstanceId:s,needSaveNewVersion:t,saveCallback:i};n._customEventService.createOutboundChannel("saveProcessSchema").next(l)})})()}_showDesignerValidationErrorNotification(e){var t=this;return(0,u.A)(function*(){const n={type:"crt.NotificationRequest",$context:e,message:"Dialog.ProcessSchemaSavedWithValidationError"};yield t.handlerChain.process(n)})()}handle(e){var t=this;return(0,u.A)(function*(){const n=e.$context,s=e.config,i=s?s.needSaveNewVersion:!1;if(!(yield n.isValid()))return yield t.next?.handle(e);const p=yield t._performDesignerSave(n,i);return p.isCanceled?!1:(p.isValid||(yield t._showDesignerValidationErrorNotification(n)),yield t.next?.handle(e))})()}};wt=(0,o.__decorate)([(0,C.l)({requestType:"crt.SaveRecordRequest",type:"crt.CopilotProcessActionsPageSaveHandler",scopes:["AIProcessActions_FormPage"]}),(0,o.__metadata)("design:paramtypes",[j.Dj,f.TranslateService])],wt);let Lt=class extends y.l{constructor(e){super(),this._copilotChatService=e.get(F),this._copilotToEditorCommunicationService=e.get(Oe.i)}handle(e){var t=this;return(0,u.A)(function*(){yield t._copilotChatService.closeSession();const n=e.chatMessagesAttributeName,s=e.conversationEventAttributeName,i=e.$context;e.sessionIdAttributeName&&(i[e.sessionIdAttributeName]=null),!(0,A.isEmpty)(n)&&!(0,A.isEmpty)(s)&&(i[n]=[],i[s]=[{name:Fn.R}]),t._copilotToEditorCommunicationService.notify({editorAction:He.u.RemoveHighlighting}),yield t.next?.handle(e)})()}};Lt=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotRestartSessionHandler",requestType:"crt.CopilotRestartSessionRequest",scopes:["CopilotPanel"]}),(0,o.__metadata)("design:paramtypes",[d.Injector])],Lt);var kn=c(50002);let Vt=class extends y.l{constructor(e){super(),this._copilotPanelCode=xe.b,this._sidebarStateService=e.get(An.p),this._copilotChatService=e.get(se),this._translateService=e.get(f.TranslateService),this._copilotToEditorCommunicationService=e.get(Oe.i),this._profileService=e.get(Mn.c),this._customEventService=e.get(j.Dj)}_getChatPanelProfileData(){var e=this;return(0,u.A)(function*(){return yield(0,a.firstValueFrom)(e._profileService.getProfile(En.j))})()}_getChatSessionId(){var e=this;return(0,u.A)(function*(){const t=yield e._getChatPanelProfileData(),n=yield(0,a.firstValueFrom)(e._sidebarStateService.opened.rootSidebar$);return t&&!t.isChatsListVisible&&n===e._copilotPanelCode?t.lastChatId:null})()}_getPrompt(e,t){return["Friendly","Formal","Shorten","Extend","Rephrase","AskCopilot"].includes(t)?`${this._translateService.instant(`Copilot.RewriteActionsPrompt.${t}`)}: ${e}`:e}handle(e){var t=this;return(0,u.A)(function*(){const n=yield e.$context[e.selectionAttributeName];if(!(0,A.isEmpty)(n)){t._copilotToEditorCommunicationService.notify({editorAction:He.u.SetHighlighting,selection:n});const s=t._getPrompt(n,e.rewriteAction),i=yield t._getChatSessionId();yield t._sidebarStateService.openRootSidebar(t._copilotPanelCode);const l=yield t._copilotChatService.sayToSessionWithResponse(s,i);!i&&l?.copilotSession&&t._customEventService.createOutboundChannel(xe.k).next(l.copilotSession.id)}yield t.next?.handle(e)})()}};Vt=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotRewriteTextHandler",requestType:"crt.SelectionActionRequest",scopes:[kn.M.AllCards,"BasePageFreedomTemplate","BaseSidebarTemplate",kn.M.AllSections]}),(0,o.__metadata)("design:paramtypes",[d.Injector])],Vt);let Bn=class extends X.S{};Bn=(0,o.__decorate)([(0,z.$)({type:"crt.CopilotSelectExistingProcessRequest",scopes:["AISkills_FormPage"]})],Bn);let $t=class extends y.l{_saveIntent(e){var t=this;return(0,u.A)(function*(){const n=e.$context,s={type:"crt.SaveRecordRequest",preventCardClose:!0,preventCardStateChange:!0,$context:n,scopes:e.scopes},i=yield t.handlerChain.process(s);if(i){const l=yield n.getPrimaryModelName(),p=yield n.getPrimaryDataSchema(),h={type:"crt.LoadDataRequest",dataSourceName:l,parameters:[{type:"primaryColumnValue",value:p.primaryAttributeName}],$context:n,scopes:e.scopes};yield t.handlerChain.process(h)}return i})()}_getOpenLookupPageRequestConfig(e){var t=this;const{$context:n,scopes:s,caption:i,actionCode:l,intentId:p,packageUId:h}=e;return{type:"crt.OpenSelectionWindowRequest",$context:n,scopes:[...s],entitySchemaName:"VwProcessLib",caption:i,schemaName:"CopilotSelectExistingProcessForActionPage",afterClosed:function(){var g=(0,u.A)(function*(_){if(_.canceled)return;const V=yield _.getLookupValues(),[oe]=V;if(oe){const Zs=oe.value,Ys={type:"crt.CreateRecordRequest",$context:n,entityName:"CopilotAction",defaultValues:[{attributeName:"Intent",value:p},{attributeName:"Code",value:l},{attributeName:"PackageUId",value:h},{attributeName:"Params",value:JSON.stringify({processSchemaUId:Zs})}]};yield t.handlerChain.process(Ys)}});return function(V){return g.apply(this,arguments)}}(),filtersConfig:{filterAttributes:[{name:"processEnabledFilter",loadOnChange:!1}],attributesConfig:{processEnabledFilter:{value:{items:{"a1dbfcfe-84e1-4bba-ac51-a83194bf2f6a":{filterType:1,comparisonType:3,isEnabled:!0,trimDateTimeParameterToDate:!1,leftExpression:{expressionType:0,columnPath:"Enabled"},isAggregative:!1,dataValueType:12,rightExpression:{expressionType:2,parameter:{dataValueType:12,value:!0}}}},logicalOperation:0,isEnabled:!0,filterType:6,rootSchemaName:"VwProcessLib"}}}},features:{disableLinks:!1}}}handle(e){var t=this;return(0,u.A)(function*(){if((yield e.$context.HasUnsavedData)&&!(yield t._saveIntent(e)))return;const s=t._getOpenLookupPageRequestConfig(e);return yield t.handlerChain.process(s),t.next?.handle(e)})()}};$t=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotSelectExistingProcessHandler",requestType:"crt.CopilotSelectExistingProcessRequest",scopes:["AISkills_FormPage","AIAgents_FormPage"]})],$t);let zn=class extends X.S{};zn=(0,o.__decorate)([(0,z.$)({type:"crt.CopilotSelectExistingSkillRequest",scopes:["AIAgents_FormPage"]})],zn);let Ft=class extends y.l{handle(e){var t=this;return(0,u.A)(function*(){return yield t.handlerChain.process({type:"crt.CopilotSelectExistingIntentRequest",sourceIntentId:e.agentId,selectionWindow:{caption:e.caption,entitySchemaName:"CopilotIntent",schemaName:"CopilotSelectExistingSkillForAgentPage",features:{disableLinks:!1}},reloadDataSources:["SubSkillsDetailDS"],selectedValueIsChild:!0,$context:e.$context,scopes:e.scopes}),t.next?.handle(e)})()}};Ft=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotSelectExistingSkillHandler",requestType:"crt.CopilotSelectExistingSkillRequest",scopes:["AIAgents_FormPage"]})],Ft);let Ut=class extends y.l{constructor(e){super(),this.injector=e,this.intentManager=this.injector.get(J.R),this.maskService=this.injector.get(dt.V)}_saveRecord(e){const{$context:t,scopes:n}=e,s={type:"crt.SaveRecordRequest",preventCardClose:!0,preventCardStateChange:!0,$context:t,scopes:n};return this.handlerChain.process(s)}_createSelectionWindowRequest(e){const{$context:t,scopes:n,selectionWindow:s}=e;return{type:"crt.OpenSelectionWindowRequest",caption:s.caption,entitySchemaName:s.entitySchemaName,schemaName:s.schemaName,features:s.features,filtersConfig:s.filtersConfig,afterClosed:i=>this._handleSelectionResult(i,e),$context:t,scopes:[...n]}}_handleSelectionResult(e,t){var n=this;return(0,u.A)(function*(){if(e.canceled)return;const s=yield e.getLookupValues(),[i]=s;if(i){const l=i.value,p="CREATE_INTENT_RELATION",{$context:h}=t;yield n.maskService.showMask(p,h);try{yield n._createIntentRelation(t,l),yield n._reloadDataSource(t)}finally{yield n.maskService.hideMask(p,h)}}})()}_reloadDataSource(e){var t=this;return(0,u.A)(function*(){const{$context:n,reloadDataSources:s,scopes:i}=e,l=(s??[]).map(p=>t.handlerChain.process({type:"crt.LoadDataRequest",dataSourceName:p,config:{loadType:rt.I.Reload},$context:n,scopes:i}));yield Promise.all(l)})()}_createIntentRelation(e,t){var n=this;return(0,u.A)(function*(){const{sourceIntentId:s,selectedValueIsChild:i}=e;let l,p;i?(l=s,p=t):(l=t,p=s),yield(0,a.lastValueFrom)(n.intentManager.createSubIntent(l,p))})()}handle(e){var t=this;return(0,u.A)(function*(){if((yield e.$context.HasUnsavedData)&&!(yield t._saveRecord(e)))return t.next?.handle(e);const s=t._createSelectionWindowRequest(e);return yield t.handlerChain.process(s),t.next?.handle(e)})()}};Ut=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotSelectExistingIntentHandler",requestType:"crt.CopilotSelectExistingIntentRequest",scopes:["AIAgents_FormPage","AISkills_FormPage"]}),(0,o.__metadata)("design:paramtypes",[d.Injector])],Ut);let Gn=class extends X.S{};Gn=(0,o.__decorate)([(0,z.$)({type:"crt.CopilotShowDebugInfoRequest",scopes:["CopilotPanel"]})],Gn);let Ot=class extends y.l{constructor(e){super(),this._copilotChatService=e.get(F),this._translateService=e.get(f.TranslateService),this._dialogService=e.get(ct.o),this._maskService=e.get(Vn.s),this._featureService=e.get(wn.wf)}_openDebugInfoPage(e,t,n){var s=this;return(0,u.A)(function*(){const i={schemaName:"AIDebugInfo",type:"crt.OpenPageRequest",$context:e.$context,skipUnsavedData:!0,parameters:{PlainInfo:n,DebugInfo:t}};yield s.handlerChain.process(i)})()}_useSyntaxHighlight(e){const t={strings:"#181818",booleans:"#219",numbers:"#164",keys:"#757575"};return e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e.replace(/("(\\u[[:alnum:]]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+-]?\d+)?)/g,n=>{let s=t.numbers;return n.startsWith('"')?s=n.endsWith(":")?t.keys:t.strings:["null","true","false"].includes(n)&&(s=t.booleans),`<span style="color:${s}">${n}</span>`})}_useIndentation(e){return e.replaceAll("\u2003","&emsp;").replaceAll("\\n","\\a").replaceAll(`
`,"<br>").replaceAll("\\a","\\n")}handle(e){var t=this;return(0,u.A)(function*(){const n=yield(0,a.lastValueFrom)(t._featureService.getFeatureState("ShowSystemMessagesFromCopilot"));yield t._maskService.showBodyMask();const s=e.sessionId,i=s?t._copilotChatService.getCopilotSessionMessages(s):t._copilotChatService.getInitialMessages$();yield(0,a.firstValueFrom)(i.pipe((0,a.map)(l=>n?l:l.slice(1)),(0,a.tap)(function(){var l=(0,u.A)(function*(p){if(!p||p.length===0){const _=t._translateService.instant("Copilot.DebugInfo.NoDebugInfo");yield t._maskService.hideBodyMask(),t._dialogService.openInfoDialog(_);return}const h=JSON.stringify(p,null,"\u2003");let g=t._useSyntaxHighlight(h);g=t._useIndentation(g),yield t._openDebugInfoPage(e,g,h),yield t._maskService.hideBodyMask()});return function(p){return l.apply(this,arguments)}}())))})()}};Ot=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotShowDebugInfoHandler",requestType:"crt.CopilotShowDebugInfoRequest",scopes:["CopilotPanel"]}),(0,o.__metadata)("design:paramtypes",[d.Injector])],Ot);let Ht=class extends y.l{constructor(e){super(),this._copilotToEditorCommunicationService=e.get(Oe.i)}handle(e){var t=this;return(0,u.A)(function*(){t._copilotToEditorCommunicationService?.notify({editorAction:He.u.RemoveHighlighting}),yield t.next?.handle(e)})()}};Ht=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotViewModelPauseHandler",requestType:"crt.HandleViewModelPauseRequest"}),(0,o.__metadata)("design:paramtypes",[d.Injector])],Ht);class jt extends X.S{}class kt extends y.l{constructor(e){super(),this.injector=e,this._initialCodeValueAttributeName="_InitialCodeValue",this.intentManager=this.injector.get(J.R)}loadCodes(e,t){return this.getCodes(e,t).pipe((0,a.tap)(n=>e[this.cacheAttributeName]=n))}handle(e){var t=this;return(0,u.A)(function*(){const n=e.$context;if(n.PrimaryModelMode!==On.b.Create){yield t.next?.handle(e);return}let s=yield n[t._initialCodeValueAttributeName];s||(s=yield t.initializeCodeValue(n,e),n[t._initialCodeValueAttributeName]=s);const i=yield n[e.valueAttributeName];if(!i){n[e.codeAttributeName]=s;return}const l=yield n[t.cacheAttributeName],h=(l?.length>0?(0,a.of)(l):t.loadCodes(n,e)).pipe((0,a.switchMap)(g=>t.generateCode(g,i)));n[e.codeAttributeName]=(yield(0,a.lastValueFrom)(h))??s,yield t.next?.handle(e)})()}}let Wn=class extends jt{};Wn=(0,o.__decorate)([(0,z.$)({type:"crt.GenerateCopilotActionCodeValueRequest"})],Wn);let Bt=class extends kt{constructor(e){super(e),this.cacheAttributeName="_ActionCodes_Cache"}getCodes(e,t){return(0,a.from)(e[t.intentAttributeName]).pipe((0,a.switchMap)(n=>this.intentManager.getIntent(n?.value).pipe((0,a.map)(s=>s.Actions.map(i=>i.Code)))))}generateCode(e,t){return this.intentManager.generateActionCode(e,t)}initializeCodeValue(e,t){return e[t.codeAttributeName]}};Bt=(0,o.__decorate)([(0,C.l)({type:"crt.GenerateCopilotActionCodeValueHandler",requestType:"crt.GenerateCopilotActionCodeValueRequest"}),(0,o.__metadata)("design:paramtypes",[d.Injector])],Bt);let Kn=class extends jt{};Kn=(0,o.__decorate)([(0,z.$)({type:"crt.GenerateAgentCodeValueRequest"})],Kn);let zt=class extends kt{constructor(e){super(e),this.cacheAttributeName="_AgentCodes_Cache"}getCodes(){return this.intentManager.getAllAgents()}generateCode(e,t){return this.intentManager.generateAgentCode(e,t)}initializeCodeValue(e,t){return(0,a.lastValueFrom)(this.loadCodes(e,t).pipe((0,a.switchMap)(n=>this.generateCode(n,""))))}};zt=(0,o.__decorate)([(0,C.l)({type:"crt.GenerateAgentCodeValueRequestHandler",requestType:"crt.GenerateAgentCodeValueRequest"}),(0,o.__metadata)("design:paramtypes",[d.Injector])],zt);let Jn=class extends jt{};Jn=(0,o.__decorate)([(0,z.$)({type:"crt.GenerateSkillCodeValueRequest"})],Jn);let Gt=class extends kt{constructor(e){super(e),this.cacheAttributeName="_SkillCodes_Cache"}getCodes(){return this.intentManager.getAllSkills()}generateCode(e,t){return this.intentManager.generateSkillCode(e,t)}initializeCodeValue(e,t){return(0,a.lastValueFrom)(this.loadCodes(e,t).pipe((0,a.switchMap)(n=>this.generateCode(n,""))))}};Gt=(0,o.__decorate)([(0,C.l)({type:"crt.GenerateSkillCodeValueRequestHandler",requestType:"crt.GenerateSkillCodeValueRequest"}),(0,o.__metadata)("design:paramtypes",[d.Injector])],Gt);class qs extends X.S{constructor(){super(...arguments),this.needRefresh=!1}}let Wt=class extends y.l{constructor(e,t,n){super(),this._copilotChatService=e,this._userInfo=n,this._copilotToChatConvertor=t.get(Q),this._chatDraftService=t.get(Et.X)}_resetPreviewMessageId(e,t){return(0,u.A)(function*(){const s=(yield t.ActiveChats)?.find(i=>i.id===e);s&&(s.previewMessageId="")})()}_getConvertedMessages(e){return e?this._copilotToChatConvertor.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId}):[]}_saveProfile(e,t){return(0,u.A)(function*(){const n={type:"crt.SaveChatProfileRequest",scopes:t,$context:e};yield U.t.instance.process(n)})()}_fetchSessionPreview(e){var t=this;return(0,u.A)(function*(){try{return yield(0,a.lastValueFrom)(t._copilotChatService.getActiveSessionPreviewById(e))}catch{return null}})()}_getSessionTypingState(e,t){return(0,u.A)(function*(){return!!(yield t.ActiveChats)?.find(i=>i.id===e)?.isTyping})()}_createNewSession(e){return(0,u.A)(function*(){const t={type:"crt.CopilotNewChatRequest",scopes:e.scopes,$context:e.$context};yield U.t.instance.process(t)})()}handle(e){var t=this;return(0,u.A)(function*(){yield t.next?.handle(e);const n=e.session.id;if((0,A.isEmpty)(n)){t._createNewSession(e);return}const s=e.session.previewMessageId;if(!((yield e.$context.CurrentCopilotSessionId)!==n||e.needRefresh)&&(yield e.$context.CurrentCopilotSessionTitle)&&(yield e.$context.IsCombinedMode))return;e.$context.ChatsListVisible=!1,e.$context.ChatMessages=[],e.$context.ConversationLoading=!0;const l=(yield e.$context.ChatsSearchFilter)&&s?t._copilotChatService.getCopilotSearchMessagesBatch(n,s):t._copilotChatService.getCopilotSessionMessagesPagination(n,0,15,!0),p=t._getConvertedMessages(yield(0,a.lastValueFrom)(l.pipe((0,a.tap)(()=>{e.$context.ConversationLoading=!1,setTimeout(()=>{e.$context.MessageEditorInputAction=$n.g.Focus},0)}),(0,a.catchError)(()=>(e.$context.ConversationLoading=!1,(0,a.of)([])))))),h=e.session.caption??(yield t._fetchSessionPreview(n))?.caption;if(!p||p.length===0||h===void 0){t._createNewSession(e);return}yield t._resetPreviewMessageId(n,e.$context),e.$context.CurrentCopilotSessionTitle=h,e.$context.IsTyping=yield t._getSessionTypingState(n,e.$context),e.$context.ChatMessages=p,e.$context.PreviewMessageId=s,e.$context.CurrentCopilotSessionId=n,e.$context.ChatInput=t._chatDraftService.getDraft(n),setTimeout(()=>e.$context.MessageEditorInputAction="",0),yield t._saveProfile(e.$context,e.scopes)})()}};Wt=(0,o.__decorate)([(0,C.l)({type:"crt.ChatSessionOpenHandler",requestType:"crt.ChatSessionOpenRequest",scopes:["CopilotPanel"]}),(0,o.__metadata)("design:paramtypes",[F,d.Injector,ee.oq])],Wt);class ei extends null{}let Kt=class extends y.l{_saveProfile(e,t){return(0,u.A)(function*(){const n={type:"crt.SaveChatProfileRequest",scopes:t,$context:e};yield U.t.instance.process(n)})()}handle(e){var t=this;return(0,u.A)(function*(){yield t.next?.handle(e),e.$context.ChatsListVisible=!0,e.$context.ChatInput="",yield t._saveProfile(e.$context,e.scopes)})()}};Kt=(0,o.__decorate)([(0,C.l)({type:"crt.ChatListOpenHandler",requestType:"crt.ChatListOpenRequest",scopes:["CopilotPanel"]})],Kt);var Js=c(95145);class q{constructor(e,t,n){this._sysSettingsService=e,this._notifyService=t,this._translateService=n,this._defaultFileExtensions="txt,docx,pdf",this._defaultMaxFileSize=5,this._maxIntentFileSizeSettingName="CreatioAIMaxIntentFileSize",this._maxSessionFileSizeSettingName="CreatioAIMaxSessionFileSize",this._allowedFileExtensionsSettingName="CreatioAIAllowedFileExtensions",this._intentMaxSizeExceptionKey="IntentMaxSizeException",this._chatMaxSizeExceptionKey="ChatMaxSizeException",this._intentMissingTypeExceptionKey="IntentMissingTypeException",this._chatMissingTypeExceptionKey="ChatMissingTypeException",this._intentNotSupportedTypeExceptionKey="IntentTypeNotSupportedException",this._chatNotSupportedTypeExceptionKey="ChatTypeNotSupportedException"}_validateFile(e,t,n,s){if(e.size/1024/1024>t){const p=s?this._chatMaxSizeExceptionKey:this._intentMaxSizeExceptionKey,h=this._getLocalizedException(p,t.toString(),s?this._maxSessionFileSizeSettingName:this._maxIntentFileSizeSettingName);throw new Error(h)}const l=e.name.includes(".")?e.name.split(".").pop()?.toLowerCase():null;if(!l){const p=this._getLocalizedException(s?this._chatMissingTypeExceptionKey:this._intentMissingTypeExceptionKey,n.join(","));throw new Error(p)}if(!n.includes(l)){const p=this._getLocalizedException(s?this._chatNotSupportedTypeExceptionKey:this._intentNotSupportedTypeExceptionKey,l,n.join(","));throw new Error(p)}}_getAllowedFileExtensionsSetting(){var e=this;return(0,u.A)(function*(){return(yield(0,a.lastValueFrom)(e._sysSettingsService.getByCode(e._allowedFileExtensionsSettingName)))?.value??e._defaultFileExtensions})()}_getAllowedFileExtensions(){var e=this;return(0,u.A)(function*(){return(yield e._getAllowedFileExtensionsSetting()).split(",").map(t=>t.trim())})()}_getMaxSizeSystemSetting(e){var t=this;return(0,u.A)(function*(){return(yield(0,a.lastValueFrom)(t._sysSettingsService.getByCode(e)))?.value??t._defaultMaxFileSize})()}_showErrorDialog(e){var t=this;return(0,u.A)(function*(){const n=e?.message;n&&(yield t._notifyService.show({message:n}))})()}_getLocalizedException(e,...t){const n=`Copilot.FileMessages.${e}`,s=this._translateService.instant(n);return ie.String.format(s,...t)}validateIntentFiles(...e){var t=this;return(0,u.A)(function*(){try{const n=yield t._getMaxSizeSystemSetting(t._maxIntentFileSizeSettingName),s=yield t._getAllowedFileExtensions();return e.forEach(i=>{t._validateFile(i,n,s,!1)}),!0}catch(n){return yield t._showErrorDialog(n),!1}})()}validateSessionFiles(...e){var t=this;return(0,u.A)(function*(){const n=yield t._getMaxSizeSystemSetting(t._maxSessionFileSizeSettingName),s=yield t._getAllowedFileExtensions();e.forEach(i=>{t._validateFile(i,n,s,!0)})})()}static{this.\u0275fac=function(t){return new(t||q)(d.\u0275\u0275inject(Js.A),d.\u0275\u0275inject(tt.F),d.\u0275\u0275inject(f.TranslateService))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:q,factory:q.\u0275fac,providedIn:"root"})}}class ae{_getCurrentUserTime(){const s=(new Date().getTime()*1e4+621355968e9)/1e4;return new Date(s)}addErrorToChatMessages(e,t){const n={text:e,id:(0,S.qv)(),author:pe.contact,date:this._getCurrentUserTime(),isBotMessage:!0,type:Qe.X.Text,direction:he.Tt.Incoming},s=Object.assign([],t);return s.push(n),s}static{this.\u0275fac=function(t){return new(t||ae)}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:ae,factory:ae.\u0275fac,providedIn:"root"})}}let Jt=class extends y.l{constructor(e,t){super(),this._fileValidatorService=e,this._copilotChatMessageService=t}handle(e){var t=this;return(0,u.A)(function*(){if(e.recordId===null){const n=(0,S.qv)();e.$context.CurrentCopilotSessionId=n,e.recordId=n}if(e.files?.length)try{yield t._fileValidatorService.validateSessionFiles(...e.files)}catch(n){const s=yield e.$context.ChatMessages,i=n?.message;s&&i&&(e.$context.ChatMessages=t._copilotChatMessageService.addErrorToChatMessages(i,s));return}return t.next?.handle(e)})()}};Jt=(0,o.__decorate)([(0,C.l)({requestType:"crt.UploadFileRequest",type:"crt.CopilotChatUploadFileHandler",scopes:["CopilotPanel"]}),(0,o.__metadata)("design:paramtypes",[q,ae])],Jt);class ti extends null{}let Qt=class extends y.l{_saveProfile(e,t){return(0,u.A)(function*(){const n={type:"crt.SaveChatProfileRequest",scopes:t,$context:e};yield U.t.instance.process(n)})()}handle(e){var t=this;return(0,u.A)(function*(){yield t.next?.handle(e);const n=yield e.$context.CombinedModeEnabled;e.$context.ChatsListVisible=!n,e.$context.IsCombinedMode=!n,e.$context.CombinedModeEnabled=!(yield e.$context.CombinedModeEnabled),yield t._saveProfile(e.$context,e.scopes)})()}};Qt=(0,o.__decorate)([(0,C.l)({type:"crt.CombinedChatViewHandler",requestType:"crt.CombinedChatViewRequest",scopes:["CopilotPanel"]})],Qt);let Xt=class extends y.l{constructor(e){super(),this._fileValidatorService=e}handle(e){var t=this;return(0,u.A)(function*(){const n=yield t.next?.handle(e);return n.files.length&&!(yield t._fileValidatorService.validateIntentFiles(...n.files))?{files:[],errors:[]}:n})()}};Xt=(0,o.__decorate)([(0,C.l)({requestType:"crt.SelectFileRequest",type:"crt.CopilotIntentUploadFileDialogHandler",scopes:["AISkills_FormPage","AIAgents_FormPage"]}),(0,o.__metadata)("design:paramtypes",[q])],Xt);let Zt=class extends y.l{constructor(e){super(),this._fileValidatorService=e}handle(e){var t=this;return(0,u.A)(function*(){if(!(e.files?.length&&!(yield t._fileValidatorService.validateIntentFiles(...e.files))))return t.next?.handle(e)})()}};Zt=(0,o.__decorate)([(0,C.l)({requestType:"crt.UploadFileRequest",type:"crt.CopilotIntentUploadFileHandler",scopes:["AISkills_FormPage","AIAgents_FormPage"]}),(0,o.__metadata)("design:paramtypes",[q])],Zt);let Yt=class extends y.l{constructor(e,t){super(),this._fileValidatorService=e,this._copilotChatMessageService=t}handle(e){var t=this;return(0,u.A)(function*(){const n=yield t.next?.handle(e);if(n.files.length)try{yield t._fileValidatorService.validateSessionFiles(...n.files)}catch(s){const i=yield e.$context.ChatMessages,l=s?.message;return i&&l&&(e.$context.ChatMessages=t._copilotChatMessageService.addErrorToChatMessages(l,i)),{files:[],errors:[]}}return n})()}};Yt=(0,o.__decorate)([(0,C.l)({requestType:"crt.SelectFileRequest",type:"crt.CopilotChatUploadFileDialogHandler",scopes:["CopilotPanel"]}),(0,o.__metadata)("design:paramtypes",[q,ae])],Yt);class ni extends X.S{constructor(){super(...arguments),this.offset=0,this.rows=15}}let qt=class extends y.l{constructor(e,t,n){super(),this._copilotChatService=e,this._userInfo=n,this._rowsCount=15,this._allDataLoaded=!1,this._chatMessageCount=0,this._copilotToChatConvertor=t.get(Q)}_getConvertedMessages(e){return e?this._copilotToChatConvertor.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId}):[]}_resetState(e,t){(e&&this._id!==e||t!==this._chatMessageCount)&&(this._allDataLoaded=!1)}handle(e){var t=this;return(0,u.A)(function*(){yield t.next?.handle(e);const n=yield e.$context.ChatMessages,s=e.sessionId||(yield e.$context.CurrentCopilotSessionId),i=e.rows||t._rowsCount;t._resetState(s,n?.length),t._id=s,t._chatMessageCount=n?.length||0,!(!s||t._allDataLoaded||n?.length<i)&&(e.$context.ConversationLoading=!0,yield(0,a.lastValueFrom)(t._copilotChatService.getCopilotSessionMessagesPagination(s,e.offset,i).pipe((0,a.map)(l=>{if(l?.length===0){t._allDataLoaded=!0;return}t._allDataLoaded=l.length<i;const p=t._getConvertedMessages(l);if(n&&n.length>0){const h=new Set(n.map(_=>_.id)),g=p.filter(_=>!h.has(_.id));e.$context.ChatMessages=[...g,...n]}else e.$context.ChatMessages=p}),(0,a.tap)(()=>{e.$context.ConversationLoading=!1}),(0,a.catchError)(()=>(e.$context.ConversationLoading=!1,(0,a.of)([]))))))})()}};qt=(0,o.__decorate)([(0,C.l)({type:"crt.ChatSessionPaginationHandler",requestType:"crt.ChatSessionPaginationRequest",scopes:["CopilotPanel"]}),(0,o.__metadata)("design:paramtypes",[F,d.Injector,ee.oq])],qt);var Qs=c(37206);class si extends null{}let en=class extends Qs.w{constructor(e){super(),this._copilotChatService=e}getCurrentChatId(e){return(0,u.A)(function*(){return yield e.$context.CurrentCopilotSessionId})()}getChatPreviews(e,t,n){return this._copilotChatService.getActiveSessionsWithPreview(e,t,n)}mapChatPreview(e){return this._copilotChatService.mapSessions(e)}getChatOpenRequest(e,t){return{type:"crt.ChatSessionOpenRequest",session:t,needRefresh:!0,scopes:e.scopes,$context:e.$context}}};en=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotChatListLoadHandler",requestType:"crt.CopilotChatListLoadRequest",scopes:["CopilotPanel"]}),(0,o.__metadata)("design:paramtypes",[F])],en);class ge{constructor(){this._copilotService=(0,d.inject)(Z)}getContacts(e,t=0,n=15){return(0,a.from)(this._copilotService.getAvailableAgents()).pipe((0,a.map)(s=>s.filter(i=>!e||i.name.toLowerCase().includes(e.toLowerCase())).slice(t,t+n).map(i=>({displayValue:i.name,value:i.id,description:i.description}))))}static{this.\u0275fac=function(t){return new(t||ge)}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:ge,factory:ge.\u0275fac,providedIn:"root"})}}class ii extends null{}let tn=class extends y.l{constructor(e){super(),this._copilotMentionsService=e}handle(e){var t=this;return(0,u.A)(function*(){yield t.next?.handle(e),e.initService(t._copilotMentionsService)})()}};tn=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotMentionInitHandler",requestType:"crt.CopilotMentionInitRequest",scopes:["CopilotPanel"]}),(0,o.__metadata)("design:paramtypes",[ge])],tn);var Xs=c(11395);class ai extends null{}let nn=class extends y.l{constructor(e,t,n,s){super(),this._dialogService=e,this._copilotChatService=t,this._liveAnnouncementService=n,this._translationService=s}_updateSessionInContext(e,t){var n=this;return(0,a.from)(Promise.all([e.$context.ActiveChats,e.$context.CurrentCopilotSessionTitle])).pipe((0,a.tap)(function(){var s=(0,u.A)(function*([i]){const l=i?.findIndex(h=>h.id===e.chatId);if(l>=0){const h=i[l];h.caption=t,i[l]=h,e.$context.ActiveChats=[...i]}if((yield e.$context.CurrentCopilotSessionId)===e.chatId){e.$context.CurrentCopilotSessionTitle=t;const h=n._translationService.instant("Copilot.LiveAnnouncement.ChatRenamed"),g=ie.String.format(h,t);yield n._liveAnnouncementService.announce(g)}});return function(i){return s.apply(this,arguments)}}()),(0,a.map)(()=>{}))}_updateSessionInStorage(e,t){return this._copilotChatService.renameSession(e,t).pipe((0,a.filter)(n=>n.success),(0,a.map)(()=>t))}handle(e){var t=this;return(0,u.A)(function*(){yield t.next?.handle(e);const n=yield e.$context.ActiveChats,s=n?.findIndex(i=>i.id===e.chatId);if(s>=0){const i=n[s];yield(0,a.firstValueFrom)(t._dialogService.open(Xs.P,{panelClass:["rename-chat-dialog-window"],data:{chatTitle:i.caption}}).pipe((0,a.filter)(l=>!!l),(0,a.switchMap)(l=>t._updateSessionInStorage(e.chatId,l)),(0,a.switchMap)(l=>t._updateSessionInContext(e,l)),(0,a.defaultIfEmpty)(void 0),(0,a.finalize)(()=>{e.callback&&typeof e.callback=="function"&&e.callback(i.id)})))}})()}};nn=(0,o.__decorate)([(0,C.l)({type:"crt.CopilotRenameSessionHandler",requestType:"crt.CopilotRenameSessionRequest",scopes:["CopilotPanel"]}),(0,o.__metadata)("design:paramtypes",[ct.o,F,j.DW,f.TranslateService])],nn);let je=class an{constructor(e){e.register(yn,Ae)}static{this.\u0275fac=function(t){return new(t||an)(d.\u0275\u0275inject(hn.s))}}static{this.\u0275mod=d.\u0275\u0275defineNgModule({type:an})}static{this.\u0275inj=d.\u0275\u0275defineInjector({providers:[v.F,Q,M.d],imports:[ue,Ie,f.TranslateModule]})}};je=(0,o.__decorate)([(0,R.g)({viewElements:[],requestHandlers:[et,en,nt,tn,st,it,at,ot,lt,pt,gt,mt,_t,Ct,ft,vt,St,yt,It,Mt,At,xt,Pt,bt,Tt,Rt,Nt,wt,Lt,Vt,$t,Ft,Ut,Ot,Ht,Bt,zt,Gt,Wt,Kt,Jt,Qt,Xt,Zt,Yt,nn,qt],converters:[Xe,Ze,Ye,qe]}),(0,o.__metadata)("design:paramtypes",[hn.s])],je),function(){(typeof ngJitMode>"u"||ngJitMode)&&d.\u0275\u0275setNgModuleScope(je,{imports:[ue,Ie,f.TranslateModule]})}()},11395:($,E,c)=>{c.d(E,{P:()=>I});var o=c(59131),M=c.n(o),R=c(56711),f=c.n(R),v=c(76923),T=c.n(v),d=c(59969),D=c(97998),b=c(18046),N=c(19344),A=c(62115),a=c(12325),m=c(79772),x=c.n(m);class I{constructor(S,O,H,W,ke){this._dialogRef=S,this._dialogData=O,this._domPurifier=H,this._crtControlStateAdapter=W,this._injector=ke,this.chatTitleInputControl=new R.FormControl("",{validators:[this._crtControlStateAdapter.transform({instance:new D.Y(this._injector)})]})}get chatTitle(){return this._dialogData.chatTitle}onCloseButtonClicked(){this._dialogRef.close()}onSaveButtonClicked(){const S=this._domPurifier.sanitize(this.chatTitleInputControl.value)||"";S.trim()!==""&&this._dialogRef.close(S)}static{this.\u0275fac=function(O){return new(O||I)(o.\u0275\u0275directiveInject(v.MatLegacyDialogRef),o.\u0275\u0275directiveInject(v.MAT_LEGACY_DIALOG_DATA),o.\u0275\u0275directiveInject(d.MV),o.\u0275\u0275directiveInject(b.f),o.\u0275\u0275directiveInject(o.Injector))}}static{this.\u0275cmp=o.\u0275\u0275defineComponent({type:I,selectors:[["crt-rename-chat"]],decls:11,vars:19,consts:[[1,"rename-dialog-container"],["labelType","headline-3","labelColor","var(--crt-palette-secondary-500)",1,"dialog-title",3,"title","caption"],[1,"dialog-input",3,"keyup.enter","control","value","label","labelPosition"],[1,"dialog-actions"],["data-item-marker","closeButton",1,"cancel-button",3,"clicked","caption"],["color","primary","data-item-marker","saveButton",1,"save-button",3,"clicked","disabled","caption"]],template:function(O,H){O&1&&(o.\u0275\u0275elementStart(0,"div",0),o.\u0275\u0275element(1,"crt-label",1),o.\u0275\u0275pipe(2,"translate"),o.\u0275\u0275pipe(3,"translate"),o.\u0275\u0275elementStart(4,"crt-input",2),o.\u0275\u0275pipe(5,"translate"),o.\u0275\u0275listener("keyup.enter",function(){return H.onSaveButtonClicked()}),o.\u0275\u0275elementEnd(),o.\u0275\u0275elementStart(6,"div",3)(7,"crt-button",4),o.\u0275\u0275pipe(8,"translate"),o.\u0275\u0275listener("clicked",function(){return H.onCloseButtonClicked()}),o.\u0275\u0275elementEnd(),o.\u0275\u0275elementStart(9,"crt-button",5),o.\u0275\u0275pipe(10,"translate"),o.\u0275\u0275listener("clicked",function(){return H.onSaveButtonClicked()}),o.\u0275\u0275elementEnd()()()),O&2&&(o.\u0275\u0275advance(),o.\u0275\u0275property("title",o.\u0275\u0275pipeBind1(2,9,"ChatList.RenameChat.LabelTitle"))("caption",o.\u0275\u0275pipeBind1(3,11,"ChatList.RenameChat.LabelTitle")),o.\u0275\u0275advance(3),o.\u0275\u0275property("control",H.chatTitleInputControl)("value",H.chatTitle)("label",o.\u0275\u0275pipeBind1(5,13,"ChatList.RenameChat.InputTitle"))("labelPosition","above"),o.\u0275\u0275advance(3),o.\u0275\u0275property("caption",o.\u0275\u0275pipeBind1(8,15,"ChatList.RenameChat.CancelButton")),o.\u0275\u0275advance(2),o.\u0275\u0275property("disabled",!H.chatTitleInputControl.valid)("caption",o.\u0275\u0275pipeBind1(10,17,"ChatList.RenameChat.SaveButton")))},dependencies:[N.j,A.B,a.V,m.TranslatePipe],styles:[".rename-dialog-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:16px}.dialog-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:8px}"]})}}},96158:($,E,c)=>{c.d(E,{g:()=>o});var o;(function(M){M.TriggerMention="triggerMention",M.Focus="focus"})(o||(o={}))},37206:($,E,c)=>{c.d(E,{D:()=>b,w:()=>N});var o=c(73308),M=c(81517),R=c(41287),f=c(91775),v=c(62278),T=c.n(v);const d="ChatsListLoadSubject",D="ChatsListLoadSubscription";class b extends M.S{constructor(){super(...arguments),this.searchFilter=null,this.isFirstLoad=!1}}class N extends R.l{_getChatsListLoadSubject(a){return(0,o.A)(function*(){let m=yield a.$context[d];return m||(m=new v.Subject,a.$context[d]=m),m})()}_resetChatsLoadOffsetSubscription(a){var m=this;(0,o.A)(function*(){const x=yield a.$context[D];x&&x.unsubscribe();const I=yield m._getChatsListLoadSubject(a);m._handleChatsListOffsetChange(a,I)})()}_handleChatsListOffsetChange(a,m){var x=this;a.$context[D]=m.pipe((0,v.debounceTime)(500),(0,v.tap)(()=>a.$context.IsActiveChatsLoading=!1),(0,v.distinctUntilChanged)((I,P)=>I.offset===P.offset&&I.searchFilter===P.searchFilter),(0,v.tap)(()=>a.$context.IsActiveChatsLoading=!0),(0,v.switchMap)(I=>this.getChatPreviews(I.offset,I.rowsToLoad,I.searchFilter).pipe((0,v.filter)(P=>I.offset===0||P&&P.length>0),(0,v.map)(P=>P.map(S=>this.mapChatPreview(S))),(0,v.switchMap)(P=>(0,v.from)(a.$context.ActiveChats).pipe((0,v.take)(1),(0,v.map)(S=>!S||S.length===0||I.currentPage===0?P:[...S,...P]))),(0,v.map)(P=>({page:I.currentPage,mappedSessions:P,search:I.searchFilter})),(0,v.finalize)(()=>{a.$context.IsActiveChatsLoading=!1})))).subscribe({next:I=>{a.$context.ActiveChats=Array.from(new Map(I.mappedSessions.map(P=>[P.id,P])).values()),a.$context.ChatsListPage=I.page+1,I.search&&(0,o.A)(function*(){return yield x._reloadCurrentChatIfNeeded(a)})()},error:I=>{console.error("Failed to load chat previews:",I),this._resetChatsLoadOffsetSubscription(a)}})}_reloadCurrentChatIfNeeded(a){var m=this;return(0,o.A)(function*(){const x=yield m.getCurrentChatId(a),I=yield a.$context.IsCombinedMode,P=(yield a.$context.ActiveChats).find(S=>S.id===x);if(P&&I){const S=m.getChatOpenRequest(a,P);yield f.t.instance.process(S)}})()}handle(a){var m=this;return(0,o.A)(function*(){yield m.next?.handle(a);const x=yield m._getChatsListLoadSubject(a);a.isFirstLoad&&(m._handleChatsListOffsetChange(a,x),a.$context.ChatsListPage=0);const I=yield a.$context.ChatsListPage,P=I*a.rowsToLoadCount;x.next({offset:P,rowsToLoad:a.rowsToLoadCount,currentPage:I,searchFilter:a.searchFilter})})()}}},13161:($,E,c)=>{c.d(E,{j:()=>o});const o="ChatPanel"},43778:($,E,c)=>{c.d(E,{R:()=>M,u:()=>o});class o{}const M="reset"},13555:($,E,c)=>{c.d(E,{X:()=>d});var o=c(62278),M=c.n(o),R=c(36486),f=c.n(R),v=c(59131),T=c.n(v);class d{constructor(){this._saveMessageDebounceTimeout=500,this._storageKeyPrefix="chat-draft",this._draftUpdatesMap=new Map}_getOrCreateSubject(b){if(!this._draftUpdatesMap.has(b)){const N=new o.Subject;N.pipe((0,R.debounceTime)(this._saveMessageDebounceTimeout)).subscribe(A=>{const a=this._getStorageKey(b);A===null?sessionStorage.removeItem(a):sessionStorage.setItem(a,A)}),this._draftUpdatesMap.set(b,N)}return this._draftUpdatesMap.get(b)}_getStorageKey(b){return`${this._storageKeyPrefix}-${b||"new"}`}setDraft(b,N){this._getOrCreateSubject(b).next(N)}getDraft(b){const N=this._getStorageKey(b);return sessionStorage.getItem(N)||""}clearDraft(b){this._getOrCreateSubject(b).next(null)}ngOnDestroy(){this._draftUpdatesMap.forEach(b=>{b.complete()}),this._draftUpdatesMap.clear()}static{this.\u0275fac=function(N){return new(N||d)}}static{this.\u0275prov=v.\u0275\u0275defineInjectable({token:d,factory:d.\u0275fac,providedIn:"root"})}}},92385:($,E,c)=>{c.d(E,{$:()=>A});var o=c(79772),M=c.n(o),R=c(34268),f=c.n(R),v=c(89986),T=c(59131),d=c.n(T),D=c(13555);const b=["span"],N=["class","data-mention"];class A{constructor(m,x){this._translateService=m,this._chatDraftService=x,this._domPurifier=f()(window),this._domPurifier.addHook("uponSanitizeElement",v.F.func)}_replaceMentions(m){if(!m.includes('class="mention"')&&!m.includes("class='mention'"))return m;const x=document.createElement("div");return x.innerHTML=m,x.querySelectorAll(".mention").forEach(I=>{const S=I.textContent||""||" ";I.replaceWith(document.createTextNode(S))}),x.innerHTML}_stripMarkdown(m){return m.replace(/\[([^\]]+)\]\([^)]+\)/g,"$1").replace(/\*\*(.*?)\*\*/g,"$1").replace(/\*(.*?)\*/g,"$1").replace(/__(.*?)__/g,"$1").replace(/_(.*?)_/g,"$1").replace(/`([^`]+?)`/g,"$1").replace(/^>+\s?/gm,"").replace(/^#{1,6}\s?/gm,"").replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&amp;/g,"&").replace(/\\n/g,`
`).replace(/\n{2,}/g,`

`).trim()}sanitizeContent(m){const x={ALLOWED_TAGS:b,ALLOWED_ATTR:N};return this._domPurifier.sanitize(m,x)}getPreview(m,x,I){if(!I)return this._translateService.instant("ChatList.YourPreview")+this.toPlainText(x);const P=this.sanitizeContent(this._chatDraftService.getDraft(m));return P&&P.length>0?this._translateService.instant("ChatList.DraftPreview")+this.toPlainText(P):this.toPlainText(x)}toPlainText(m){if(!m)return"";const x=this._replaceMentions(m);return this._stripMarkdown(x)}static{this.\u0275fac=function(x){return new(x||A)(T.\u0275\u0275inject(o.TranslateService),T.\u0275\u0275inject(D.X))}}static{this.\u0275prov=T.\u0275\u0275defineInjectable({token:A,factory:A.\u0275fac,providedIn:"root"})}}},89986:($,E,c)=>{c.d(E,{F:()=>o});const o={name:"uponSanitizeElement",func:(M,R)=>{if(R.tagName==="span"){const f=M.getAttribute("class"),v=M.getAttribute("data-mention");if(!(f==="mention"&&v)){const d=document.createTextNode(M.textContent||"");M.parentNode?.replaceChild(d,M)}}}}},20555:($,E,c)=>{c.d(E,{b:()=>M,k:()=>o});const o="OpenChatSessionEvent",M="Copilot"},85040:($,E,c)=>{c.d(E,{u:()=>o});var o;(function(M){M.SetHighlighting="setHighlighting",M.RemoveHighlighting="removeHighlighting"})(o||(o={}))},48534:($,E,c)=>{c.d(E,{i:()=>T});var o=c(62278),M=c.n(o),R=c(85040),f=c(59131),v=c.n(f);class T{constructor(){this._currentSubscriptionIdentifier=null,this._currentSubscription=null,this._replaceSelectionSubject=new o.Subject}_unsubscribeLastEditor(){if(this._currentSubscription){const D={editorAction:R.u.RemoveHighlighting};this._replaceSelectionSubject?.next(D),this._currentSubscriptionIdentifier=null,this._currentSubscription.unsubscribe()}}subscribeToNotifications(D,b){this._currentSubscriptionIdentifier!==D&&(this._unsubscribeLastEditor(),this._currentSubscriptionIdentifier=D,this._currentSubscription=this._replaceSelectionSubject.subscribe(b))}notify(D){this._replaceSelectionSubject?.next(D)}static{this.\u0275fac=function(b){return new(b||T)}}static{this.\u0275prov=f.\u0275\u0275defineInjectable({token:T,factory:T.\u0275fac,providedIn:"root"})}}},63740:($,E,c)=>{c.d(E,{p:()=>M});var o=c(6530);class M{constructor(f){f&&(this.uId=f.uId,this.name=f.name,this.parentSchemaUId=f.parentSchemaUId),this.uId=this.uId||(0,o.qv)()}update(f){this.uId=f.uId,this.name=f.name}equal(f){if(f==null)return!1;let v=this.uId===f.uId&&this.name===f.name;return(this.parentSchemaUId||f.parentSchemaUId)&&(v=v&&this.parentSchemaUId===f.parentSchemaUId),v}clone(){return new M(this)}getLocalizableValues(f){}loadLocalizableValues(f,v=!1){}}},37827:($,E,c)=>{c.d(E,{e:()=>R});var o=c(50588),M=c(63740);class R extends M.p{constructor(v){super(v),this.values=new o.h(v?.values)}clone(){return new R(this)}getLocalizableValues(v){super.getLocalizableValues(v),v.values=this.values.clone()}loadLocalizableValues(v,T=!1){super.loadLocalizableValues(v,T),this.values.setValues(v.values,T)}}}}]);
